<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Brendimo VIP | Ultimate Gift App</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. CORE THEME & VARIABLES --- */
        :root {
            --bg-deep: #050505;
            --glass-card: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            
            --gold-primary: #D4AF37;
            --gold-light: #F3E5AB;
            --gold-dark: #AA8A28;
            --gold-gradient: linear-gradient(135deg, #BF953F, #FCF6BA 45%, #B38728 65%, #FBF5B7 100%);
            
            --danger: #FF453A;
            --success: #32D74B;
            --font-display: 'Space Grotesk', sans-serif;
            --font-body: 'Inter', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-deep);
            color: #fff;
            font-family: var(--font-body);
            padding-bottom: 95px; /* Space for nav */
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Ambient Background */
        body::before {
            content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(212,175,55,0.03) 0%, transparent 60%);
            z-index: -1; pointer-events: none; animation: pulse 10s infinite;
        }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        .shake-anim { animation: shake 0.3s ease-in-out; border-color: var(--danger) !important; }

        h1, h2, h3, .font-display { font-family: var(--font-display); margin: 0; letter-spacing: -0.5px; }

        .gold-text { 
            background: var(--gold-gradient); -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; font-weight: 700; text-shadow: 0 2px 10px rgba(212,175,55,0.1);
        }

        .container { max-width: 480px; margin: 0 auto; padding: 20px; position: relative; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease forwards; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- UI COMPONENTS --- */
        
        /* Premium Glass Panel */
        .glass-panel {
            background: var(--glass-card);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-top: 1px solid var(--glass-highlight);
            border-radius: 24px; padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            transition: transform 0.2s;
        }
        .glass-panel:active { transform: scale(0.99); }

        /* Gold Button */
        .btn-primary {
            width: 100%; padding: 16px;
            background: var(--gold-gradient);
            border: none; border-radius: 16px;
            font-family: var(--font-display); font-weight: 700; font-size: 16px; color: #1a1a1a;
            cursor: pointer; position: relative; overflow: hidden;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
            transition: 0.2s;
        }
        .btn-primary:active { transform: scale(0.95); opacity: 0.9; }
        
        .btn-sm { padding: 8px 16px; font-size: 13px; width: auto; }
        .btn-disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }

        /* Inputs */
        .input-field {
            width: 100%; padding: 16px;
            background: rgba(0,0,0,0.3); border: 1px solid #333;
            color: white; border-radius: 14px; margin-bottom: 12px;
            font-size: 16px; text-align: center; font-family: var(--font-body);
        }
        .input-field:focus { border-color: var(--gold-primary); }

        /* Wallet Header */
        .wallet-pill {
            background: rgba(20,20,20,0.8); padding: 8px 16px 8px 12px;
            border-radius: 30px; border: 1px solid #333;
            display: flex; align-items: center; gap: 10px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
            transition: transform 0.2s;
        }
        .coin-icon { 
            width: 24px; height: 24px; background: var(--gold-gradient); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 14px; color: #000; font-weight: bold; box-shadow: 0 0 10px var(--gold-dark);
        }

        /* Game Grid */
        .game-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        .game-tile {
            background: linear-gradient(160deg, rgba(40,40,40,0.6) 0%, rgba(10,10,10,0.8) 100%);
            border: 1px solid var(--glass-border);
            border-radius: 20px; padding: 16px;
            text-align: center; cursor: pointer; position: relative; overflow: hidden;
        }
        .game-tile::after {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.03), transparent);
            transform: translateX(-100%); transition: 0.5s;
        }
        .game-tile:hover::after { transform: translateX(100%); }
        .game-tile:active { transform: scale(0.96); border-color: var(--gold-primary); }
        
        .tag-badge {
            font-size: 10px; padding: 4px 8px; border-radius: 6px;
            display: inline-block; margin-top: 6px; font-weight: 600; letter-spacing: 0.5px;
        }
        .tag-risk { background: rgba(255, 69, 58, 0.15); color: var(--danger); border: 1px solid rgba(255, 69, 58, 0.3); }
        .tag-safe { background: rgba(50, 215, 75, 0.15); color: var(--success); border: 1px solid rgba(50, 215, 75, 0.3); }

        /* Navigation */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 440px;
            background: rgba(18, 18, 18, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px; height: 70px;
            display: flex; justify-content: space-evenly; align-items: center;
            z-index: 100; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .nav-item { 
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            opacity: 0.4; transition: 0.3s; transform: scale(0.9); cursor: pointer; padding: 10px;
        }
        .nav-item.active { opacity: 1; transform: scale(1); color: var(--gold-light); }
        .nav-item svg { width: 22px; height: 22px; fill: currentColor; }
        .nav-label { font-size: 10px; font-weight: 500; }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(5px);
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content {
            width: 90%; max-width: 360px;
            background: #111; border: 1px solid #333;
            border-radius: 28px; padding: 30px; text-align: center;
            position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            transform: scale(0.9); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-close {
            position: absolute; right: 20px; top: 20px; width: 30px; height: 30px;
            background: #222; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: #fff; font-family: monospace;
        }

        /* --- GAME ASSETS --- */
        /* Wheel */
        .wheel-container { position: relative; width: 260px; height: 260px; margin: 20px auto; }
        .wheel-el {
            width: 100%; height: 100%; border-radius: 50%;
            border: 4px solid var(--gold-primary);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
            /* Conic gradient generated dynamically via JS */
        }
        .wheel-pointer {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            z-index: 2; width: 30px; height: 40px; 
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5));
        }

        /* Cards */
        .card-scene { perspective: 600px; display: flex; gap: 10px; justify-content: center; margin: 20px 0; }
        .card-wrap { width: 80px; height: 110px; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; }
        .card-wrap.flipped { transform: rotateY(180deg); }
        .card-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            font-size: 24px; border: 2px solid #333;
        }
        .card-front { background: linear-gradient(135deg, #222, #111); color: var(--gold-primary); }
        .card-back { background: #fff; transform: rotateY(180deg); color: #000; border-color: var(--gold-primary); }

        /* Shop Items */
        .shop-item {
            display: flex; align-items: center; gap: 15px;
            padding: 12px; background: rgba(255,255,255,0.03);
            border-radius: 16px; margin-bottom: 12px;
            border: 1px solid transparent; transition: 0.2s;
        }
        .shop-item:hover { border-color: rgba(255,255,255,0.1); background: rgba(255,255,255,0.06); }
        
        .inv-item {
            padding: 15px; background: rgba(212, 175, 55, 0.1); 
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;
        }

    </style>
</head>
<body>

    <div id="auth-screen" class="modal-overlay active" style="background:#000; z-index:3000;">
        <div class="container" style="text-align: center; padding-top: 80px;">
            <div style="font-size: 60px; margin-bottom: 20px; animation: float 3s infinite ease-in-out;">üé©</div>
            <h1 class="gold-text" style="font-size: 36px; margin-bottom: 10px;">Brendimo VIP</h1>
            <p style="color:#888; font-size: 14px; margin-bottom: 40px; line-height: 1.6;">
                Ekskl√ºziv h…ôdiyy…ô d√ºnyasƒ±na xo≈ü g…ôlmisiniz.<br>Qeydiyyatdan ke√ß v…ô 100 Coin bonus qazan.
            </p>
            
            <div class="glass-panel" style="max-width: 320px; margin: 0 auto; border-color: var(--gold-dark);">
                <input type="text" id="reg-name" class="input-field" placeholder="Ad v…ô Soyad" autocomplete="off">
                <input type="tel" id="reg-phone" class="input-field" placeholder="WhatsApp N√∂mr…ôsi" autocomplete="off">
                <button onclick="App.auth()" class="btn-primary" style="margin-top: 10px;">FESTƒ∞VALA BA≈ûLA</button>
            </div>
            <p style="font-size: 11px; color: #444; margin-top: 40px; letter-spacing: 1px;">POWERED BY BRENDIMO</p>
        </div>
    </div>

    <div id="app-container" class="container hidden fade-in">
        
        <div class="flex-between" style="margin-bottom: 24px;">
            <div>
                <div style="font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 1px;">Xo≈ü G√∂rd√ºk</div>
                <div class="font-display gold-text" style="font-size: 22px;" id="u-name">User</div>
            </div>
            <div class="wallet-pill" id="wallet-pill" onclick="UI.showHistory()">
                <div class="coin-icon">B</div>
                <span style="font-weight: 700; font-family: var(--font-display); font-size: 18px;" id="u-coins">0</span>
            </div>
        </div>

        <div id="view-home" class="view-section">
            <div class="glass-panel" style="background: linear-gradient(135deg, #1a1a1a 0%, #000 100%); position:relative; overflow:hidden;">
                <div style="position:relative; z-index:2;">
                    <h3 style="color:white; margin-bottom:5px;">H…ôdiyy…ô Sehrbazƒ±</h3>
                    <p style="font-size:12px; color:#aaa; margin-bottom:15px; max-width: 70%;">Coin topla, real h…ôdiyy…ôl…ôr qazan.</p>
                    <button class="btn-primary btn-sm" onclick="App.nav('earn')">Coin Qazan &rarr;</button>
                </div>
                <div style="position:absolute; right:-20px; bottom:-20px; font-size:80px; opacity:0.2;">üéÅ</div>
            </div>

            <h3 style="margin: 25px 0 15px 0; font-size: 18px;">Oyna v…ô Qazan</h3>
            <div class="game-grid">
                
                <div class="game-tile" onclick="Games.Wheel.init()">
                    <div style="font-size: 32px; margin-bottom: 8px;">üé°</div>
                    <div style="font-weight: 600;">Lucky Wheel</div>
                    <div class="tag-badge tag-safe">SAFE</div>
                    <div style="font-size: 10px; color: #666; margin-top: 4px;">Cost: 50 | Max: 200</div>
                </div>

                <div class="game-tile" onclick="Games.Scratch.init()">
                    <div style="font-size: 32px; margin-bottom: 8px;">üé´</div>
                    <div style="font-weight: 600;">Poz-Qazan</div>
                    <div class="tag-badge tag-safe">INSTANT</div>
                    <div style="font-size: 10px; color: #666; margin-top: 4px;">Cost: 30 | Max: 100</div>
                </div>

                <div class="game-tile" style="grid-column: span 2; background: linear-gradient(90deg, #1a1a1a, #0d0d0d);" onclick="Games.Cards.init()">
                    <div class="flex-between">
                        <div style="text-align: left;">
                            <div style="font-size: 28px;">üÉè</div>
                            <div style="font-weight: 600; margin-top: 5px;">Mystery Cards</div>
                            <div style="font-size: 11px; color: #888;">Bombanƒ± tapma!</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="tag-badge tag-risk" style="font-size: 12px;">HIGH RISK</div>
                            <div style="color: var(--gold-primary); font-size: 10px; margin-top: 4px;">Jackpot: 300 Coin</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div id="view-earn" class="view-section hidden">
            <h2 class="gold-text" style="margin-bottom: 20px;">Missiyalar</h2>
            
            <div class="glass-panel" id="daily-task-card">
                <div class="flex-between">
                    <div>
                        <div style="font-weight: 600;">G√ºnl√ºk Bonus</div>
                        <div style="font-size: 11px; color: #888;">H…ôr 24 saatdan bir</div>
                    </div>
                    <button class="btn-primary btn-sm" id="btn-claim-daily" onclick="Tasks.claimDaily()">+50 Coin</button>
                </div>
            </div>

            <div class="glass-panel">
    <div style="font-size:12px; color:#666; margin-bottom:10px; text-transform:uppercase;">Social Tasks</div>
    
    <div id="mission-list"></div>
</div>
               
        </div>

        <div id="view-shop" class="view-section hidden">
            <h2 class="gold-text" style="margin-bottom: 10px;">H…ôdiyy…ô Vitrini</h2>
            <p style="font-size:12px; color:#888; margin-bottom:20px;">Coinl…ôrini endirim kuponlarƒ±na v…ô ya h…ôdiyy…ôl…ôr…ô d…ôyi≈ü.</p>
            <div id="shop-list"></div>
        </div>

        <div id="view-profile" class="view-section hidden">
            <h2 class="gold-text" style="margin-bottom: 20px;">Profilim</h2>
            
            <h3 style="font-size:14px; margin-bottom:10px; color:#888;">Aldƒ±ƒüƒ±m H…ôdiyy…ôl…ôr</h3>
            <div class="glass-panel">
                <div id="inventory-list" style="font-size: 12px; min-height: 50px;"></div>
            </div>

            <h3 style="font-size:14px; margin-bottom:10px; color:#888; margin-top:20px;">Tarix√ß…ô</h3>
            <div class="glass-panel">
                <div id="history-list" style="font-size: 12px;"></div>
            </div>
            
            <button class="btn-primary" style="background: #333; color: #fff; margin-top:20px;" onclick="if(confirm('√áƒ±xmaq ist…ôdiyiniz…ô …ôminsiniz?')) { localStorage.clear(); location.reload(); }">√áƒ±xƒ±≈ü Et</button>
        </div>

    </div>

    <div class="bottom-nav" id="main-nav">
        <div class="nav-item active" data-target="home" onclick="App.nav('home')">
            <svg viewBox="0 0 24 24"><path d="M12 5.69l5 4.5V18h-2v-6H9v6H7v-7.81l5-4.5M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z"/></svg>
            <span class="nav-label">Oyun</span>
        </div>
        <div class="nav-item" data-target="earn" id="nav-earn" onclick="App.nav('earn')">
            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39h-2.05c-.15-.83-.77-1.42-2.26-1.42-1.41 0-2.37.72-2.37 1.55 0 .69.48 1.43 2.5 1.86 2.46.52 4.35 1.6 4.35 3.8 0 1.6-1.15 2.79-2.99 3.19z"/></svg>
            <span class="nav-label">Qazan</span>
        </div>
        <div class="nav-item" data-target="shop" onclick="App.nav('shop')">
            <svg viewBox="0 0 24 24"><path d="M20 4H4v2h16V4zm1 10v-2l-1-5H4l-1 5v2h1v6h10v-6h4v6h2v-6h1zm-9 4H6v-4h6v4z"/></svg>
            <span class="nav-label">Market</span>
        </div>
        <div class="nav-item" data-target="profile" onclick="App.nav('profile')">
            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            <span class="nav-label">Profil</span>
        </div>
    </div>

    <div id="game-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-close" onclick="UI.closeModal()">‚úï</div>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        // --- 1. STORE & STATE MANAGEMENT ---
   const Store = {
    key: 'brendimo_vip_data_v1', // define key
    apiUrl: 'https://script.google.com/macros/s/AKfycbzwraCrEnx0_F_AcC8MTrWFOaxy-O4aWAvoWpL1O4G8SUatt2YbiV3LkvgedRaQ6Ohk/exec', 
    
    // Define the default state here
 data: {
    name: 'User',
    phone: '',
    coins: 0,
    lastDaily: 0,
    inventory: [],
    history: [],
    completedTasks: [] // <--- ADD THIS LINE
},

    init() {
        try {
            const saved = localStorage.getItem(this.key);
            if (saved) {
                const parsed = JSON.parse(saved);
                this.data = { ...this.data, ...parsed };
            }
        } catch(e) { console.error("Storage Error", e); }
        return !!this.data.phone;
    },

    // This is the ONLY save function you need (combines Local + Cloud)
    save() {
        // 1. Save locally
        try {
            localStorage.setItem(this.key, JSON.stringify(this.data));
            if(typeof UI !== 'undefined') UI.updateWalletDisplay();
        } catch(e) { console.error("Local Save Error", e); }
// Cloud Save
    if(this.data.phone && this.data.phone.length > 3 && this.apiUrl) {
        fetch(this.apiUrl, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({
                action: 'sync',
                phone: this.data.phone,
                name: this.data.name,  // Added Name so it updates in sheet
                coins: this.data.coins,
                inventory: this.data.inventory,
                history: this.data.history,
                completedTasks: this.data.completedTasks // <--- ADD THIS LINE
            })
        }).catch(err => console.log('Sync error:', err));
    }
},

    addCoins(amount, source) {
        this.data.coins += amount;
        this.logTransaction(amount > 0 ? '+' : '', amount, source);
        this.save();
        if(amount > 0 && typeof UI !== 'undefined') {
            UI.confetti();
            UI.vibrate(100);
        }
    },

    deduct(amount, reason) {
        if (this.data.coins < amount) {
            if(typeof UI !== 'undefined') {
                UI.shakeWallet();
                UI.vibrate([50, 50, 50]);
            }
            return false;
        }
        this.data.coins -= amount;
        this.logTransaction('-', amount, reason);
        this.save();
        return true;
    },

    addItem(item) {
        this.data.inventory.unshift({ ...item, date: new Date().toLocaleDateString() });
        this.save();
    },

    logTransaction(sign, amount, desc) {
        this.data.history.unshift({ 
            date: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), 
            amount: `${sign}${amount}`, 
            desc 
        });
        if(this.data.history.length > 30) this.data.history.pop();
    }
};

        // --- 2. APP LOGIC ---
        const App = {
            init() {
                if (Store.init()) {
                    this.showApp();
                }
                this.renderShop();
                Tasks.checkDaily();
            },

            auth() {
                const nameInp = document.getElementById('reg-name');
                const phoneInp = document.getElementById('reg-phone');
                const name = nameInp.value.trim();
                const phone = phoneInp.value.trim();
                
                if (name.length < 3 || phone.length < 5) {
                    nameInp.style.borderColor = 'var(--danger)';
                    return;
                }
                
                Store.data.name = name;
                Store.data.phone = phone;
                Store.addCoins(100, "Bonus: Qeydiyyat");
                this.showApp();
            },

            showApp() {
                document.getElementById('auth-screen').classList.remove('active');
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('u-name').innerText = Store.data.name;
                UI.updateWalletDisplay();
            },

            nav(view) {
                // Update Tab Bar
                document.querySelectorAll('.nav-item').forEach(n => {
                    n.classList.toggle('active', n.dataset.target === view);
                });
                
                // Update View
                document.querySelectorAll('.view-section').forEach(v => v.classList.add('hidden'));
                document.getElementById(`view-${view}`).classList.remove('hidden');
                
                // Triggers
                if(view === 'profile') UI.renderProfile();
                if(view === 'earn') Tasks.checkDaily();
                UI.vibrate(30);
            },

            renderShop() {
                const products = [
                    { id: 1, name: "10% Endirim Kuponu", price: 200, icon: "üè∑Ô∏è" },
                    { id: 2, name: "K…ôm…ôr D…ôsti (Lotereya)", price: 500, icon: "üëî" },
                    { id: 3, name: "Brendimo VIP Status", price: 1000, icon: "üëë" },
                    { id: 4, name: "S√ºrpriz H…ôdiyy…ô Qutusu", price: 350, icon: "üéÅ" }
                ];
                
                const html = products.map(p => `
                    <div class="shop-item">
                        <div style="font-size:30px; width:60px; height:60px; background:#222; border-radius:12px; display:flex; align-items:center; justify-content:center;">${p.icon}</div>
                        <div style="flex:1;">
                            <div style="font-weight:600;">${p.name}</div>
                            <div style="font-size:12px; color:var(--gold-primary);">${p.price} Coin</div>
                        </div>
                        <button class="btn-primary btn-sm" style="width:auto;" onclick="App.buyItem(${p.id}, '${p.name}', ${p.price})">AL</button>
                    </div>
                `).join('');
                document.getElementById('shop-list').innerHTML = html;
            },

            buyItem(id, name, price) {
                if(confirm(`${name} almaq ist…ôyirs…ôn? (${price} Coin)`)) {
                    if(Store.deduct(price, 'Market: ' + name)) {
                        Store.addItem({ id, name, price });
                        alert("üéâ Uƒüurla alƒ±ndƒ±! Profilinizd…ô 'Aldƒ±ƒüƒ±m H…ôdiyy…ôl…ôr' b√∂lm…ôsin…ô baxƒ±n.");
                        UI.vibrate([100, 50, 100]);
                    }
                }
            }
        };

        // --- 3. UI HANDLERS ---
        const UI = {
            updateWalletDisplay() {
                const el = document.getElementById('u-coins');
                const target = Store.data.coins;
                // Simple animation
                el.innerText = target;
            },

            shakeWallet() {
                const w = document.getElementById('wallet-pill');
                w.classList.remove('shake-anim');
                void w.offsetWidth; // Trigger reflow
                w.classList.add('shake-anim');
            },

            openModal(html) {
                document.getElementById('modal-body').innerHTML = html;
                document.getElementById('game-modal').classList.add('active');
            },
            closeModal() {
                document.getElementById('game-modal').classList.remove('active');
            },

            renderProfile() {
                // Render History
                const histList = document.getElementById('history-list');
                if(Store.data.history.length === 0) {
                    histList.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">H…ôl…ô he√ß n…ô yoxdur</div>';
                } else {
                    histList.innerHTML = Store.data.history.map(h => `
                        <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #222;">
                            <div>
                                <div style="font-weight:500;">${h.desc}</div>
                                <div style="color:#666; font-size:10px;">${h.date}</div>
                            </div>
                            <div style="font-weight:bold; color: ${h.amount.includes('+') ? 'var(--success)' : 'var(--danger)'}">${h.amount}</div>
                        </div>
                    `).join('');
                }

                // Render Inventory
                const invList = document.getElementById('inventory-list');
                if(Store.data.inventory.length === 0) {
                    invList.innerHTML = '<div style="text-align:center; padding:10px; color:#666;">H…ôdiyy…ôniz yoxdur</div>';
                } else {
                    invList.innerHTML = Store.data.inventory.map(i => `
                        <div class="inv-item">
                            <div>
                                <div style="font-weight:bold; color:var(--gold-primary)">${i.name}</div>
                                <div style="font-size:10px; color:#888;">Alƒ±ndƒ±: ${i.date}</div>
                            </div>
                            <div style="font-size:18px;">‚úÖ</div>
                        </div>
                    `).join('');
                }
            },

            vibrate(pattern) {
                if(navigator.vibrate) try { navigator.vibrate(pattern); } catch(e){}
            },

            confetti() {
                const colors = ['#D4AF37', '#FFF', '#F3E5AB'];
                for (let i = 0; i < 40; i++) {
                    const c = document.createElement('div');
                    c.style.cssText = `
                        position: fixed; left: ${Math.random()*100}vw; top: -10px;
                        width: ${Math.random()*8+4}px; height: ${Math.random()*8+4}px;
                        background: ${colors[Math.floor(Math.random()*colors.length)]};
                        z-index: 3000; border-radius: 50%; pointer-events: none;
                        animation: fall ${1+Math.random()*2}s linear forwards;
                    `;
                    document.body.appendChild(c);
                    setTimeout(() => c.remove(), 3000);
                }
            }
        };

        // --- 4. TASK SYSTEM ---
    const Tasks = {
    // 1. DEFINING THE MISSIONS (Add more here easily!)
    missionData: [
        { 
            id: 'insta_1', 
            title: "Instagram'da ƒ∞zl…ô", 
            reward: 100, 
            icon: 'üì∏', 
            url: 'https://instagram.com/brendimo.az' 
        },
        { 
            id: 'tiktok_1', 
            title: "TikTok'da ƒ∞zl…ô", 
            reward: 100, 
            icon: 'üéµ', 
            url: 'https://tiktok.com/@brendimo' 
        },
        { 
            id: 'tele_1', 
            title: "Telegram Kanalƒ±", 
            reward: 150, 
            icon: '‚úàÔ∏è', 
            url: 'https://t.me/brendimo' 
        },
        { 
            id: 'wp_invite', 
            title: "Dostunu D…ôv…ôt Et", 
            reward: 200, 
            icon: 'üí¨', 
            type: 'share' // Special type for WhatsApp
        }
    ],

    checkDaily() {
        const now = Date.now();
        const oneDay = 24 * 60 * 60 * 1000;
        const btn = document.getElementById('btn-claim-daily');
        
        if (now - Store.data.lastDaily > oneDay) {
            btn.classList.remove('btn-disabled');
            btn.innerText = "G√∂t√ºr (+50)";
            btn.onclick = () => this.claimDaily();
        } else {
            btn.classList.add('btn-disabled');
            const left = Math.ceil(((Store.data.lastDaily + oneDay) - now) / (1000 * 60 * 60));
            btn.innerText = `${left} saat sonra`;
        }
        
        // Render the mission list whenever we check daily
        this.renderMissions(); 
    },

    claimDaily() {
        Store.addCoins(50, 'Daily Bonus');
        Store.data.lastDaily = Date.now();
        Store.save();
        this.checkDaily();
    },

    // 2. RENDER THE LIST AUTOMATICALLY
    renderMissions() {
        const container = document.getElementById('mission-list');
        if(!container) return;

        // Ensure completedTasks exists (for old users)
        if(!Store.data.completedTasks) Store.data.completedTasks = [];

        container.innerHTML = this.missionData.map(task => {
            const isDone = Store.data.completedTasks.includes(task.id);
            
            // If done, change style to look "finished"
            const opacity = isDone ? '0.5' : '1';
            const icon = isDone ? '‚úÖ' : '&rsaquo;';
            const clickAction = isDone ? '' : `onclick="Tasks.execute('${task.id}')"`;
            const rewardColor = isDone ? '#666' : 'var(--success)';

            return `
            <div class="shop-item" ${clickAction} style="opacity: ${opacity}">
                <div style="font-size:24px; width:40px; text-align:center;">${task.icon}</div>
                <div style="flex:1;">
                    <div style="font-weight:600;">${task.title}</div>
                    <div style="font-size:11px; color:${rewardColor};">${isDone ? 'Tamamlandƒ±' : '+' + task.reward + ' Coin'}</div>
                </div>
                <div style="opacity:0.5;">${icon}</div>
            </div>
            `;
        }).join('');
    },

    // 3. HANDLE EXECUTION
    execute(id) {
        const task = this.missionData.find(m => m.id === id);
        if(!task) return;

        // WhatsApp Share Logic
        if(task.type === 'share') {
            const text = `H…ôdiyy…ô axtarƒ±rsansa, H…ôdiyy…ô Sehrbazƒ±nƒ±n Endirim Festivalƒ±nda m√ºxt…ôlif endiriml…ôr v…ô 5 AZN kupon qazana bil…ôrs…ôn! Sifari≈ü ed…ônd…ô bu n√∂mr…ôni kupon kimi bildir…ôrs…ôn: ${Store.data.phone} Sayta ke√ßid - www.sehrbaz.com`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
            // We usually don't limit sharing, but if you want to limit it:
            // this.completeTask(id, task.reward); 
            return;
        }

        // Standard Social Logic
        if(confirm(`${task.title} v…ô ${task.reward} Coin qazan!`)) {
            window.open(task.url, '_blank');
            
            // Wait 5 seconds to simulate checking
            setTimeout(() => {
                if(confirm("Tap≈üƒ±rƒ±ƒüƒ± yerin…ô yetirdiniz?")) {
                    this.completeTask(id, task.reward);
                }
            }, 5000);
        }
    },

    completeTask(id, reward) {
        Store.addCoins(reward, 'Task: ' + id);
        Store.data.completedTasks.push(id); // Save ID to memory
        Store.save(); // Save to LocalStorage/Cloud
        UI.vibrate([50, 50]);
        alert("üéâ ∆èla! Coinl…ôr …ôlav…ô olundu.");
        this.renderMissions(); // Re-draw list to show checkmark
    }
};

        // --- 5. GAME ENGINES ---
        const Games = {
            
            // --- WHEEL ENGINE (Optimized with memory) ---
            Wheel: {
                cost: 50,
                currentRotation: 0, // Keeps track of rotation to prevent snapping
                prizes: [
                    { label: "0", val: 0, color: '#222', weight: 35 },
                    { label: "50", val: 50, color: '#444', weight: 35 },
                    { label: "20", val: 20, color: '#222', weight: 25 },
                    { label: "100", val: 100, color: '#444', weight: 4 },
                    { label: "200", val: 200, color: 'var(--gold-primary)', weight: 1 }
                ],
                
                init() {
                    UI.openModal(`
                        <h3>Lucky Wheel</h3>
                        <div class="wheel-container">
                            <div class="wheel-pointer"><svg viewBox="0 0 24 24" fill="#fff"><path d="M12 22l-10-18h20z"/></svg></div>
                            <div class="wheel-el" id="wheel-spinner"></div>
                        </div>
                        <button class="btn-primary" id="spin-btn" onclick="Games.Wheel.spin()">SPIN (-${this.cost})</button>
                    `);
                    this.drawWheel();
                    // Reset rotation visual but keep math logic
                    setTimeout(() => {
                         const el = document.getElementById('wheel-spinner');
                         if(el) el.style.transform = `rotate(${this.currentRotation}deg)`;
                    }, 10);
                },

                drawWheel() {
                    const el = document.getElementById('wheel-spinner');
                    let grad = 'conic-gradient(';
                    let deg = 0;
                    const step = 360 / this.prizes.length;
                    
                    this.prizes.forEach((p) => {
                        grad += `${p.color} ${deg}deg ${deg + step}deg,`;
                        const label = document.createElement('div');
                        label.innerText = p.label;
                        label.style.cssText = `
                            position: absolute; left: 50%; top: 50%;
                            transform: translate(-50%, -50%) rotate(${deg + step/2}deg) translateY(-85px);
                            font-weight: bold; color: ${p.val === 200 ? 'black' : 'white'};
                        `;
                        el.appendChild(label);
                        deg += step;
                    });
                    el.style.background = grad.slice(0, -1) + ')';
                },

                spin() {
                    if (!Store.deduct(this.cost, 'Game: Wheel')) return;
                    
                    const btn = document.getElementById('spin-btn');
                    btn.classList.add('btn-disabled');

                    // Weighted Logic
                    const totalWeight = this.prizes.reduce((sum, p) => sum + p.weight, 0);
                    let rand = Math.random() * totalWeight;
                    let winnerIndex = 0;
                    for (let i = 0; i < this.prizes.length; i++) {
                        if (rand < this.prizes[i].weight) { winnerIndex = i; break; }
                        rand -= this.prizes[i].weight;
                    }

                    // Math for continuous rotation
                    const segmentAngle = 360 / this.prizes.length;
                    const winningCenter = (winnerIndex * segmentAngle) + (segmentAngle / 2);
                    
                    // We add 5 full spins (1800 deg) + target
                    // To land on winner, we must rotate backwards relative to 0
                    const targetRotation = this.currentRotation + 1800 + (360 - (winningCenter + this.currentRotation % 360));
                    
                    // Add slight random offset for realism (+/- 10 deg inside segment)
                    const randomOffset = Math.floor(Math.random() * 20) - 10;
                    const finalRot = targetRotation + randomOffset;
                    
                    this.currentRotation = finalRot; // Save state

                    const wheel = document.getElementById('wheel-spinner');
                    wheel.style.transition = "transform 4s cubic-bezier(0.25, 0.1, 0.25, 1)";
                    wheel.style.transform = `rotate(${finalRot}deg)`;

                    UI.vibrate(200);

                    setTimeout(() => {
                        const win = this.prizes[winnerIndex].val;
                        if(win > 0) {
                            alert(`üéâ ${win} Coin Qazandƒ±n!`);
                            Store.addCoins(win, 'Win: Wheel');
                        } else {
                            alert("üò¢ Bo≈ü");
                            UI.vibrate(50);
                        }
                        UI.closeModal();
                    }, 4100);
                }
            },

            // --- SCRATCH ENGINE (Optimized) ---
            Scratch: {
                cost: 30,
                init() {
                    if (!Store.deduct(this.cost, 'Game: Scratch')) return;

                    const outcomes = [0, 0, 10, 30, 50, 100];
                    const win = outcomes[Math.floor(Math.random() * outcomes.length)];
                    
                    UI.openModal(`
                        <h3>Poz-Qazan</h3>
                        <div style="position:relative; width:240px; height:120px; margin:20px auto; border-radius:12px; overflow:hidden; border:1px solid #444;">
                            <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:#111; z-index:1;">
                                <span style="font-size:24px; font-weight:bold; color:${win>0?'var(--gold-primary)':'#666'}">${win>0 ? '+'+win : '0'}</span>
                            </div>
                            <canvas id="scratch-cvs" width="240" height="120" style="position:absolute; inset:0; z-index:2; cursor:crosshair;"></canvas>
                        </div>
                        <p style="font-size:12px; color:#888;">G√ºm√º≈ü sah…ônin yarƒ±sƒ±ndan √ßoxunu pozun</p>
                    `);

                    this.setupCanvas(win);
                },

                setupCanvas(winVal) {
                    const canvas = document.getElementById('scratch-cvs');
                    const ctx = canvas.getContext('2d', { willReadFrequently: true }); // Opt for readback
                    
                    ctx.fillStyle = '#C0C0C0';
                    ctx.fillRect(0, 0, 240, 120);
                    ctx.fillStyle = '#A9A9A9';
                    ctx.font = "20px Arial";
                    ctx.fillText("H…ôdiyy…ô Sehrbazƒ±", 45, 65);

                    let isDrawing = false;
                    let finished = false;

                    const scratch = (x, y) => {
                        if(finished) return;
                        ctx.globalCompositeOperation = 'destination-out';
                        ctx.beginPath();
                        ctx.arc(x, y, 15, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Throttle check to improve mobile performance
                        if(Math.random() > 0.85) checkPercent(); 
                    };

                    const getPos = (e) => {
                        const r = canvas.getBoundingClientRect();
                        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                        return { x: clientX - r.left, y: clientY - r.top };
                    };

                    const checkPercent = () => {
                        const imageData = ctx.getImageData(0, 0, 240, 120);
                        let clear = 0;
                        // Optimization: Check every 4th pixel (alpha channel)
                        for (let i = 3; i < imageData.data.length; i += 16) { 
                            if (imageData.data[i] === 0) clear++;
                        }
                        // Approx total pixels / 4
                        if (clear > (240 * 120 / 4) * 0.4) { 
                            finished = true;
                            canvas.style.opacity = 0; 
                            canvas.style.transition = 'opacity 0.5s';
                            UI.vibrate([50, 50]);
                            setTimeout(() => {
                                if(winVal > 0) {
                                    alert("T…ôbrikl…ôr! " + winVal + " Coin.");
                                    Store.addCoins(winVal, 'Win: Scratch');
                                } else {
                                    alert("B…ôxtini bir daha yoxla.");
                                }
                                UI.closeModal();
                            }, 600);
                        }
                    };

                    const start = (e) => { isDrawing = true; };
                    const end = () => { isDrawing = false; };
                    const move = (e) => {
                        if(isDrawing) {
                            e.preventDefault(); // Prevent scrolling
                            const p = getPos(e);
                            scratch(p.x, p.y);
                        }
                    };

                    canvas.addEventListener('mousedown', start);
                    canvas.addEventListener('touchstart', start);
                    window.addEventListener('mouseup', end);
                    window.addEventListener('touchend', end);
                    canvas.addEventListener('mousemove', move);
                    canvas.addEventListener('touchmove', move);
                }
            },

            // --- CARDS ENGINE ---
            Cards: {
                cost: 50,
                init() {
                    UI.openModal(`
                        <h3>Mystery Cards</h3>
                        <p style="font-size:12px; color:#888;">Bet: 50 Coin</p>
                        <div class="card-scene">
                            <div class="card-wrap" onclick="Games.Cards.flip(0)">
                                <div class="card-face card-front">?</div>
                                <div class="card-face card-back" id="c0"></div>
                            </div>
                            <div class="card-wrap" onclick="Games.Cards.flip(1)">
                                <div class="card-face card-front">?</div>
                                <div class="card-face card-back" id="c1"></div>
                            </div>
                            <div class="card-wrap" onclick="Games.Cards.flip(2)">
                                <div class="card-face card-front">?</div>
                                <div class="card-face card-back" id="c2"></div>
                            </div>
                        </div>
                    `);
                },

             
flip(chosenIndex) {
                if (!Store.deduct(this.cost, 'Game: Cards')) return;

                const cards = document.querySelectorAll('.card-wrap');
                cards.forEach(c => c.style.pointerEvents = 'none'); // Lock UI

                // --- NEW LOGIC: Rigged Probabilities ---
                // Win: 15%, Safe: 50%, Lose: 35%
                const rand = Math.random() * 100;
                let userResult;

                // 1. Determine the result for the card the user CLICKED
                if (rand < 5) {
                    userResult = { val: 300, icon: 'üíé', type: 'win' };
                } else if (rand < 65) { // 15 + 50 = 65
                    userResult = { val: 50, icon: 'üîÑ', type: 'safe' };
                } else {
                    userResult = { val: 0, icon: 'üí£', type: 'lose' };
                }

                // 2. Determine what the OTHER two cards show
                // We want to maintain the illusion that there was "one of each" on the table.
                const allTypes = [
                    { val: 300, icon: 'üíé', type: 'win' },
                    { val: 50, icon: 'üîÑ', type: 'safe' },
                    { val: 0, icon: 'üí£', type: 'lose' }
                ];
                
                // Get the two types the user DIDN'T pick to show as decoys
                const decoys = allTypes.filter(t => t.type !== userResult.type);
                // Shuffle the decoys so their positions vary
                decoys.sort(() => Math.random() - 0.5);

                // 3. Build the final view
                let deck = [];
                let decoyIndex = 0;
                for (let i = 0; i < 3; i++) {
                    if (i === chosenIndex) {
                        deck[i] = userResult;
                    } else {
                        deck[i] = decoys[decoyIndex++];
                    }
                }

                // --- Standard Reveal Animation ---
                cards.forEach((card, i) => {
                    const back = document.getElementById(`c${i}`);
                    back.innerText = deck[i].icon;
                    card.classList.add('flipped');
                    
                    if(i === chosenIndex) {
                        back.style.boxShadow = `inset 0 0 20px ${deck[i].val > 0 ? 'gold' : 'red'}`;
                    }
                });

                setTimeout(() => {
                    const res = deck[chosenIndex];
                    if(res.val === 0) {
                            UI.vibrate(300);
                            alert("üí£ Partladƒ±! -50 Coin");
                    } else if(res.val === 50) { 
                        alert("ƒ∞tirm…ôdin! Pullar qayƒ±tdƒ±. Yenid…ôn sƒ±na!"); 
                        Store.addCoins(50, 'Refund: Cards'); 
                    } else { 
                        alert("üíé CekPot! +300 Coin"); 
                        Store.addCoins(300, 'Win: Cards'); 
                    }
                    UI.closeModal();
                }, 1500);
            }
      }
        };          
      

        // Animation Styles Injection
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes fall { to { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
            @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        `;
        document.head.appendChild(styleSheet);

        // Init
        window.onload = () => App.init();
    </script>
</body>
</html>
