<!doctype html>
<html lang="az">
<head>
  <meta property="og:image" content="https://github.com/Brendimo-co/sanscarxi/blob/main/unnamed.jpg?raw=true" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>Brendimo H…ôdiyy…ô √ßarxƒ± indi sizin √º√ß√ºn aktivdir!</title>
  
  <style>
    /* Brendimo Dopamine CSS
       Mobile-first. Full stylesheet
       Focus: ultra-satisfying visuals, motion, and micro-feedback.
    */
    html, body {
      width: 100%;
      height: 100%;
      overflow-x: hidden;
      overflow-y: auto;
    }

    /* ---------- Tokens ---------- */
    :root{
      --bg-deep: #050914;
      --bg-velvet: linear-gradient(135deg,#071226 0%, #0b2a3f 45%, #052826 100%);
      --glass: rgba(255,255,255,0.04);
      --glass-strong: rgba(0,0,0,0.6);
      --muted: #b7c1cd;
      --text: #eff6ff;
      --accent-gold: #ffd166;
      --accent-hot: #ff5b89;
      --accent-cyan: #2be7c8;
      --accent-blue: #1197d6;
      --success: #12c48b;
      --danger: #ff6b6b;
      --ui-radius: 18px;
      --max-width: 1200px;
      --wheel-size-mobile: min(88vw, 520px);
      --wheel-edge-glow: 16px;
      --shadow-hero: 0 30px 80px rgba(2,6,23,0.8);
      --shadow-soft: 0 10px 28px rgba(2,6,23,0.55);
      --confetti-z: 999999;
      --pointer-size: 44px;
      --spin-duration: 5200ms;
    }

    /* ---------- Reset ---------- */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      min-height:100vh;
      font-family: Inter, "Poppins", Roboto, "Arial", Arial, system-ui;
      background: var(--bg-velvet);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding: calc(env(safe-area-inset-top) + 18px) 18px 18px 18px;
      display:flex;
      justify-content:center;
      align-items: flex-start; /* ‚úÖ allows full scroll */
      overflow-y: auto;
    }
    /* üî• Add this for iPhone & mobile safe area support */
    @supports(padding: max(0px)) {
      @media (max-width: 768px) {
        body {
          padding-top: max(env(safe-area-inset-top), 18px);
        }
      }
    }

    /* ---------- Header ---------- */
    .container {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      padding: 0 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .brand {
      margin-top: 24px;
      text-align: center;
    }

    .subtitle {
      margin-top: 8px;
      font-size: 16px;
      color: var(--muted);
    }

    @media (max-width: 600px) {
      .brand h1 {
        font-size: 18px;
      }

      .subtitle {
        font-size: 14px;
      }
    }

    @media (max-width: 600px) {
      .container {
        padding: 0 12px;
      }
    }

    /* ---------- Form ---------- */
    .form-section{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.05));
      border-radius:14px;
      padding:14px;
      border:1px solid rgba(255,255,255,0.04);
      box-shadow: var(--shadow-soft);
    }
    .form-section label{ display:block; font-size:13px; margin-top:10px; color:var(--muted); }
    .form-section input[type="text"]{
      width:100%;
      padding:12px 14px;
      margin-top:8px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.04);
      background: rgba(255,255,255,0.015);
      color:var(--text);
      font-size:15px;
      outline:none;
      transition: box-shadow .15s ease, transform .08s ease;
    }
    .form-section input[type="text"]::placeholder{ color: rgba(255,255,255,0.2); }
    .form-section input[type="text"]:focus{
      box-shadow: 0 14px 40px rgba(17,151,218,0.06);
      border-color: rgba(17,151,218,0.6);
      transform: translateY(-2px);
    }
    .form-actions{ margin-top:14px; display:flex; gap:10px; align-items:center; }

    /* CTA buttons with tactile feedback */
    .btn{
      cursor:pointer;
      border:0;
      padding:10px 14px;
      border-radius:12px;
      font-weight:800;
      color:#051122;
      background: linear-gradient(180deg,var(--accent-gold), #ffb84d);
      box-shadow: 0 14px 36px rgba(255,181,60,0.12), inset 0 -2px 0 rgba(255,255,255,0.06);
      transition: transform .12s cubic-bezier(.2,.9,.2,1), box-shadow .12s ease, filter .12s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.996); }
    .btn.primary{ background: linear-gradient(180deg,#ff6f91,#ff3e78); color:#fff; box-shadow: 0 18px 46px rgba(255,62,120,0.16); }
    .btn[disabled], .btn.disabled{ opacity:.45; cursor:not-allowed; transform:none; box-shadow:none; }

    /* note */
    .note{ display:block; margin-top:10px; color:var(--muted); font-size:12px; }

    /* ---------- Wheel Hero ---------- */
    /* wheel card ‚Äî big, glowing, tactile */
    /* Wheel */
    .wheel-section {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 24px 0;
    }

    .wheel-wrap {
      width: 700px;
      height: 700px;
      position: relative;
      border-radius: 60%;
      background: radial-gradient(circle at 40% 20%, rgba(255,255,255,0.04), transparent 10%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 30px rgba(255, 204, 0, 0.1);
      user-select: none;
    }

    .wheel-wrap.inactive {
      opacity: 0.6;
      filter: grayscale(0.1) contrast(0.9);
    }

    /* when spinning, add motion blur and energetic pulse */
    .wheel-wrap.spinning{
      animation: wheelPulse .9s ease-in-out 1;
      filter: drop-shadow(0 30px 60px rgba(255,99,120,0.08));
    }
    @keyframes wheelPulse{
      0%{ transform: scale(1); }
      50%{ transform: scale(1.008) rotate(-0.2deg); }
      100%{ transform: scale(1); }
    }

    /* winning state: intense glow and flare */
    .wheel-wrap.win{
      box-shadow: 0 360px 120px rgba(255,110,150,0.2), 0 18px 60px rgba(17,153,218,0.06);
      animation: winPop .45s ease-out 1;
    }
    @keyframes winPop{
      0%{ transform: scale(.985); filter: blur(0); }
      60%{ transform: scale(1.03); filter: blur(.8px); }
      100%{ transform: scale(1); }
    }

    /* pointer indicator */
    .pointer{
      position:absolute;
      top:10px;
      left:50%;
      transform:translateX(-50%);
      width:var(--pointer-size);
      height:var(--pointer-size);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:900;
      z-index:120;
      background: linear-gradient(180deg,#ffffff10,#00000030);
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.06);
      box-shadow: 0 10px 30px rgba(0,0,0,0.6);
      text-shadow: 0 4px 12px rgba(0,0,0,0.6);
      pointer-events:none;
      transform-origin:center;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,0.6));
      transition: transform .18s cubic-bezier(.2,.9,.2,1);
    }

    /* pointer micro-bounce */
    .pointer.idle{ animation: pointerIdle 3s ease-in-out infinite; }
    @keyframes pointerIdle{
      0%,100%{ transform: translateX(-50%) translateY(0) rotate(0); }
      50%{ transform: translateX(-50%) translateY(-5px) rotate(-1deg); }
    }

    /* spin button ‚Äî pill, large, neon edge */
    #spinBtn{
      position:absolute;
      bottom:22px;
      left:50%;
      transform:translateX(-50%);
      z-index:110;
      border-radius:999px;
      padding:16px 26px;
      font-size:18px;
      font-weight:900;
      letter-spacing:0.6px;
      color:#fff;
      background: linear-gradient(180deg,var(--accent-hot), #ff2e6b);
      box-shadow: 0 24px 72px rgba(255,46,107,0.18), 0 8px 22px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.06);
      transition: transform .12s cubic-bezier(.2,.9,.2,1), box-shadow .12s ease;
    }
    #spinBtn:active{ transform: translateY(1px) scale(.997); }

    /* disabled state */
    .wheel-wrap.inactive #spinBtn,
    #spinBtn.disabled{
      background: linear-gradient(180deg,#6f7b86,#4f5962);
      box-shadow:none;
      color:#dfe7ef;
    }

    /* kinetic micro-ripple on press (accessible) */
    #spinBtn:focus{ outline: 3px solid rgba(255,90,130,0.10); outline-offset:4px; }

    /* ---------- History and side UI ---------- */
    .history-section{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));
      border-radius:12px;
      padding:12px;
      border:1px solid rgba(255,255,255,0.03);
      box-shadow: var(--shadow-soft);
      color:var(--muted);
      min-height:110px;
    }
    .history-section h3{ margin:0 0 8px 0; color:var(--text); }
    .history-list{ margin:0; padding:0; list-style:none; max-height:220px; overflow:auto; }
    .history-list li{
      font-size:13px;
      padding:10px 12px;
      border-radius:10px;
      margin-bottom:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.05));
      color:var(--muted);
    }

    /* small badge for tiers */
    .tier-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 8px;
      border-radius:999px;
      font-weight:800;
      font-size:12px;
      color:#06121a;
    }
    .tier-A{ background: linear-gradient(135deg, #FFEA70, #FFC300, #B8860B);}
    .tier-B{ background: linear-gradient(135deg, #C266FF, #8B00FF, #4B0082);}
    .tier-C{ background: linear-gradient(135deg, #4A90E2, #0047AB, #001F5B); }
    .tier-D{ background: linear-gradient(135deg, #FFEA70, #FFC300, #B8860B);}
    .tier-E{ background: linear-gradient(180deg,#F50707,#F50707); color:#F50707; }
    .tier-F{ background: linear-gradient(135deg, #FF4C4C, #E10600, #8B0000); }
    
    /* ---------- Modal ---------- */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      z-index:999999;
      backdrop-filter: blur(10px) saturate(1.1);
    }
    .modal:not(.hidden){ display:flex; }
    .modal-content{
      width:100%;
      max-width:560px;
      border-radius:16px;
      padding:22px;
      background: linear-gradient(180deg, rgba(6,12,20,0.98), rgba(8,18,30,0.99));
      border:1px solid rgba(255,255,255,0.04);
      box-shadow: 0 30px 90px rgba(2,6,23,0.85);
    }
    .modal-close{ position:absolute; right:22px; top:20px; background:transparent; color:var(--muted); border:10; font-size:22px; cursor:pointer; }
    .big{ font-size:20px; font-weight:900; margin:8px 0 6px 0; color:#fff; }
    .muted{ color:var(--muted); margin:0 0 8px 0; }
    .instructions{ min-height:44px; color:var(--muted); }

    /* ---------- Share CTA ---------- */
    .share-cta{
      position:fixed;
      right:16px;
      bottom:16px;
      z-index:99999;
    }
    .share-cta .btn{ background: linear-gradient(180deg,var(--accent-cyan), #00d2b3); color:#021115; font-weight:900; box-shadow: 0 14px 40px rgba(2,210,179,0.12); }

    /* ---------- Confetti pieces ---------- */
    .confetti-piece{
      width:10px;
      height:16px;
      border-radius:3px;
      will-change: transform, opacity;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
      position:fixed;
      z-index: var(--confetti-z);
    }

    /* animated sparkles that appear on win */
    .win-spark{
      position:absolute;
      width:8px;
      height:8px;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,0.8));
      box-shadow: 0 6px 20px rgba(255,160,120,0.18);
      will-change: transform, opacity;
      pointer-events:none;
    }

    /* ---------- Responsive adjustments ---------- */
    @media (max-width:600px){
      :root{ --pointer-size:40px; --wheel-edge-glow:12px; }
      canvas#wheelCanvas{ width: calc(min(92vw, 520px)); height: calc(min(92vw, 520px)); }
      #spinBtn{ padding:14px 20px; font-size:16px; }
    }

    /* ---------- Desktop polish ---------- */
    @media (max-width: 768px) {
      .wheel-wrap {
        width: 100%;
        max-width: 360px;
        height: auto;
      }

      #wheelCanvas {
        width: 100%;
        height: auto;
      }
    }
    @media (max-width: 820px) {
      .wheel-wrap {
        width: 420px;
        height: 420px;
      }
      #wheelCanvas {
        width: 420px;
        height: 420px;
      }
    }

    @media (max-width: 420px) {
      .wheel-wrap {
        width: 320px;
        height: 320px;
      }
      #wheelCanvas {
        width: 320px;
        height: 320px;
      }
    }

    /* ---------- FIX FOR MOBILE VIEW ---------- */
    @media (max-width: 600px) {
      body {
        align-items: flex-start;
        padding: 12px;
      }

      .pointer {
        top: 6px;
      }

      #spinBtn {
        bottom: 12px;
        transform: translateX(-50%);
        font-size: 16px;
        padding: 12px 22px;
      }

      .form-section {
        margin-top: 24px;
      }

      .brand h1 {
        font-size: 18px;
      }

      .subtitle {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>

<main class="container">
  <header class="brand">
  <h1 id="main-title"></h1>
   <p class="subtitle">S…ôn h…ôdiyy…ô il…ô kimis…ô xo≈üb…ôxt ed…ôc…ôks…ôn ‚Äî Brendimonun da s…ôn…ô h…ôdiyy…ôsi var... üíï </p>
  </header>

  <section class="form-section">
    <form id="entryForm" autocomplete="off">
      <label for="fullName">Ad v…ô Soyad</label>
      <input id="fullName" name="fullName" type="text" placeholder="Ad v…ô Soyadƒ±nƒ±z" required />

      <label for="phone">WhatsApp N√∂mr…ôsi</label>
      <input id="phone" name="phone" type="text" placeholder="+994501234567" required />

      <div class="form-actions">
        <button id="submitBtn" type="submit" class="btn primary"> üöÄ Aktiv Et!‚ö°Ô∏è</button>
      </div>

      <small class="note"> B…ôxtini el…ô indi, yax≈üƒ± vaxtda sƒ±na ‚Äî g√ºn …ôrzind…ô sad…ôc…ô 1 üé° ≈üansƒ±n var. ü™Ñ</small>
    </form>
  </section>

  <section class="wheel-section">
    <div id="wheelWrap" class="wheel-wrap inactive">
<canvas id="wheelCanvas"></canvas>
      <button id="spinBtn" class="btn spin disabled" disabled>√áevir</button>
      <div id="pointer" class="pointer">‚ñº</div>
    </div>
  </section>

  <section class="history-section">
    <h3>√áarx Tarix√ß…ôniz</h3>
    <ul id="historyList" class="history-list"></ul>
  </section>
</main>

<div id="resultModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="resultTitle">
  <div class="modal-content">
    <button id="closeModal" class="modal-close" aria-label="Baƒüla">√ó</button>
    <h2 id="resultTitle">T…ô≈ü…ôkk√ºr edirik!</h2>
    <p id="resultGift" class="big"></p>
    <p id="resultTier" class="muted"></p>
    <div id="resultInstructions" class="instructions"></div>

    <div class="modal-actions">
      <button id="modalOk" class="btn primary">Bitir</button>
    </div>
  </div>
</div>
<div id="shareCTA" class="share-cta hidden">
<button id="shareBtn" class="btn" hidden>Payla≈ü v…ô 5 AZN Endirim</button>
</div>

<script>
/* script.js - Updated for:
   - first 3 spins per day deterministic behavior
   - server-side 3/day enforcement
   - removed countdown and share CTA usage
   - new API endpoint
*/

/* ===========================
CONFIG
=========================== */

const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbzwgkr3AN5u0nAelm-0qJZxrFvFRgj2cZtIbUpMl7Q7BzKdHvjkporVg6-Cs0PyKB8vHA/exec";

/* ===========================
DOM refs
=========================== */

const form = document.getElementById('entryForm');
const fullNameInput = document.getElementById('fullName');
const phoneInput = document.getElementById('phone');
const submitBtn = document.getElementById('submitBtn');
const wheelWrap = document.getElementById('wheelWrap');
const wheelCanvas = document.getElementById('wheelCanvas');
const spinBtn = document.getElementById('spinBtn');
const historyList = document.getElementById('historyList');
const resultModal = document.getElementById('resultModal');
const resultGiftEl = document.getElementById('resultGift');
const resultTierEl = document.getElementById('resultTier');
const resultInstructions = document.getElementById('resultInstructions');
const closeModal = document.getElementById('closeModal');
const modalOk = document.getElementById('modalOk');
const resultTitle = document.getElementById('resultTitle');

/* ===========================
Gifts configuration
=========================== */

const GIFTS = [
  { id: 'A1', name: '100 AZN H…ôdiyy…ô kartƒ±', tier: 'A', weight: 0.000 },
  { id: 'A2', name: '15 AZN Endirim', tier: 'A', weight: 0.000 },
  { id: 'A3', name: '50 AZN H…ôdiyy…ô kartƒ±', tier: 'A', weight: 0.000 },
  
  { id: 'D1', name: 'Qazanmadƒ±nƒ±z', tier: 'D', weight: 13.995 },
  { id: 'B1', name: 'Premium Parf√ºm', tier: 'B', weight: 0.495 },
  { id: 'B2', name: 'Qalstuk D…ôsti', tier: 'B', weight: 0.000 },
   { id: 'B3', name: 'Premium K…ôm…ôr', tier: 'B', weight: 0.000 },
  { id: 'F1', name: '1 AZN qazandƒ±n!', tier: 'F', weight: 17.495 },
  
  
  { id: 'F2', name: 'Premium Ka≈üelok', tier: 'F', weight: 0.000 },
 
  { id: 'F3', name: '3 AZN Endirim', tier: 'F', weight: 0.000 },
  
  
 { id: 'C1', name: '√úr…ôk Naxƒ±≈ülƒ± Bralok', tier: 'C', weight: 1 },
  { id: 'C2', name: 'Ka≈üelok', tier: 'C', weight: 1 },
  { id: 'C3', name: 'K…ôm…ôr', tier: 'C', weight: 1 },
  { id: 'C4', name: 'Qolbaq', tier: 'A', weight: 1 },

  { id: 'C5', name: 'Saat', tier: 'A', weight: 1 },
   { id: 'C6', name: 'Qadƒ±n bralok', tier: 'A', weight: 1 },
   { id: 'C7', name: 'Alƒ±≈üqan', tier: 'B', weight: 1 },
   { id: 'C8', name: 'LetterCharm ‚Äì qadƒ±n bralok', tier: 'B', weight: 1 },
   { id: 'C9', name: 'G√∂z Muncuƒüu Braloku', tier: 'B', weight: 1 },
   { id: 'C10', name: 'Klassik Bralok', tier: 'F', weight: 1 },
   { id: 'C11', name: 'Ma≈üƒ±n aksesuarƒ± (it)', tier: 'F', weight: 1 },
   { id: 'C11', name: 'Ma≈üƒ±n aksesuarƒ± (pi≈üik)', tier: 'F', weight: 1 },
   { id: 'C13', name: 'Curren ki≈üi saatƒ± ‚Äì Model 1', tier: 'C', weight: 1 },
   { id: 'C14', name: 'Curren ki≈üi saatƒ± ‚Äì Model 2', tier: 'C', weight: 1 },
   { id: 'C15', name: 'Curren ki≈üi saatƒ± ‚Äì Model 3', tier: 'C', weight: 1 },
   { id: 'C16', name: 'Casio qadƒ±n saatƒ± ‚Äì Model 1', tier: 'A', weight: 1 },
   { id: 'C17', name: 'Casio qadƒ±n saatƒ± ‚Äì Model 2', tier: 'A', weight: 1 },
   { id: 'C18', name: 'Curren ki≈üi saatƒ± - Model 4', tier: 'A', weight: 1 },
   { id: 'C19', name: 'Emporio Armani ki≈üi saatƒ±', tier: 'B', weight: 1 },
   { id: 'C20', name: 'Ki≈üi qƒ±zƒ±lƒ± boyunbaƒüƒ±', tier: 'B', weight: 1 },
   { id: 'C21', name: 'Ki≈üi qƒ±zƒ±lƒ± qolbaq', tier: 'B', weight: 1 },
 
   { id: 'C22', name: 'Parf√ºm', tier: 'F', weight: 1 }
];

/* ===========================
Helpers
=========================== */

const now = new Date();
const hours = now.getHours();
const minutes = now.getMinutes().toString().padStart(2, '0');
const timeText = `Saat ${hours}.${minutes}. Xo≈ü niy…ôt tut, Hiss et v…ô √áarxƒ± √áevir üéÅ!`;

document.getElementById('main-title').textContent = timeText;



function sanitizePhone(raw) {
  let s = (raw || '').trim();
  s = s.replace(/[^\d+]/g, '');
  if (s.startsWith('00')) s = '+' + s.slice(2);
  if (!s.startsWith('+') && /^\d{9}$/.test(s)) s = '+994' + s;
  if (/^0\d{9}$/.test(s)) s = '+994' + s.slice(1);
  return s;
}

function stateKey(phone) { return `brendimo_state_${phone}`; }

function loadState(phone) {
  try {
    const raw = localStorage.getItem(stateKey(phone));
    return raw ? JSON.parse(raw) : null;
  } catch (e) { return null; }
}

function saveState(phone, state) {
  localStorage.setItem(stateKey(phone), JSON.stringify(state));
}

function weightedRandomPick(allowE = false) {
  const pool = GIFTS.filter(g => allowE ? true : g.tier !== 'E');
  const totalWeight = pool.reduce((s, x) => s + Number(x.weight || 0), 0);
  if (totalWeight <= 0) {
    return pool[Math.floor(Math.random() * pool.length)];
  }
  const r = Math.random() * totalWeight;
  let acc = 0;
  for (let i = 0; i < pool.length; i++) {
    acc += Number(pool[i].weight);
    if (r <= acc) return pool[i];
  }
  return pool[pool.length - 1];
}

// Returns number of spins recorded locally for this phone for today's date (YYYY-MM-DD)
function getLocalSpinsToday(phone) {
  const state = loadState(phone);
  if (!state || !state.spins || !state.spins.length) return 0;
  const today = new Date().toISOString().slice(0, 10);
  return state.spins.filter(s => (s.date || '').slice(0, 10) === today).length;
}

/* ===========================
Canvas wheel rendering + animation
=========================== */

const canvas = wheelCanvas;
const ctx = wheelCanvas.getContext("2d");
let currentRotation = 0;
let isSpinning = false;
let lastRenderedPool = [];
let center = { x: 0, y: 0 };
let radius = 0;

function computeVisualSize() {
  const wrapRect = wheelWrap.getBoundingClientRect();
  return Math.min(wrapRect.width, window.innerHeight * 2);
}

function setCanvasSize(size) {
  const dpr = window.devicePixelRatio || 1;
  wheelCanvas.width = size * dpr;
  wheelCanvas.height = size * dpr;
  wheelCanvas.style.width = size + "px";
  wheelCanvas.style.height = size + "px";
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  center = { x: wheelCanvas.width / (2 * dpr), y: wheelCanvas.height / (2 * dpr) };
  radius = size / 2 - 20;
}

function resizeAndDraw() {
  const size = computeVisualSize();
  setCanvasSize(size);
  drawWheel(lastRenderedPool.length ? lastRenderedPool : GIFTS.filter(g => g.tier !== 'E'));
}

window.addEventListener('resize', () => requestAnimationFrame(resizeAndDraw));
window.addEventListener('orientationchange', resizeAndDraw);
window.addEventListener('load', resizeAndDraw);

function shadeColor(hex, percent) {
  var f = parseInt(hex.slice(1), 16), t = percent < 0 ? 0 : 255, p = percent < 0 ? percent * -1 : percent;
  var R = f >> 16, G = f >> 8 & 0x00FF, B = f & 0x0000FF;
  return "#" + (0x1000000 + (Math.round((t - R) * p / 100) + R) * 0x10000 + (Math.round((t - G) * p / 100) + G) * 0x100 + (Math.round((t - B) * p / 100) + B)).toString(16).slice(1);
}

function drawWheel(pool) {
  lastRenderedPool = pool.slice();
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const g = ctx.createRadialGradient(center.x - 120, center.y - 120, radius * 0.1, center.x, center.y, radius);
  g.addColorStop(0, 'rgba(255,255,255,0.02)');
  g.addColorStop(1, 'rgba(0,0,0,0.3)');
  ctx.fillStyle = g;
  ctx.beginPath();
  ctx.arc(center.x, center.y, radius + 8, 0, Math.PI * 2);
  ctx.fill();

  const total = pool.length || 1;
  const slice = (Math.PI * 2) / total;

  for (let i = 0; i < total; i++) {
    const start = i * slice;
    const end = start + slice;
    const tier = pool[i].tier;
    let color;
    switch (tier) {
      case 'A': color = '#FF6F00'; break;
      case 'B': color = '#007BFF'; break;
      case 'C': color = '#8000FF'; break;
      case 'D': color = '#E10600'; break;
      case 'F': color = '#28A745'; break;
      case 'G': color = '#E10600'; break;
      default: color = '#6b6b6b';
    }
    const alt = i % 2 === 0 ? color : shadeColor(color, -8);
    ctx.save();
    ctx.beginPath();
    ctx.moveTo(center.x, center.y);
    ctx.arc(center.x, center.y, radius, start + currentRotation, end + currentRotation);
    ctx.closePath();
    ctx.fillStyle = alt;
    ctx.fill();

    ctx.translate(center.x, center.y);
    const angle = start + slice / 2 + currentRotation;
    ctx.rotate(angle);
    ctx.textAlign = 'right';
    ctx.fillStyle = '#fff';
    ctx.font = `${Math.max(12, radius * 0.06)}px serif`;
    const text = pool[i].name || '';
    ctx.fillText(text, radius - 10, 6);
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.restore();
  }

  ctx.beginPath();
  ctx.fillStyle = 'rgba(0,0,0,0.6)';
  ctx.arc(center.x, center.y, 60, 0, Math.PI * 2);
  ctx.fill();
  ctx.beginPath();
  ctx.fillStyle = 'rgba(255,255,255,0.04)';
  ctx.arc(center.x, center.y, 56, 0, Math.PI * 2);
  ctx.fill();
}

function degreesToRadians(d) { return d * Math.PI / 180; }
function radiansToDegrees(r) { return r * 180 / Math.PI; }

function spinToIndex(selectedIndex, pool, cb) {
  if (isSpinning) return;
  isSpinning = true;
  spinBtn.classList.add('disabled');
  spinBtn.disabled = true;
  const total = pool.length || 1;
  const slice = (360 / total);
  const sectorCenterDeg = selectedIndex * slice + slice / 2;
  let targetDeg = 360 * 6 + (270 - sectorCenterDeg);
  const startDeg = radiansToDegrees(currentRotation);
  const duration = 5200 + Math.random() * 800;
  const start = performance.now();

  function step(now) {
    const t = Math.min(1, (now - start) / duration);
    const eased = 1 - Math.pow(1 - t, 3);
    const newDeg = startDeg + (targetDeg - startDeg) * eased;
    currentRotation = degreesToRadians(newDeg);
    drawWheel(pool);
    if (t < 1) {
      requestAnimationFrame(step);
    } else {
      currentRotation = degreesToRadians(targetDeg % 360);
      drawWheel(pool);
      isSpinning = false;
      cb && cb();
    }
  }
  requestAnimationFrame(step);
}

/* ===========================
UI helpers
=========================== */

function enableWheelUI() {
  wheelWrap.classList.remove('inactive');
  spinBtn.classList.remove('disabled');
  spinBtn.disabled = false;
}

function disableWheelUI() {
  wheelWrap.classList.add('inactive');
  spinBtn.classList.add('disabled');
  spinBtn.disabled = true;
}

/* initialize wheel */
function initWheel() {
  lastRenderedPool = GIFTS.slice();
  drawWheel(lastRenderedPool);
}
initWheel();

/* Input validation */
function validateInputs(name, phone) {
  if (!name || name.trim().length < 2) return { ok: false, msg: 'Tam ad daxil edin' };
  const p = sanitizePhone(phone);
  const re = /^\+?[0-9]{8,15}$/;
  if (!re.test(p)) return { ok: false, msg: 'WhatsApp n√∂mr…ôsini d√ºzg√ºn daxil edin' };
  return { ok: true, phone: p };
}

/* ===========================
Robust API client: POST then JSONP fallback
=========================== */

async function postToApi(data) {
  try {
    const res = await fetch(API_ENDPOINT, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (!res.ok) throw new Error('Non-OK response');
    const text = await res.text();
    try {
      const json = JSON.parse(text);
      return json;
    } catch (e) {
      throw new Error('Invalid JSON from POST');
    }
  } catch (err) {
    console.warn('POST failed, trying JSONP fallback due to CORS or network:', err);
    const params = Object.assign({}, data);
    const qs = Object.keys(params)
      .map(k => encodeURIComponent(k) + '=' + encodeURIComponent(String(params[k] || '')))
      .join('&');
    const cbName = 'brendimo_cb_' + Math.random().toString(36).slice(2,9);
    const url = API_ENDPOINT + (qs ? ('?' + qs + '&') : '?') + 'callback=' + cbName;
    return new Promise((resolve, reject) => {
      const timeout = setTimeout(() => { cleanup(); reject(new Error('JSONP timeout')); }, 11000);
      function cleanup() {
        clearTimeout(timeout);
        try { delete window[cbName]; } catch (e) {}
        const s = document.getElementById(cbName + '_script');
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }
      window[cbName] = function(resp) { cleanup(); resolve(resp); };
      const script = document.createElement('script');
      script.id = cbName + '_script';
      script.src = url;
      script.onerror = function() { cleanup(); reject(new Error('JSONP script error')); };
      document.body.appendChild(script);
    });
  }
}

/* ===========================
Form submission (check)
=========================== */

form.addEventListener('submit', async function(e) {
  e.preventDefault();
  if (isSpinning) return;
  const name = fullNameInput.value.trim();
  const phoneRaw = phoneInput.value.trim();
  const v = validateInputs(name, phoneRaw);
  if (!v.ok) { alert(v.msg); return; }
  const phone = v.phone;

  submitBtn.disabled = true;
  submitBtn.classList.add('disabled');
  submitBtn.innerText = 'Yoxlanƒ±lƒ±r...';

  try {
    const payload = { action: 'check', name, phone };
    const resp = await postToApi(payload);
    if (!resp || !resp.allowed) {
      alert(resp && resp.message ? resp.message : 'Bu n√∂mr…ô √º√ß√ºn bu g√ºn icaz…ô yoxdur');
      disableWheelUI();
      submitBtn.disabled = false;
      submitBtn.classList.remove('disabled');
      submitBtn.innerText = '√áarx aktiv deyil';
      return;
    }

    // ‚úÖ Spin allowed
    sessionStorage.setItem('brendimo_current', JSON.stringify({
      phone: phone,
      name: name,
      serverSpinNumber: resp.spinNumber || 1,
      firstSpin: !!resp.firstSpin
    }));

    drawWheel(GIFTS.filter(g => g.tier !== 'E'));
    enableWheelUI();
    submitBtn.innerText = '√áarx hazƒ±rdƒ±r';
    submitBtn.disabled = false;
    submitBtn.classList.remove('disabled');
  } catch (err) {
    console.error(err);
    alert('Server il…ô …ôlaq…ô zamanƒ± x…ôta ba≈ü verdi');
    submitBtn.disabled = false;
    submitBtn.classList.remove('disabled');
    submitBtn.innerText = 'Qatƒ±l v…ô ≈ûansƒ±nƒ± Yoxla';
  }
});

/* ===========================
Consolidated spin handler (first-3-spins deterministic)
=========================== */

spinBtn.addEventListener('click', async function() {
  if (spinBtn.disabled || isSpinning) return;
  const sessRaw = sessionStorage.getItem('brendimo_current');
  if (!sessRaw) { alert('∆èvv…ôlc…ô formu doldurun v…ô g√∂nd…ôrin'); return; }
  const sess = JSON.parse(sessRaw);
  const phone = sess.phone;
  const name = sess.name;

  disableWheelUI();
  const pool = lastRenderedPool.length ? lastRenderedPool : GIFTS.slice();

  // Determine which spin of the day this will be using local history
  const localTodayCount = getLocalSpinsToday(phone);
  const nextSpinToday = (localTodayCount || 0) + 1;
  if (localTodayCount >= 3) {
    alert("Bu g√ºn √º√ß√ºn √∂d…ôni≈üsiz √ßarx ≈üansƒ±nƒ± artƒ±q istifad…ô etdiniz.");
    enableWheelUI();
    return;
  }
  let selected;
  if (nextSpinToday === 1) {
    selected = GIFTS.find(g => g.tier === 'F' && /Qazanmad/i.test(g.name)) || { id: 'F3', name: '3 AZN Endirim', tier: 'F', weight: 0 };
  } else if (nextSpinToday === 2) {
    selected = GIFTS.find(g => g.name && /1 AZN qazandƒ±n!/i.test(g.name)) || { id: 'F1', name: '1 AZN qazandƒ±n!', tier: 'B', weight: 0 };
  } else if (nextSpinToday === 3) {
    const choices = ['Qadƒ±n bralok', 'Alƒ±≈üqan', 'Klassik Bralok','Ma≈üƒ±n aksesuarƒ± -it','Ma≈üƒ±n aksesuarƒ± pi≈üik','Curren ki≈üi saatƒ± ‚Äì Model 1','Curren ki≈üi saatƒ± ‚Äì Model 2','Curren ki≈üi saatƒ± ‚Äì Model 3','Casio qadƒ±n saatƒ± ‚Äì Model 1','Casio qadƒ±n saatƒ± ‚Äì Model 2','Curren ki≈üi saatƒ± - Model 4','Emporio Armani ki≈üi saatƒ±','Ki≈üi qƒ±zƒ±lƒ± boyunbaƒüƒ±','Ki≈üi qƒ±zƒ±lƒ± qolbaq'];
    const choiceName = choices[Math.floor(Math.random() * choices.length)];
    selected = GIFTS.find(g => g.name === choiceName) || { id: 'C3_special_' + choiceName.replace(/\s+/g,'_'), name: choiceName, tier: 'C', weight: 0 };
  } else {
    selected = weightedRandomPick(false);
  }

  let targetIndex = pool.findIndex(item => item.id === selected.id);
  let tempAdded = false;
  if (targetIndex < 0) {
    pool.push(selected);
    targetIndex = pool.length - 1;
    tempAdded = true;
  }

  try { const s = document.getElementById('sfx-spin'); if (s) { s.currentTime = 0; s.play(); } } catch(e){}

  spinToIndex(targetIndex, pool, async function() {
    // update session counter locally
    sessionStorage.setItem('brendimo_current', JSON.stringify({
      phone: phone,
      name: name,
      serverSpinNumber: (sess.serverSpinNumber || 1) + 1,
      firstSpin: false
    }));

    const payload = {
      action: 'log',
      name: name,
      phone: phone,
      spinNumber: (sess.serverSpinNumber || 1),
      giftName: selected.name,
      tier: selected.tier
    };

    try {
      const resp = await postToApi(payload);
      console.log('LOG response from server:', resp);

      // Save into local state (for history and counting)
      let state = loadState(phone) || { phone, name, spins: [], extraSpins: 0 };
      const nowIso = new Date().toISOString();
      state.spins = state.spins || [];
      state.spins.push({
        date: nowIso,
        spinNumber: resp && resp.spinNumber ? resp.spinNumber : (sess.serverSpinNumber || 1),
        giftId: selected.id,
        giftName: selected.name,
        tier: selected.tier
      });
      saveState(phone, state);
      renderHistory(state);

      try { burstConfetti(); const winSfx = document.getElementById('sfx-win'); if (winSfx) winSfx.play(); } catch (e) {}

      // Show customized modal variant based on the spin number of the day we used
      showResultModalWithSpinNumber(selected, resp, nextSpinToday);

      // Server controls actual allowedNextSpin; if allowed, re-enable
      if (resp && resp.allowedNextSpin) {
        enableWheelUI();
        drawWheel(GIFTS.filter(g => g.tier !== 'E'));
      } else {
        disableWheelUI();
      }

      // Cleanup temporary pool addition
      if (tempAdded) {
        lastRenderedPool = GIFTS.filter(g => g.tier !== 'E').slice();
        drawWheel(lastRenderedPool);
      }
    } catch (err) {
      console.error('Log error', err);
      alert('Server…ô yazƒ±lark…ôn x…ôta oldu');
      enableWheelUI();
    }
  });
});

/* ===========================
Modal controls + custom modal variants
=========================== */

function showResultModalWithSpinNumber(selected, resp, spinNumberToday) {
  try {
    resultGiftEl.innerText = selected.name || (resp && resp.gift) || 'T…ô≈ü…ôkk√ºr edirik!';
    resultTierEl.innerText = ' ' + (selected.tier || (resp && resp.tier) || '');

    // Clear existing modal actions
    const modalActions = resultModal.querySelector('.modal-actions');
    modalActions.innerHTML = '';

    let instr = '';

    if (spinNumberToday === 1) {
      instr = '\n Ad…ôt…ôn √áarx, yalnƒ±z bir d…ôf…ô fƒ±rladƒ±lƒ±r. \n Bu g√ºn s…ôn…ô istisna edirik ‚Äî yenid…ôn √ßevir.\n';
      const retryBtn = document.createElement('button');
      retryBtn.className = 'btn primary';
      retryBtn.innerText = 'üëâ Yenid…ôn sƒ±na!';
      retryBtn.addEventListener('click', () => {
        closeResultModal();
        enableWheelUI();
      });
      modalActions.appendChild(retryBtn);
    } else if (spinNumberToday === 2) {
      instr = 'üî• 1 AZN Endirim qazandƒ±n! \n üíõ 1 AZN Endirimi q…ôbul et v…ô ya ba≈üqa bir h…ôdiyy…ô √º√ß√ºn √áarxƒ± √ßevir! \n';
      const takeBtn = document.createElement('button');
      takeBtn.className = 'btn';
      takeBtn.innerText = '1 AZN Endirimi G√∂t√ºr üí∏';
      takeBtn.addEventListener('click', () => {
        try {
          const sessRaw = sessionStorage.getItem('brendimo_current');
          if (sessRaw) {
            const sess = JSON.parse(sessRaw);
            const st = loadState(sess.phone) || { phone: sess.phone, name: sess.name, spins: [] };
            const last = st.spins && st.spins[st.spins.length - 1];
            if (last) last.taken = true;
            saveState(sess.phone, st);
          }
        } catch (e) { console.warn(e); }
        alert('üéâ T…ôbrikl…ôr! 1 AZN endirim qazandƒ±n! \n üí° 10 AZN beh √∂d…ô ‚Üí endirim avtomatik 6 AZN olsun! (Y…ôni 5 AZN d…ô …ôlav…ô qazanƒ±rsan) \n ‚è≥ Bonus yalnƒ±z 60 d…ôqiq…ô aktivdir. \n ‚úî √ñd…ôdiyin beh son √∂d…ôni≈üd…ôn √ßƒ±xƒ±lƒ±r.\n');
        closeResultModal();
      });
      const retryBtn = document.createElement('button');
      retryBtn.className = 'btn primary';
      retryBtn.innerText = 'N√∂vb…ôti h…ôdiyy…ô √º√ß√ºn √áevir';
      retryBtn.addEventListener('click', () => {
        closeResultModal();
        enableWheelUI();
      });
      modalActions.appendChild(takeBtn);
      modalActions.appendChild(retryBtn);
    } else if (spinNumberToday === 3) {
      instr = 'üî• T…ôbrikl…ôr! Son √ßarxda ' + selected.name + ' qazandƒ±n. ‚è≥ 60 d…ôqiq…ô …ôrzind…ô 10 AZN beh √∂d…ô, h…ôm ' + selected.name + ', h…ôm d…ô 3 AZN endirim qazan!, \n ‚úî √ñd…ôdiyin beh son √∂d…ôni≈üd…ôn √ßƒ±xƒ±lƒ±r. \n üéÄT…ôklif Limitlidir.\n';
      const okBtn = document.createElement('button');
      okBtn.className = 'btn primary';
      okBtn.innerText = 'Bitir';
      okBtn.addEventListener('click', () => closeResultModal());
      modalActions.appendChild(okBtn);
    } else {
      instr = (resp && resp.message) ? resp.message : '';
      const okBtn = document.createElement('button');
      okBtn.className = 'btn primary';
      okBtn.innerText = 'Bitir';
      okBtn.addEventListener('click', () => closeResultModal());
      modalActions.appendChild(okBtn);
    }

    resultInstructions.innerText = instr;

    resultModal.classList.remove('hidden');
    resultModal.style.display = 'flex';
    resultModal.style.zIndex = '99999';
    resultModal.style.opacity = '1';
    document.body.style.overflow = 'hidden';

    const focusable = resultModal.querySelectorAll('button, [tabindex]:not([tabindex="-1"])');
    if (focusable && focusable.length) focusable[0].focus();
  } catch (err) {
    console.error('Error showing modal', err);
  }
}

function closeResultModal() {
  resultModal.classList.add('hidden');
  resultModal.style.display = 'none';
  resultModal.style.opacity = '0';
  document.body.style.overflow = '';
}

closeModal.addEventListener('click', closeResultModal);
modalOk.addEventListener('click', closeResultModal);



/* ===========================
History rendering
=========================== */

function renderHistory(state) {
  historyList.innerHTML = '';
  if (!state || !state.spins || state.spins.length === 0) {
    const li = document.createElement('li');
    li.innerText = 'H…ôl…ô tarix√ß…ô yoxdur';
    historyList.appendChild(li);
    return;
  }
  for (let s of state.spins.slice().reverse()) {
    const li = document.createElement('li');
    li.innerText = `${new Date(s.date).toLocaleString()} ‚Äî ${s.giftName} [${s.tier}] (√áarx #${s.spinNumber})`;
    historyList.appendChild(li);
  }
}

/* ===========================
Engagement: confetti + SFX hooks
=========================== */

function burstConfetti() {
  try {
    const count = 40;
    for (let i=0;i<count;i++){
      const el = document.createElement('div');
      el.className = 'confetti-piece';
      el.style.left = (50 + (Math.random()-0.5)*40) + '%';
      el.style.top = '10%';
      el.style.background = ['#ffd166','#ef476f','#06d6a0','#118ab2'][Math.floor(Math.random()*4)];
      el.style.position = 'fixed';
      el.style.width = '10px';
      el.style.height = '16px';
      el.style.borderRadius = '3px';
      el.style.pointerEvents = 'none';
      el.style.zIndex = 999999;
      document.body.appendChild(el);
      const dur = 1400 + Math.random()*800;
      el.animate([
        { transform: `translateY(0) rotate(${Math.random()*360}deg)`, opacity: 1 },
        { transform: `translateY(${300 + Math.random()*300}px) rotate(${Math.random()*720}deg)`, opacity: 0 }
      ], { duration: dur, easing: 'cubic-bezier(.15,.8,.25,1)'});
      setTimeout(()=> el.remove(), dur+60);
    }
  } catch(e){ console.warn(e); }
}

/* ===========================
Responsive canvas resize
=========================== */

window.addEventListener('resize', () => {
  const minSize = Math.min(window.innerWidth, window.innerHeight) * 0.9;
  const size = minSize;
  wheelCanvas.width = size * devicePixelRatio;
  wheelCanvas.height = size * devicePixelRatio;
  const canvasSize = size * devicePixelRatio;
  center = { x: wheelCanvas.width / 2, y: wheelCanvas.height / 2 };
  radius = canvasSize / 2 - 20;
  ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
  drawWheel(lastRenderedPool.length ? lastRenderedPool : GIFTS.filter(g => g.tier !== 'E'));
});

// Run once on load
window.dispatchEvent(new Event('resize'));

/* ===========================
On load: render last local history
=========================== */

(function tryLoadLast() {
  const cur = sessionStorage.getItem('brendimo_current');
  if (cur) {
    try {
      const sess = JSON.parse(cur);
      const s = loadState(sess.phone);
      if (s) { renderHistory(s); return; }
    } catch (e) {}
  }
  for (let i = localStorage.length - 1; i >= 0; i--) {
    const key = localStorage.key(i);
    if (key && key.startsWith('brendimo_state_')) {
      try {
        const state = JSON.parse(localStorage.getItem(key));
        if (state && state.phone) {
          renderHistory(state);
          break;
        }
      } catch (e) { continue; }
    }
  }
})();

/* End of script.js */
</script>
</body>
</html>
