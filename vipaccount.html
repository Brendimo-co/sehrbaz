<!doctype html>
<html lang="az">
<head>
  <meta property="og:image" content="https://github.com/Brendimo-co/sanscarxi/blob/main/unnamed.jpg?raw=true" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="theme-color" content="#0f172a" />
  <link rel="icon" type="image/png" href="/favicon.png">
  <title>Brendimo H…ôdiyy…ô √áarxƒ±</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800;900&display=swap" rel="stylesheet">

  <style>
    /* --------------------------------------------------
       BRENDIMO PREMIUM UI SYSTEM
       Focus: Depth, Glow, Glassmorphism, Fluid Motion
       --------------------------------------------------
    */

    :root {
      --font-main: 'Outfit', sans-serif;
      
      /* Dark Theme Palette */
      --bg-dark: #020617; /* Slate 950 */
      --bg-card: rgba(15, 23, 42, 0.6);
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-highlight: rgba(255, 255, 255, 0.05);
      
      /* Brand Accents */
      --primary: #F59E0B; /* Amber */
      --primary-glow: #D97706;
      --accent-pink: #EC4899; /* Pink 500 */
      --accent-purple: #8B5CF6; /* Violet 500 */
      --success: #10B981;
      
      /* Dimensions */
      --wheel-size: min(90vw, 480px);
      --ease-elastic: cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      padding: 0;
      width: 100%;
      min-height: 100vh;
      font-family: var(--font-main);
      background-color: var(--bg-dark);
      color: #F8FAFC;
      overflow-x: hidden;
      /* Animated Deep Background */
      background-image: 
        radial-gradient(circle at 15% 50%, rgba(139, 92, 246, 0.15), transparent 25%), 
        radial-gradient(circle at 85% 30%, rgba(236, 72, 153, 0.15), transparent 25%);
      background-attachment: fixed;
    }

    /* Floating Particles Background Animation */
    @keyframes floatBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* Container */
    .app-container {
      max-width: 600px;
      margin: 0 auto;
      padding: max(20px, env(safe-area-inset-top)) 20px 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
    }

    /* Header */
    .brand-header {
      text-align: center;
      margin-bottom: 24px;
      position: relative;
    }

    .brand-header h1 {
      font-weight: 800;
      font-size: 1.6rem;
      background: linear-gradient(135deg, #FFF 0%, #cbd5e1 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0 0 8px 0;
      letter-spacing: -0.5px;
      text-shadow: 0 10px 20px rgba(0,0,0,0.5);
    }

    .brand-header p {
      color: #94A3B8;
      font-size: 0.95rem;
      font-weight: 300;
      margin: 0;
      line-height: 1.5;
    }

    /* Glass Cards */
    .glass-card {
      background: var(--bg-card);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 24px;
      width: 100%;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      position: relative;
      overflow: hidden;
    }
    
    /* Shine effect on cards */
    .glass-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    }

    /* Form Inputs */
    .form-group { margin-bottom: 16px; position: relative; }
    
    .form-group label {
      display: block;
      color: #94A3B8;
      font-size: 0.85rem;
      margin-bottom: 6px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .input-wrapper {
      position: relative;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 14px;
      border: 1px solid var(--glass-border);
      transition: all 0.3s ease;
    }

    .input-wrapper:focus-within {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.15);
      background: rgba(0, 0, 0, 0.4);
    }

    input[type="text"] {
      width: 100%;
      padding: 14px 16px;
      background: transparent;
      border: none;
      color: #FFF;
      font-size: 1rem;
      font-family: var(--font-main);
      outline: none;
    }

    input::placeholder { color: #475569; }

    /* Buttons */
    .btn {
      width: 100%;
      border: none;
      border-radius: 16px;
      padding: 16px;
      font-family: var(--font-main);
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: all 0.2s var(--ease-elastic);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }

    .btn:active { transform: scale(0.96); }

    .btn.primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-glow) 100%);
      color: #0F172A;
      box-shadow: 0 4px 0 #92400e, 0 10px 20px rgba(245, 158, 11, 0.3);
    }
    
    .btn.primary:disabled {
      filter: grayscale(1);
      opacity: 0.6;
      box-shadow: none;
      cursor: not-allowed;
    }

    /* Wheel Section */
    .wheel-container {
      position: relative;
      width: var(--wheel-size);
      height: var(--wheel-size);
      margin: 32px 0;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* The outer glow ring */
    .wheel-glow {
      position: absolute;
      inset: -10px;
      background: radial-gradient(circle, transparent 50%, rgba(245, 158, 11, 0.15) 70%);
      border-radius: 50%;
      z-index: 0;
      animation: pulseGlow 3s infinite ease-in-out;
    }

    @keyframes pulseGlow {
      0%, 100% { opacity: 0.5; transform: scale(0.95); }
      50% { opacity: 1; transform: scale(1.02); }
    }

    .wheel-wrap {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      position: relative;
      z-index: 1;
      box-shadow: 0 20px 50px rgba(0,0,0,0.8), inset 0 0 20px rgba(0,0,0,0.5);
      border: 4px solid rgba(255,255,255,0.05);
      transition: filter 0.3s;
    }

    .wheel-wrap.inactive { filter: grayscale(0.8) brightness(0.7); }

    #wheelCanvas {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      transform: rotate(0deg); /* Initial */
    }

    /* The Stopper / Pointer */
    .wheel-pointer {
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 55px;
      z-index: 10;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
    }
    
    .wheel-pointer svg {
      width: 100%;
      height: 100%;
      fill: #EC4899; /* Hot Pink */
      stroke: #fff;
      stroke-width: 2px;
    }

    /* Spin Button (Center) */
    .spin-btn-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ec4899, #be185d);
      border: 4px solid #FFF;
      color: #FFF;
      font-weight: 900;
      font-size: 14px;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 20;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(236, 72, 153, 0.5);
      text-transform: uppercase;
      transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .spin-btn-center:active { transform: translate(-50%, -50%) scale(0.9); }
    .spin-btn-center:disabled { background: #475569; border-color: #94A3B8; box-shadow: none; cursor: not-allowed; }

    /* History */
    .history-card { margin-top: 20px; min-height: 140px; }
    .history-card h3 { font-size: 1rem; margin: 0 0 12px 0; color: #E2E8F0; display: flex; align-items: center; gap: 8px; }
    
    .history-list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 180px;
      overflow-y: auto;
    }
    
    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      margin-bottom: 8px;
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      font-size: 0.85rem;
      border: 1px solid transparent;
    }
    
    .history-item.win { border-color: rgba(16, 185, 129, 0.3); background: rgba(16, 185, 129, 0.05); }

    .tier-badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 800;
      text-transform: uppercase;
      background: #334155;
      color: #94A3B8;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.9);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: none; /* Flex when active */
      justify-content: center;
      align-items: center;
      padding: 20px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .modal-overlay.active { display: flex; opacity: 1; }

    .modal-box {
      background: #0F172A;
      border: 1px solid rgba(255,255,255,0.1);
      width: 100%;
      max-width: 400px;
      border-radius: 24px;
      padding: 32px 24px;
      text-align: center;
      position: relative;
      transform: translateY(20px);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 50px 100px -20px rgba(0,0,0,0.8);
    }
    
    .modal-overlay.active .modal-box { transform: translateY(0); }

    .modal-icon { font-size: 3rem; margin-bottom: 16px; display: block; }
    .modal-title { font-size: 1.5rem; margin: 0 0 8px 0; color: #FFF; }
    .modal-gift { font-size: 1.25rem; font-weight: 700; color: var(--primary); margin: 0 0 4px 0; }
    .modal-text { color: #94A3B8; font-size: 0.9rem; margin-bottom: 24px; line-height: 1.6; }
    
    .close-modal-x {
      position: absolute;
      top: 16px;
      right: 16px;
      background: transparent;
      border: none;
      color: #475569;
      font-size: 24px;
      cursor: pointer;
    }

    /* Confetti (CSS Only for simple, JS will add complex) */
    .confetti-piece {
      position: fixed;
      width: 10px; height: 16px;
      background: #ffd166;
      top: -20px;
      z-index: 9999;
      pointer-events: none;
    }

    /* Utilities */
    .hidden { display: none !important; }
    .text-sm { font-size: 0.8rem; color: #64748B; margin-top: 8px; display: block; text-align: center; }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

  </style>
</head>
<body>

  <main class="app-container">
    
    <header class="brand-header">
      <h1 id="main-title">Brendimo</h1>
      <p id="main-subtitle">H…ôr fƒ±rlanƒ±≈üda yeni bir m√∂c√ºz…ô...</p>
    </header>

    <section class="glass-card" id="formSection">
      <form id="entryForm" autocomplete="off">
        <div class="form-group">
          <label for="fullName">Ad v…ô Soyad</label>
          <div class="input-wrapper">
            <input id="fullName" name="fullName" type="text" placeholder="Adƒ±nƒ±z" required />
          </div>
        </div>

        <div class="form-group">
          <label for="phone">WhatsApp N√∂mr…ôsi</label>
          <div class="input-wrapper">
            <input id="phone" name="phone" type="text" placeholder="050 123 45 67" required />
          </div>
        </div>

        <button id="submitBtn" type="submit" class="btn primary">
          <span>üöÄ B…ôxtini Sƒ±na</span>
        </button>
        <small class="text-sm">G√ºn …ôrzind…ô 3 ≈üans (√ñd…ôni≈üsiz)</small>
      </form>
    </section>

    <section class="wheel-container">
      <div class="wheel-glow"></div>
      
      <div class="wheel-pointer">
        <svg viewBox="0 0 50 55" xmlns="http://www.w3.org/2000/svg">
           <path d="M25 55L5 20C2 15 5 0 25 0C45 0 48 15 45 20L25 55Z" />
        </svg>
      </div>

      <div id="wheelWrap" class="wheel-wrap inactive">
        <canvas id="wheelCanvas"></canvas>
        <button id="spinBtn" class="spin-btn-center" disabled>√áEVƒ∞R</button>
      </div>
    </section>

    <section class="glass-card history-card">
      <h3>
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        Tarix√ß…ô
      </h3>
      <ul id="historyList" class="history-list">
        </ul>
    </section>

  </main>

  <div id="resultModal" class="modal-overlay" role="dialog" aria-modal="true">
    <div class="modal-box">
      <button id="closeModal" class="close-modal-x">√ó</button>
      <span class="modal-icon">üéÅ</span>
      <h2 id="resultTitle" class="modal-title">T…ô≈ü…ôkk√ºr edirik!</h2>
      <p id="resultGift" class="modal-gift"></p>
      <p id="resultTier" class="tier-badge hidden"></p>
      
      <div id="resultInstructions" class="modal-text"></div>
      
      <div id="modalActions" style="display:flex; flex-direction:column; gap:10px;">
        <button id="modalOk" class="btn primary">∆èla, Bitir</button>
      </div>
    </div>
  </div>

  <audio id="sfx-spin" preload="auto" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio> 
  <script>
/* --------------------------------------------------
   LOGIC CORE
   Strict retention of all business logic, API calls,
   and deterministic winning rules.
   --------------------------------------------------
*/

/* --- CONFIG --- */
const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbzwgkr3AN5u0nAelm-0qJZxrFvFRgj2cZtIbUpMl7Q7BzKdHvjkporVg6-Cs0PyKB8vHA/exec";

/* --- DOM --- */
const form = document.getElementById('entryForm');
const fullNameInput = document.getElementById('fullName');
const phoneInput = document.getElementById('phone');
const submitBtn = document.getElementById('submitBtn');
const wheelWrap = document.getElementById('wheelWrap');
const wheelCanvas = document.getElementById('wheelCanvas');
const spinBtn = document.getElementById('spinBtn');
const historyList = document.getElementById('historyList');
const resultModal = document.getElementById('resultModal');
const resultGiftEl = document.getElementById('resultGift');
const resultTierEl = document.getElementById('resultTier');
const resultInstructions = document.getElementById('resultInstructions');
const closeModal = document.getElementById('closeModal');
const modalOk = document.getElementById('modalOk');
const resultTitle = document.getElementById('resultTitle');
const modalActions = document.getElementById('modalActions');

/* --- GIFTS DATA --- */
const GIFTS = [
  { id: 'A1', name: '100 AZN H…ôdiyy…ô', tier: 'A', weight: 0.000, color: '#F59E0B' },
  { id: 'A2', name: '15 AZN Endirim', tier: 'A', weight: 0.000, color: '#3B82F6' },
  { id: 'A3', name: '50 AZN H…ôdiyy…ô', tier: 'A', weight: 0.000, color: '#EC4899' },
  
  { id: 'D1', name: 'Qazanmadƒ±nƒ±z', tier: 'D', weight: 13.995, color: '#64748B' },
  { id: 'B1', name: 'Premium Parf√ºm', tier: 'B', weight: 0.495, color: '#8B5CF6' },
  { id: 'B2', name: 'Qalstuk D…ôsti', tier: 'B', weight: 0.000, color: '#6366F1' },
  { id: 'B3', name: 'Premium K…ôm…ôr', tier: 'B', weight: 0.000, color: '#10B981' },
  
  { id: 'F1', name: '3 AZN Endirim!', tier: 'F', weight: 17.495, color: '#10B981' },
  
  { id: 'F2', name: 'Premium Ka≈üelok', tier: 'F', weight: 0.000, color: '#F59E0B' },
  { id: 'F3', name: '1 AZN Endirim', tier: 'F', weight: 0.000, color: '#EC4899' },
  
  { id: 'C1', name: '√úr…ôk Bralok', tier: 'C', weight: 1, color: '#3B82F6' },
  { id: 'C2', name: 'Ka≈üelok', tier: 'C', weight: 1, color: '#8B5CF6' },
  { id: 'C3', name: 'K…ôm…ôr', tier: 'C', weight: 1, color: '#6366F1' },
  { id: 'C4', name: 'Qolbaq', tier: 'A', weight: 1, color: '#F59E0B' },

  { id: 'C5', name: 'Saat', tier: 'A', weight: 1, color: '#EC4899' },
  { id: 'C6', name: 'Qadƒ±n bralok', tier: 'A', weight: 1, color: '#10B981' },
  { id: 'C7', name: 'Alƒ±≈üqan', tier: 'B', weight: 1, color: '#3B82F6' },
  { id: 'C8', name: 'LetterCharm', tier: 'B', weight: 1, color: '#8B5CF6' },
  { id: 'C9', name: 'G√∂z Muncuƒüu', tier: 'B', weight: 1, color: '#F59E0B' },
  { id: 'C10', name: 'Klassik Bralok', tier: 'F', weight: 1, color: '#64748B' },
  { id: 'C11', name: 'Ma≈üƒ±n Aks. (it)', tier: 'F', weight: 1, color: '#6366F1' },
  { id: 'C12', name: 'Ma≈üƒ±n Aks. (pi≈üik)', tier: 'F', weight: 1, color: '#EC4899' },
  { id: 'C13', name: 'Curren M1', tier: 'C', weight: 1, color: '#10B981' },
  { id: 'C14', name: 'Curren M2', tier: 'C', weight: 1, color: '#3B82F6' },
  { id: 'C15', name: 'Curren M3', tier: 'C', weight: 1, color: '#8B5CF6' },
  { id: 'C16', name: 'Casio Qadƒ±n M1', tier: 'A', weight: 1, color: '#F59E0B' },
  { id: 'C17', name: 'Casio Qadƒ±n M2', tier: 'A', weight: 1, color: '#EC4899' },
  { id: 'C18', name: 'Curren M4', tier: 'A', weight: 1, color: '#6366F1' },
  { id: 'C19', name: 'Armani Saat', tier: 'B', weight: 1, color: '#10B981' },
  { id: 'C20', name: 'Ki≈üi Boyunbaƒüƒ±', tier: 'B', weight: 1, color: '#3B82F6' },
  { id: 'C21', name: 'Ki≈üi Qolbaq', tier: 'B', weight: 1, color: '#8B5CF6' },
  { id: 'C22', name: 'Parf√ºm', tier: 'F', weight: 1, color: '#F59E0B' }
];

/* --- INIT --- */
const now = new Date();
const hours = now.getHours();
const minutes = now.getMinutes().toString().padStart(2, '0');
document.getElementById('main-title').textContent = `Brendimo`; 
document.getElementById('main-subtitle').textContent = `Saat ${hours}:${minutes}. Xo≈ü niy…ôt tut, Hiss et v…ô √áarxƒ± √áevir! ‚ú®`;

function sanitizePhone(raw) {
  let s = (raw || '').trim();
  s = s.replace(/[^\d+]/g, '');
  if (s.startsWith('00')) s = '+' + s.slice(2);
  if (!s.startsWith('+') && /^\d{9}$/.test(s)) s = '+994' + s;
  if (/^0\d{9}$/.test(s)) s = '+994' + s.slice(1);
  return s;
}

function stateKey(phone) { return `brendimo_state_${phone}`; }

function loadState(phone) {
  try {
    const raw = localStorage.getItem(stateKey(phone));
    return raw ? JSON.parse(raw) : null;
  } catch (e) { return null; }
}

function saveState(phone, state) {
  localStorage.setItem(stateKey(phone), JSON.stringify(state));
}

function getLocalSpinsToday(phone) {
  const state = loadState(phone);
  if (!state || !state.spins || !state.spins.length) return 0;
  const today = new Date().toISOString().slice(0, 10);
  return state.spins.filter(s => (s.date || '').slice(0, 10) === today).length;
}

function weightedRandomPick(allowE = false) {
  const pool = GIFTS.filter(g => allowE ? true : g.tier !== 'E');
  const totalWeight = pool.reduce((s, x) => s + Number(x.weight || 0), 0);
  if (totalWeight <= 0) return pool[Math.floor(Math.random() * pool.length)];
  
  const r = Math.random() * totalWeight;
  let acc = 0;
  for (let i = 0; i < pool.length; i++) {
    acc += Number(pool[i].weight);
    if (r <= acc) return pool[i];
  }
  return pool[pool.length - 1];
}

/* --- CANVAS & RENDERING (Upgraded Visuals) --- */
const ctx = wheelCanvas.getContext("2d");
let currentRotation = 0;
let isSpinning = false;
let lastRenderedPool = [];
let center = { x: 0, y: 0 };
let radius = 0;

// Dynamic Palette Generator if color is missing
function getColorForIndex(i, total) {
  const colors = ['#F59E0B', '#EC4899', '#3B82F6', '#8B5CF6', '#10B981'];
  return colors[i % colors.length];
}

function resizeAndDraw() {
  const wrapRect = wheelWrap.getBoundingClientRect();
  const size = wrapRect.width; 
  const dpr = window.devicePixelRatio || 1;
  
  wheelCanvas.width = size * dpr;
  wheelCanvas.height = size * dpr;
  
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  center = { x: size / 2, y: size / 2 };
  radius = (size / 2) - 10; // Padding
  
  drawWheel(lastRenderedPool.length ? lastRenderedPool : GIFTS.filter(g => g.tier !== 'E'));
}

window.addEventListener('resize', () => requestAnimationFrame(resizeAndDraw));
window.addEventListener('load', () => { setTimeout(resizeAndDraw, 100); });

function drawWheel(pool) {
  lastRenderedPool = pool.slice();
  ctx.clearRect(0, 0, wheelCanvas.width / (window.devicePixelRatio||1), wheelCanvas.height / (window.devicePixelRatio||1));
  
  const total = pool.length || 1;
  const slice = (Math.PI * 2) / total;

  // Draw Slices
  for (let i = 0; i < total; i++) {
    const start = i * slice;
    const end = start + slice;
    const item = pool[i];
    
    // Create gradient for slice for 3D effect
    const baseColor = item.color || getColorForIndex(i, total);
    
    ctx.save();
    ctx.beginPath();
    ctx.moveTo(center.x, center.y);
    ctx.arc(center.x, center.y, radius, start + currentRotation, end + currentRotation);
    ctx.closePath();
    
    // Gradient Fill
    const grad = ctx.createRadialGradient(center.x, center.y, 10, center.x, center.y, radius);
    grad.addColorStop(0, shadeColor(baseColor, 20)); // Lighter center
    grad.addColorStop(1, baseColor); // Normal edge
    
    ctx.fillStyle = grad;
    ctx.fill();
    
    // Stroke for separation
    ctx.lineWidth = 1;
    ctx.strokeStyle = "rgba(255,255,255,0.2)";
    ctx.stroke();

    // Text
    ctx.translate(center.x, center.y);
    const angle = start + slice / 2 + currentRotation;
    ctx.rotate(angle);
    ctx.textAlign = 'right';
    ctx.fillStyle = '#fff';
    ctx.shadowColor = "rgba(0,0,0,0.8)";
    ctx.shadowBlur = 4;
    ctx.font = `bold ${Math.max(12, radius * 0.07)}px 'Outfit', sans-serif`;
    
    // Truncate long text
    let text = item.name || '';
    if(text.length > 15) text = text.substring(0, 14) + '..';
    
    ctx.fillText(text, radius - 20, 5);
    ctx.restore();
  }
}

// Utility for gradient generation
function shadeColor(color, percent) {
    var R = parseInt(color.substring(1,3),16);
    var G = parseInt(color.substring(3,5),16);
    var B = parseInt(color.substring(5,7),16);

    R = parseInt(R * (100 + percent) / 100);
    G = parseInt(G * (100 + percent) / 100);
    B = parseInt(B * (100 + percent) / 100);

    R = (R<255)?R:255;  
    G = (G<255)?G:255;  
    B = (B<255)?B:255;  

    var RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
    var GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
    var BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));

    return "#"+RR+GG+BB;
}

function degreesToRadians(d) { return d * Math.PI / 180; }
function radiansToDegrees(r) { return r * 180 / Math.PI; }

/* --- SPIN ANIMATION --- */
function spinToIndex(selectedIndex, pool, cb) {
  if (isSpinning) return;
  isSpinning = true;
  spinBtn.disabled = true;
  
  // Haptic start
  if(navigator.vibrate) navigator.vibrate(50);
  
  const total = pool.length || 1;
  const slice = (360 / total);
  // Center of the target slice
  const sectorCenterDeg = selectedIndex * slice + slice / 2;
  
  // Calculate target: spin at least 5 times (360*5)
  // Align 270 degrees (top in canvas context with 0 at right) to the sector center
  let targetDeg = 360 * 5 + (270 - sectorCenterDeg);
  
  // Add randomness to land somewhere inside the slice, not dead center
  // +/- 40% of slice width
  const randomOffset = (Math.random() - 0.5) * (slice * 0.8);
  targetDeg += randomOffset;

  const startDeg = radiansToDegrees(currentRotation);
  const duration = 5000; // 5 seconds
  const start = performance.now();

  function step(now) {
    const t = Math.min(1, (now - start) / duration);
    // Quintic Ease Out for premium feel
    const eased = 1 - Math.pow(1 - t, 5); 
    
    const newDeg = startDeg + (targetDeg - startDeg) * eased;
    currentRotation = degreesToRadians(newDeg);
    drawWheel(pool);
    
    if (t < 1) {
      requestAnimationFrame(step);
    } else {
      currentRotation = degreesToRadians(targetDeg % 360);
      drawWheel(pool);
      isSpinning = false;
      if(navigator.vibrate) navigator.vibrate([100, 50, 100]); // Success Vibe
      cb && cb();
    }
  }
  requestAnimationFrame(step);
}

/* --- LOGIC FLOW --- */

function enableWheelUI() {
  wheelWrap.classList.remove('inactive');
  spinBtn.disabled = false;
  spinBtn.textContent = "√áEVƒ∞R";
  if(form.style.display !== 'none') {
      // Smooth scroll to wheel
      wheelWrap.scrollIntoView({behavior: 'smooth', block: 'center'});
  }
}

function disableWheelUI() {
  wheelWrap.classList.add('inactive');
  spinBtn.disabled = true;
}

// Initial draw
lastRenderedPool = GIFTS.slice();
setTimeout(resizeAndDraw, 500);

/* API CLIENT */
async function postToApi(data) {
  try {
    const res = await fetch(API_ENDPOINT, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (!res.ok) throw new Error('Non-OK response');
    const text = await res.text();
    try { return JSON.parse(text); } catch (e) { throw new Error('Invalid JSON'); }
  } catch (err) {
    // JSONP Fallback
    console.warn('Fallback to JSONP');
    const params = Object.assign({}, data);
    const qs = Object.keys(params).map(k => encodeURIComponent(k) + '=' + encodeURIComponent(String(params[k]||''))).join('&');
    const cbName = 'brendimo_cb_' + Math.random().toString(36).slice(2,9);
    const url = API_ENDPOINT + (qs ? ('?' + qs + '&') : '?') + 'callback=' + cbName;
    return new Promise((resolve, reject) => {
      window[cbName] = (resp) => { delete window[cbName]; resolve(resp); };
      const script = document.createElement('script');
      script.src = url;
      document.body.appendChild(script);
      setTimeout(() => reject('Timeout'), 10000);
    });
  }
}

/* HANDLERS */
form.addEventListener('submit', async function(e) {
  e.preventDefault();
  if (isSpinning) return;
  
  const name = fullNameInput.value.trim();
  const phoneRaw = phoneInput.value.trim();
  
  if(name.length < 2) { alert('Z…ôhm…ôt olmasa adƒ±nƒ±zƒ± tam daxil edin.'); return; }
  
  const phone = sanitizePhone(phoneRaw);
  if(!/^\+?[0-9]{9,15}$/.test(phone)) { alert('N√∂mr…ô d√ºzg√ºn deyil.'); return; }

  submitBtn.disabled = true;
  submitBtn.innerHTML = `<span>‚è≥ Yoxlanƒ±lƒ±r...</span>`;

  try {
    const resp = await postToApi({ action: 'check', name, phone });
    
    if (!resp || !resp.allowed) {
      alert(resp?.message || 'Bu g√ºn √º√ß√ºn limit bitib.');
      submitBtn.disabled = false;
      submitBtn.innerHTML = `<span>üöÄ B…ôxtini Sƒ±na</span>`;
      return;
    }

    // Success
    sessionStorage.setItem('brendimo_current', JSON.stringify({
      phone, name, 
      serverSpinNumber: resp.spinNumber || 1,
      firstSpin: !!resp.firstSpin
    }));

    // Hide form slightly to focus on wheel
    form.closest('.glass-card').style.opacity = '0.5';
    
    // Setup Wheel
    drawWheel(GIFTS.filter(g => g.tier !== 'E'));
    enableWheelUI();
    submitBtn.innerHTML = `<span>Aktivdir ‚úÖ</span>`;
    
  } catch (err) {
    console.error(err);
    alert('X…ôta ba≈ü verdi. ƒ∞nterneti yoxlayƒ±n.');
    submitBtn.disabled = false;
    submitBtn.innerHTML = `<span>üöÄ B…ôxtini Sƒ±na</span>`;
  }
});

spinBtn.addEventListener('click', async function() {
  if (spinBtn.disabled || isSpinning) return;
  
  const sessRaw = sessionStorage.getItem('brendimo_current');
  if (!sessRaw) return;
  const sess = JSON.parse(sessRaw);
  const { phone, name } = sess;

  disableWheelUI();
  
  // Logic: 1st, 2nd, 3rd spin determinism
  const localTodayCount = getLocalSpinsToday(phone);
  const nextSpinToday = localTodayCount + 1;
  
  if (localTodayCount >= 3) {
    alert("Bu g√ºnl√ºk ≈üansƒ±nƒ±z bitdi!");
    return;
  }

  let selected;
  // Rule enforcement
  if (nextSpinToday === 1) {
    selected = GIFTS.find(g => g.tier === 'F' && /Qazanmad/i.test(g.name)) || { id: 'F_Fail', name: 'Qazanmadƒ±nƒ±z', tier: 'F', weight:0, color:'#64748B' };
  } else if (nextSpinToday === 2) {
    selected = GIFTS.find(g => /3 AZN Endirim/i.test(g.name)) || { id: 'F_1AZN', name: '3 AZN Endirim!', tier: 'F', weight:0, color:'#10B981' };
  } else if (nextSpinToday === 3) {
    const choices = ['Qadƒ±n bralok', 'Alƒ±≈üqan', 'Klassik Bralok','Ma≈üƒ±n Aks. (it)','Ma≈üƒ±n Aks. (pi≈üik)','Curren M1','Curren M2','Curren M3','Casio Qadƒ±n M1','Casio Qadƒ±n M2','Curren M4','Armani Saat','Ki≈üi Boyunbaƒüƒ±','Ki≈üi Qolbaq'];
    const choiceName = choices[Math.floor(Math.random() * choices.length)];
    selected = GIFTS.find(g => g.name === choiceName) || { id: 'C_Special', name: choiceName, tier: 'C', weight: 0, color:'#F59E0B' };
  } else {
    selected = weightedRandomPick(false);
  }

  // Ensure selected item is in pool for visual correctness
  const pool = lastRenderedPool.length ? lastRenderedPool : GIFTS.filter(g => g.tier !== 'E');
  let tIdx = pool.findIndex(x => x.id === selected.id);
  
  // If not in visual pool (rare edge case), force it in
  if(tIdx < 0) {
    pool[Math.floor(Math.random()*pool.length)] = selected;
    tIdx = pool.findIndex(x => x.id === selected.id);
    drawWheel(pool);
  }

  // SPIN!
  spinToIndex(tIdx, pool, async function() {
    
    // Log to API
    const newSpinNum = (sess.serverSpinNumber || 1) + 1;
    sessionStorage.setItem('brendimo_current', JSON.stringify({ ...sess, serverSpinNumber: newSpinNum, firstSpin: false }));

    try {
      const resp = await postToApi({
        action: 'log', name, phone,
        spinNumber: sess.serverSpinNumber || 1,
        giftName: selected.name, tier: selected.tier
      });

      // Update Local State
      let state = loadState(phone) || { phone, name, spins: [] };
      state.spins.push({
        date: new Date().toISOString(),
        spinNumber: resp?.spinNumber || 1,
        giftName: selected.name, tier: selected.tier
      });
      saveState(phone, state);
      renderHistory(state);
      
      // Visuals
      burstConfetti();
      showResultModal(selected, resp, nextSpinToday);
      
      // Reset for next if allowed
      if (resp && resp.allowedNextSpin) {
        enableWheelUI();
      } else {
        disableWheelUI();
        spinBtn.textContent = "Bƒ∞TDƒ∞";
      }

    } catch (e) {
      console.error(e);
      alert('N…ôtic…ô qeyd…ô alƒ±nark…ôn x…ôta oldu, amma udu≈üunuz ekrandadƒ±r!');
    }
  });
});

/* --- MODAL LOGIC --- */
function showResultModal(selected, resp, spinNum) {
  resultGiftEl.textContent = selected.name;
  resultTierEl.textContent = selected.tier;
  resultTierEl.className = `tier-badge tier-${selected.tier}`; // Add color class logic later if needed
  resultTierEl.classList.remove('hidden');

  modalActions.innerHTML = '';
  let instr = '';

  if (spinNum === 1) {
    resultTitle.textContent = "B…ôxtini Yen…ô Sƒ±na!";
    resultGiftEl.style.color = "#94A3B8"; // Grey out loss
    instr = "Ad…ôt…ôn √ßarx 1 d…ôf…ô fƒ±rladƒ±lƒ±r. Amma bu g√ºn s…ôn…ô istisna edirik!";
    const b = document.createElement('button');
    b.className = 'btn primary';
    b.textContent = 'üëâ Yenid…ôn √áevir';
    b.onclick = () => { closeModalFn(); enableWheelUI(); };
    modalActions.appendChild(b);
  } else if (spinNum === 2) {
    resultTitle.textContent = "T…ôbrikl…ôr!";
    instr = "3 AZN Endirim qazandƒ±n! Bunu g√∂t√ºr…ô bil…ôrs…ôn v…ô ya daha b√∂y√ºk h…ôdiyy…ô √º√ß√ºn ≈üansƒ±nƒ± yenid…ôn yoxlaya bil…ôrs…ôn.";
    
    const takeBtn = document.createElement('button');
    takeBtn.className = 'btn';
    takeBtn.style.background = '#334155';
    takeBtn.style.color = '#fff';
    takeBtn.textContent = 'üí∞ 3 AZN G√∂t√ºr√ºr…ôm';
    takeBtn.onclick = () => {
        alert("üéâ 3 AZN endirim qeyd…ô alƒ±ndƒ±! (Beh √∂d…ôdikd…ô aktivl…ô≈üir)");
        closeModalFn();
    };
    
    const retryBtn = document.createElement('button');
    retryBtn.className = 'btn primary';
    retryBtn.textContent = 'üîÑ Yox! Yen…ô √áevir';
    retryBtn.onclick = () => { closeModalFn(); enableWheelUI(); };
    
    modalActions.appendChild(retryBtn); // Encourage spin
    modalActions.appendChild(takeBtn);
  } else {
    // Final spin
    resultTitle.textContent = "M√∂ht…ô≈ü…ôm!";
    instr = `T…ôbrikl…ôr! ${selected.name} qazandƒ±n. \n‚è≥ 60 d…ôqiq…ô …ôrzind…ô 10 AZN beh √∂d…ô, h…ôdiyy…ôni r…ôsmil…ô≈üdir!`;
    const b = document.createElement('button');
    b.className = 'btn primary';
    b.textContent = 'Baƒüla';
    b.onclick = closeModalFn;
    modalActions.appendChild(b);
  }
  
  resultInstructions.innerText = instr;
  resultModal.classList.add('active');
}

function closeModalFn() {
  resultModal.classList.remove('active');
}
closeModal.addEventListener('click', closeModalFn);
modalOk.addEventListener('click', closeModalFn);

/* --- HISTORY RENDER --- */
function renderHistory(state) {
  historyList.innerHTML = '';
  if (!state || !state.spins || !state.spins.length) {
    historyList.innerHTML = '<li style="text-align:center; color:#64748B; padding:10px;">H…ôl…ô tarix√ß…ô yoxdur</li>';
    return;
  }
  // Show reverse
  [...state.spins].reverse().forEach(s => {
    const li = document.createElement('li');
    li.className = 'history-item';
    if(s.tier !== 'D' && s.tier !== 'F' && !s.giftName.includes('Qazanmad')) li.classList.add('win');
    
    const time = new Date(s.date).toLocaleTimeString('az-AZ', {hour:'2-digit', minute:'2-digit'});
    
    li.innerHTML = `
      <span>
        <span style="color:#94A3B8; margin-right:6px; font-size:0.75rem">${time}</span>
        <strong>${s.giftName}</strong>
      </span>
      <span class="tier-badge">${s.tier || '-'}</span>
    `;
    historyList.appendChild(li);
  });
}

/* --- VISUAL EFFECTS --- */
function burstConfetti() {
  const colors = ['#F59E0B', '#EC4899', '#3B82F6'];
  for(let i=0; i<50; i++) {
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    el.style.left = Math.random() * 100 + 'vw';
    el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    el.style.animation = `dropConfetti ${1 + Math.random()}s linear forwards`;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 2000);
  }
}

// Add simple confetti animation style dynamically
const styleSheet = document.createElement("style");
styleSheet.innerText = `
@keyframes dropConfetti {
  0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}`;
document.head.appendChild(styleSheet);

/* --- AUTO LOAD HISTORY --- */
(function() {
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if(key.startsWith('brendimo_state_')) {
      renderHistory(JSON.parse(localStorage.getItem(key)));
      break; 
    }
  }
})();

</script>
</body>
</html>
