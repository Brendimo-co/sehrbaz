<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Brendimo Partner</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* --- 1. RESET & BASE STYLES --- */
* { margin: 0; padding: 0; box-sizing: border-box; font-family: "Inter", sans-serif; -webkit-tap-highlight-color: transparent; }
body { background: #f8f9fa; color: #1d1d1f; overflow-x: hidden; min-height: 100vh; padding-bottom: 80px; }

/* --- 2. HEADER --- */
.partner-header {
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(12px);
    padding: 15px 20px;
    position: sticky; top: 0; z-index: 100;
    border-bottom: 1px solid #eee;
    display: flex; justify-content: space-between; align-items: center;
    box-shadow: 0 2px 10px rgba(0,0,0,0.02);
}
.logo { font-size: 22px; font-weight: 800; color: #c21a1a; letter-spacing: -0.5px; }
.store-badge { font-size: 11px; background: #FFD700; color: #000; padding: 5px 10px; border-radius: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; display: none; }

/* --- 3. LAYOUT SECTIONS (Hidden by default) --- */
#login-section, #shop-container, #builder-controls, #intro-text { display: none; }

/* --- 4. LOGIN SCREEN --- */
.login-wrapper {
    flex-direction: column; align-items: center; justify-content: center;
    height: 85vh; padding: 25px; text-align: center;
}
.login-card {
    background: white; padding: 40px 30px; border-radius: 28px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.08); width: 100%; max-width: 420px;
    transition: transform 0.3s ease;
}
.input-field {
    width: 100%; padding: 18px; border: 2px solid #f0f0f0; border-radius: 16px;
    font-size: 16px; margin: 25px 0; outline: none; transition: all 0.3s;
    background: #fafafa; color: #333;
}
.input-field:focus { border-color: #c21a1a; background: #fff; }
.btn-primary {
    width: 100%; padding: 18px; background: #c21a1a; color: white;
    border: none; border-radius: 16px; font-size: 16px; font-weight: 700;
    cursor: pointer; box-shadow: 0 8px 25px rgba(194, 26, 26, 0.25);
    transition: transform 0.2s, box-shadow 0.2s;
}
.btn-primary:active { transform: scale(0.97); box-shadow: 0 4px 15px rgba(194, 26, 26, 0.2); }

/* --- 5. PROFESSIONAL PRODUCT GRID --- */
.grid-container {
    display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; /* 2 Columns */
    padding: 16px; max-width: 800px; margin: 0 auto;
}
@media (min-width: 600px) { .grid-container { grid-template-columns: repeat(3, 1fr); } } /* Tablet/PC */

/* --- 6. PROFESSIONAL PRODUCT CARD --- */
.product-card {
    background: white; border-radius: 20px; overflow: hidden;
    box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05);
    position: relative; transition: transform 0.2s, box-shadow 0.2s;
    display: flex; flex-direction: column;
    height: 100%;
    border: 1px solid rgba(0,0,0,0.02);
}
.product-card:active { transform: scale(0.98); }

/* Image Area */
.card-img-wrapper {
    position: relative;
    width: 100%;
    padding-top: 100%; /* 1:1 Aspect Ratio (Square) */
    background: #f4f4f4;
    overflow: hidden;
}
.card-img-wrapper img {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    object-fit: cover; transition: transform 0.5s ease;
}

/* Info Area */
.card-content { padding: 14px; flex: 1; display: flex; flex-direction: column; }
.card-title { 
    font-size: 14px; font-weight: 700; color: #1a1a1a; margin-bottom: 6px;
    line-height: 1.3;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; /* Limit to 2 lines */
}
.card-desc {
    font-size: 11px; color: #888; line-height: 1.4; margin-bottom: 12px;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; /* Limit to 2 lines */
    flex-grow: 1; /* Pushes price down */
}
.card-footer { display: flex; align-items: flex-end; justify-content: space-between; margin-top: auto; }
.card-price { color: #c21a1a; font-weight: 800; font-size: 16px; }

/* Buy Button (Small & Clean) */
.btn-buy-sm {
    background: #25D366; color: white; border: none; padding: 8px 12px;
    border-radius: 10px; font-weight: 700; font-size: 12px;
    display: flex; align-items: center; gap: 4px; cursor: pointer;
    box-shadow: 0 4px 10px rgba(37, 211, 102, 0.2);
}

/* --- 7. SELECTION MODE (Builder) --- */
.select-check {
    position: absolute; top: 10px; right: 10px;
    width: 28px; height: 28px; border-radius: 50%;
    background: rgba(255,255,255,0.9); border: 2px solid #ddd;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; color: transparent; z-index: 10;
    transition: all 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.product-card.selected { border: 2px solid #c21a1a; }
.product-card.selected .select-check { background: #c21a1a; border-color: #c21a1a; color: white; transform: scale(1.1); }

/* --- 8. DASHBOARD BAR --- */
.dashboard-controls {
    position: fixed; bottom: 0; left: 0; width: 100%;
    background: white; padding: 20px;
    box-shadow: 0 -10px 40px rgba(0,0,0,0.08);
    z-index: 200; display: none; flex-direction: column; gap: 12px;
    border-top-left-radius: 24px; border-top-right-radius: 24px;
}
.selected-count { text-align: center; color: #666; font-size: 13px; font-weight: 500; }

/* --- 9. INTRO TEXT --- */
.intro-text { padding: 30px 20px 10px 20px; text-align: center; }
.intro-text h1 { font-size: 26px; margin-bottom: 8px; color: #111; letter-spacing: -0.5px; }
.intro-text p { color: #666; font-size: 14px; line-height: 1.5; }

/* --- 10. MODAL --- */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); z-index: 300; display: none;
    align-items: center; justify-content: center; backdrop-filter: blur(8px);
    opacity: 0; transition: opacity 0.3s;
}
.modal-overlay.active { opacity: 1; }
.share-card {
    background: white; width: 85%; max-width: 360px; padding: 30px;
    border-radius: 28px; text-align: center;
    transform: scale(0.9); transition: transform 0.3s;
}
.modal-overlay.active .share-card { transform: scale(1); }
.link-box {
    background: #f8f9fa; padding: 15px; border-radius: 12px;
    font-family: monospace; font-size: 13px; color: #333;
    word-break: break-all; margin: 20px 0; border: 1px solid #eee;
    text-align: left;
}

/* --- 11. SKELETON LOADER (Speed Perception) --- */
.skeleton-card {
    background: white; border-radius: 20px; overflow: hidden; height: 300px;
    display: flex; flex-direction: column;
}
.sk-img { width: 100%; padding-top: 100%; background: #eee; animation: pulse 1.5s infinite; }
.sk-line { height: 12px; background: #eee; margin: 10px 14px; border-radius: 6px; animation: pulse 1.5s infinite; width: 80%; }
.sk-line.short { width: 40%; }
@keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

</style>
</head>
<body>

<div class="partner-header">
    <div class="logo">üéÅ Brendimo</div>
    <div id="store-badge" class="store-badge">R∆èSMƒ∞ PARTNYOR</div>
</div>

<div id="skeleton-grid" class="grid-container" style="display: none; margin-top: 20px;">
    </div>

<div id="login-section" class="login-wrapper">
    <div class="login-card">
        <div style="font-size: 54px; margin-bottom: 15px;">ü§ù</div>
        <h2 style="font-size: 24px; margin-bottom: 8px;">Partnyor Giri≈üi</h2>
        <p style="color: #888; font-size: 14px; line-height: 1.5;">Maƒüazanƒ±zƒ± yaradƒ±n, linkinizi payla≈üƒ±n v…ô satƒ±≈üdan qazanmaƒüa ba≈ülayƒ±n.</p>
        
        <input type="text" id="affiliate-id" class="input-field" placeholder="Partnyor ID (m…ôs: elvin01)">
        <button onclick="handleLogin()" class="btn-primary">Daxil Ol</button>
        <p id="error-msg" style="color: #ff4d4d; font-size: 13px; margin-top: 15px; display: none;"></p>
    </div>
</div>

<div id="shop-container">
    <div class="intro-text" id="intro-text">
        <h1 id="page-title">Y√ºkl…ônir...</h1>
        <p id="page-subtitle">Sizin √º√ß√ºn se√ßilmi≈ü √∂z…ôl h…ôdiyy…ôl…ôr ‚ú®</p>
    </div>

    <div class="grid-container" id="product-grid"></div>
</div>

<div id="builder-controls" class="dashboard-controls">
    <div class="selected-count" id="sel-count">0 m…ôhsul se√ßilib</div>
    <button onclick="generateLink()" class="btn-primary">üîó Maƒüaza Linkini Yarat</button>
</div>

<div id="share-modal" class="modal-overlay">
    <div class="share-card">
        <div style="font-size: 40px; margin-bottom: 10px;">üéâ</div>
        <h3 style="font-size: 20px;">Link Hazƒ±rdƒ±r!</h3>
        <p style="font-size: 13px; color: #888; margin-top: 8px;">Bu linki m√º≈üt…ôril…ôriniz…ô g√∂nd…ôrin.</p>
        <div class="link-box" id="final-link">...</div>
        <button onclick="copyLink()" class="btn-primary" style="margin-bottom: 12px;">Kopyala</button>
        <button onclick="closeModal()" style="background: transparent; border: none; color: #888; font-weight: 600; cursor: pointer;">Baƒüla</button>
    </div>
</div>

<script>
// --- CONFIGURATION ---
const SHEETS_ENDPOINT = "https://script.google.com/macros/s/AKfycbze1YWZVrxz-4EDvB8_lcxDYB-7hqP9XzyN2_kU6wVoEfmMa1erSJvSgGGZIhjQNq04bA/exec"; 

// --- STATE ---
let allProducts = [];
let selectedProducts = new Set();
let affiliateData = null; 
let isBuilderMode = false;

// --- INITIALIZATION ---
window.onload = function() {
    renderSkeletonLoader(); // Show loading animation immediately
    
    const urlParams = new URLSearchParams(window.location.search);
    const affId = urlParams.get('ref');
    const items = urlParams.get('items');

    if (affId) {
        // Customer Mode: Fetch Data and Show Shop
        document.getElementById('login-section').style.display = 'none';
        initCustomerMode(affId, items);
    } else {
        // Partner Mode: Show Login
        document.getElementById('skeleton-grid').style.display = 'none';
        document.getElementById('login-section').style.display = 'flex';
    }
};

// --- CORE FUNCTIONS (OPTIMIZED FOR SPEED) ---

async function initCustomerMode(affId, itemsEncoded) {
    // 1. Try to get Products from Local Cache first (Instant Load)
    loadProductsFromCache();

    // 2. Fetch Affiliate Info & Fresh Products in Parallel (Speed Boost)
    try {
        const [affRes, prodRes] = await Promise.all([
            fetch(`${SHEETS_ENDPOINT}?action=getAffiliateData&id=${affId}`),
            fetch(`${SHEETS_ENDPOINT}?action=getProducts`) // Always fetch fresh in background
        ]);

        const affData = await affRes.json();
        const prodData = await prodRes.json();

        // Handle Affiliate Data
        if (affData.success) {
            affiliateData = affData;
            setupShopUI(affData);
        } else {
            document.body.innerHTML = "<h2 style='text-align:center; margin-top:50px;'>Maƒüaza tapƒ±lmadƒ±.</h2>";
            return;
        }

        // Handle Products
        if (prodData.products) {
            allProducts = prodData.products;
            saveProductsToCache(allProducts); // Update cache for next time
            
            // Filter
            if (itemsEncoded) {
                const indexes = itemsEncoded.split(',').map(n => parseInt(n));
                const filtered = allProducts.filter((_, i) => indexes.includes(i));
                if(filtered.length > 0) allProducts = filtered;
            }
            renderGrid(); // Re-render with fresh data
        }

    } catch (e) {
        console.error("Fetch error:", e);
        // If cache existed, user still sees content. If not, show error.
        if(allProducts.length === 0) showError("ƒ∞nternet baƒülantƒ±sƒ±nƒ± yoxlayƒ±n.");
    }

    // Hide Skeleton
    document.getElementById('skeleton-grid').style.display = 'none';
    document.getElementById('shop-container').style.display = 'block';
    document.getElementById('intro-text').style.display = 'block';
}

async function handleLogin() {
    const id = document.getElementById('affiliate-id').value.trim();
    if(!id) { alert("ID daxil edin"); return; }
    
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('skeleton-grid').style.display = 'grid'; // Show skeleton

    try {
        // Parallel Fetch
        const [affRes, prodRes] = await Promise.all([
            fetch(`${SHEETS_ENDPOINT}?action=getAffiliateData&id=${id}`),
            fetch(`${SHEETS_ENDPOINT}?action=getProducts`)
        ]);

        const affData = await affRes.json();
        const prodData = await prodRes.json();

        if (affData.success) {
            affiliateData = affData;
            isBuilderMode = true;
            
            allProducts = prodData.products || [];
            saveProductsToCache(allProducts);

            setupShopUI(affData);
            
            // Switch UI
            document.getElementById('skeleton-grid').style.display = 'none';
            document.getElementById('shop-container').style.display = 'block';
            document.getElementById('builder-controls').style.display = 'flex';
            document.getElementById('intro-text').style.display = 'block';
            document.getElementById('product-grid').style.display = 'grid'; // Ensure grid is visible
            
            // Update Text for Builder
            document.getElementById('page-subtitle').textContent = "Satmaq ist…ôdiyiniz m…ôhsullarƒ± se√ßin.";

            renderGrid();
        } else {
            document.getElementById('skeleton-grid').style.display = 'none';
            document.getElementById('login-section').style.display = 'flex'; // Go back
            showError("Partnyor ID tapƒ±lmadƒ±.");
        }

    } catch (e) {
        document.getElementById('skeleton-grid').style.display = 'none';
        document.getElementById('login-section').style.display = 'flex';
        showError("X…ôta ba≈ü verdi. ƒ∞nterneti yoxlayƒ±n.");
    }
}

// --- UI HELPERS ---

function setupShopUI(data) {
    document.title = data.storeName;
    document.getElementById('page-title').textContent = isBuilderMode ? `Salam, ${data.storeName} üëã` : data.storeName;
    document.querySelector('.logo').textContent = "üéÅ " + data.storeName;
    document.querySelector('.store-badge').style.display = 'block';
}

function renderGrid() {
    const container = document.getElementById('product-grid');
    container.innerHTML = '';

    allProducts.forEach((p, index) => {
        const el = document.createElement('div');
        // No wrapper class needed here, product-card handles it
        
        let imgUrl = fixImageLink(p.image);
        let desc = p.description || "H…ôdiyy…ôlik m…ôhsul";

        // Builder Mode vs Customer Mode HTML
        let actionHtml = '';
        let selectClass = '';
        let selectHtml = '';

        if (isBuilderMode) {
            el.onclick = () => toggleSelection(index, el.querySelector('.product-card'));
            selectHtml = `<div class="select-check">‚úî</div>`;
            actionHtml = `<div style="font-size:12px; color:#888;">Se√ßm…ôk √º√ß√ºn toxunun</div>`;
        } else {
            actionHtml = `
                <button class="btn-buy-sm" onclick="buyItem('${p.name}', '${p.price}')">
                    <svg width="14" height="14" fill="white" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                    Sifari≈ü
                </button>
            `;
        }

        el.innerHTML = `
            <article class="product-card ${selectClass}">
                ${selectHtml}
                <div class="card-img-wrapper">
                    <img src="${imgUrl}" loading="lazy" alt="${p.name}">
                </div>
                <div class="card-content">
                    <h3 class="card-title">${p.name}</h3>
                    <p class="card-desc">${desc}</p>
                    <div class="card-footer">
                        <span class="card-price">${p.price} ‚Çº</span>
                        ${actionHtml}
                    </div>
                </div>
            </article>
        `;
        container.appendChild(el);
    });
}

// --- UTILITIES & CACHING ---

function loadProductsFromCache() {
    const cached = localStorage.getItem('brendimo_products');
    const time = localStorage.getItem('brendimo_cache_time');
    
    // Valid for 30 minutes (1800000 ms)
    if (cached && time && (Date.now() - time < 1800000)) {
        allProducts = JSON.parse(cached);
        // Show cached products immediately
        document.getElementById('skeleton-grid').style.display = 'none';
        document.getElementById('shop-container').style.display = 'block';
        document.getElementById('intro-text').style.display = 'block';
        document.getElementById('product-grid').style.display = 'grid'; // Ensure visible
        renderGrid();
    }
}

function saveProductsToCache(products) {
    if(products.length > 0) {
        localStorage.setItem('brendimo_products', JSON.stringify(products));
        localStorage.setItem('brendimo_cache_time', Date.now());
    }
}

function renderSkeletonLoader() {
    const skContainer = document.getElementById('skeleton-grid');
    skContainer.style.display = 'grid';
    skContainer.innerHTML = '';
    for(let i=0; i<6; i++) {
        skContainer.innerHTML += `
            <div class="skeleton-card">
                <div class="sk-img"></div>
                <div class="sk-line"></div>
                <div class="sk-line short"></div>
            </div>`;
    }
}

function fixImageLink(url) {
    if (!url) return 'https://via.placeholder.com/300?text=No+Image';
    if (url.includes('drive.google.com')) { const idMatch = url.match(/[-\w]{25,}/); if (idMatch) return `https://googleusercontent.com/profile/picture/0${idMatch[0]}`; }
    return url;
}

// --- INTERACTION ---

function toggleSelection(index, cardEl) {
    if (selectedProducts.has(index)) {
        selectedProducts.delete(index);
        cardEl.classList.remove('selected');
    } else {
        selectedProducts.add(index);
        cardEl.classList.add('selected');
    }
    document.getElementById('sel-count').textContent = `${selectedProducts.size} m…ôhsul se√ßilib`;
}

function generateLink() {
    if(selectedProducts.size === 0) { alert("∆èn azƒ± 1 m…ôhsul se√ßin!"); return; }
    const indexes = Array.from(selectedProducts).sort((a,b)=>a-b).join(',');
    const origin = window.location.origin;
    const pathname = window.location.pathname;
    const finalUrl = `${origin}${pathname}?ref=${affiliateData.id}&items=${indexes}`;
    
    document.getElementById('final-link').textContent = finalUrl;
    const modal = document.getElementById('share-modal');
    modal.style.display = 'flex';
    // Small delay to allow display:flex to apply before adding opacity
    setTimeout(() => modal.classList.add('active'), 10);
}

function copyLink() {
    navigator.clipboard.writeText(document.getElementById('final-link').textContent)
        .then(() => alert("Link kopyalandƒ±!"))
        .catch(() => alert("∆èll…ô kopyalayƒ±n."));
}

function closeModal() {
    const modal = document.getElementById('share-modal');
    modal.classList.remove('active');
    setTimeout(() => modal.style.display = 'none', 300);
}

function buyItem(prodName, price) {
    const phone = affiliateData.phone;
    const text = `Salam ${affiliateData.storeName}! üéÅ\n\nSifari≈ü etm…ôk ist…ôyir…ôm:\n*${prodName}*\nQiym…ôt: ${price} AZN`;
    const url = `https://wa.me/${phone}?text=${encodeURIComponent(text)}`;
    window.open(url, '_blank');
}

function showError(msg) {
    const el = document.getElementById('error-msg');
    el.textContent = msg; el.style.display = 'block';
}
</script>
</body>
</html>
