<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Brendimo Partner</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* --- CORE STYLES --- */
* { margin: 0; padding: 0; box-sizing: border-box; font-family: "Inter", sans-serif; -webkit-tap-highlight-color: transparent; }
body { background: #fafafa; color: #1d1d1f; overflow-x: hidden; min-height: 100vh; padding-bottom: 40px; }

/* HEADER */
.partner-header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 15px 20px;
    position: sticky; top: 0; z-index: 100;
    border-bottom: 1px solid #eee;
    display: flex; justify-content: space-between; align-items: center;
}
.logo { font-size: 20px; font-weight: 800; color: #c21a1a; letter-spacing: -0.5px; }
.store-badge { font-size: 11px; background: #FFD700; color: #000; padding: 4px 8px; border-radius: 12px; font-weight: 700; display: none; }

/* --- CRITICAL FIX: Hide sections by default to prevent overlap --- */
#login-section, #shop-container, #builder-controls, #intro-text {
    display: none; 
}

/* LOGIN SCREEN */
.login-wrapper {
    /* Flex is applied via JS when needed */
    flex-direction: column; align-items: center; justify-content: center;
    height: 80vh; padding: 20px; text-align: center;
}
.login-card {
    background: white; padding: 30px; border-radius: 24px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.08); width: 100%; max-width: 400px;
}
.input-field {
    width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 12px;
    font-size: 16px; margin: 20px 0; outline: none; transition: 0.3s;
}
.input-field:focus { border-color: #c21a1a; }
.btn-primary {
    width: 100%; padding: 16px; background: #c21a1a; color: white;
    border: none; border-radius: 12px; font-size: 16px; font-weight: 700;
    cursor: pointer; box-shadow: 0 4px 15px rgba(194, 26, 26, 0.3);
    transition: transform 0.2s;
}
.btn-primary:active { transform: scale(0.96); }

/* GRID SYSTEM */
.grid-container {
    display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
    padding: 20px; max-width: 600px; margin: 0 auto;
}
.grid-item {
    background: white; border-radius: 16px; overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative;
    transition: transform 0.2s;
}

/* SELECTION MODE STYLES */
.select-overlay {
    position: absolute; top: 10px; right: 10px;
    width: 24px; height: 24px; border-radius: 50%;
    border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    background: #ccc; z-index: 10;
}
.grid-item.selected { border: 2px solid #c21a1a; transform: scale(0.98); }
.grid-item.selected .select-overlay { background: #c21a1a; }

/* PRODUCT INFO */
.grid-item img { width: 100%; height: 160px; object-fit: cover; }
.grid-info { padding: 12px; }
.grid-title { font-size: 13px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.grid-price { color: #c21a1a; font-weight: 800; font-size: 15px; margin-top: 4px; display: block;}

/* DASHBOARD CONTROLS */
.dashboard-controls {
    position: fixed; bottom: 0; left: 0; width: 100%;
    background: white; padding: 20px;
    box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
    z-index: 200; 
    flex-direction: column; gap: 10px;
    border-top-left-radius: 20px; border-top-right-radius: 20px;
}
.selected-count { text-align: center; color: #888; font-size: 12px; margin-bottom: 5px; }

/* SHARE MODAL */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); z-index: 300; display: none;
    align-items: center; justify-content: center; backdrop-filter: blur(5px);
}
.share-card {
    background: white; width: 90%; max-width: 350px; padding: 30px;
    border-radius: 24px; text-align: center;
}
.link-box {
    background: #f4f4f4; padding: 12px; border-radius: 8px;
    font-family: monospace; font-size: 12px; color: #555;
    word-break: break-all; margin: 15px 0; border: 1px solid #ddd;
}

/* LOADER */
.loader { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 999; }
.loader::after { content: "‚è≥"; font-size: 40px; animation: spin 1s infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* CUSTOMER VIEW BUY BUTTON */
.buy-now-btn {
    width: 100%; margin-top: 8px; padding: 10px;
    background: #25D366; color: white; border: none; border-radius: 8px;
    font-weight: 700; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 5px;
    cursor: pointer;
}

.intro-text { padding: 20px; text-align: center;}
.intro-text h1 { font-size: 24px; margin-bottom: 5px; color: #111; }
.intro-text p { color: #666; font-size: 14px; }

</style>
</head>
<body>

<div class="partner-header">
    <div class="logo">üéÅ Brendimo</div>
    <div id="store-badge" class="store-badge">R∆èSMƒ∞ PARTNYOR</div>
</div>

<div class="loader" id="loader"></div>

<div id="login-section" class="login-wrapper">
    <div class="login-card">
        <div style="font-size: 50px; margin-bottom: 10px;">ü§ù</div>
        <h2>Partnyor Giri≈üi</h2>
        <p style="color: #777; font-size: 14px; margin-top: 5px;">M…ôhsullarƒ± se√ßin, linkinizi yaradƒ±n v…ô qazanmaƒüa ba≈ülayƒ±n.</p>
        
        <input type="text" id="affiliate-id" class="input-field" placeholder="Partnyor ID (m…ôs: elvin01)">
        <button onclick="loginAffiliate()" class="btn-primary">Daxil Ol</button>
        <p id="error-msg" style="color: red; font-size: 12px; margin-top: 15px; display: none;"></p>
    </div>
</div>

<div id="shop-container">
    <div class="intro-text" id="intro-text">
        <h1 id="page-title">Xo≈ü G…ôlmisiniz</h1>
        <p id="page-subtitle">Sizin √º√ß√ºn se√ßilmi≈ü √∂z…ôl h…ôdiyy…ôl…ôr ‚ú®</p>
    </div>

    <div class="grid-container" id="product-grid"></div>
    <div style="height: 100px;"></div> </div>

<div id="builder-controls" class="dashboard-controls">
    <div class="selected-count" id="sel-count">0 m…ôhsul se√ßilib</div>
    <button onclick="generateLink()" class="btn-primary">üîó Maƒüaza Linkini Yarat</button>
</div>

<div id="share-modal" class="modal-overlay">
    <div class="share-card">
        <h3>üéâ Link Hazƒ±rdƒ±r!</h3>
        <p style="font-size: 13px; color: #666; margin-top: 5px;">Bu linki m√º≈üt…ôril…ôriniz…ô g√∂nd…ôrin.</p>
        <div class="link-box" id="final-link">...</div>
        <button onclick="copyLink()" class="btn-primary" style="margin-bottom: 10px;">Kopyala</button>
        <button onclick="closeModal()" style="background: transparent; border: none; color: #777; font-weight: 600;">Baƒüla</button>
    </div>
</div>

<script>
// --- CONFIGURATION ---
const SHEETS_ENDPOINT = "https://script.google.com/macros/s/AKfycbze1YWZVrxz-4EDvB8_lcxDYB-7hqP9XzyN2_kU6wVoEfmMa1erSJvSgGGZIhjQNq04bA/exec"; 

// --- STATE ---
let allProducts = [];
let selectedProducts = new Set();
let affiliateData = null; 
let isBuilderMode = false;

// --- INIT ---
window.onload = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const affId = urlParams.get('ref'); 
    const items = urlParams.get('items'); 

    // ∆èN VACƒ∞B Hƒ∞SS∆è: G√∂r√ºn√º≈ü√º d…ôqiq ayƒ±rƒ±rƒ±q
    if (affId) {
        // --- SENARƒ∞ A: M√ú≈ûT∆èRƒ∞ G∆èLDƒ∞ ---
        // 1. Logini q…ôti ≈ü…ôkild…ô gizl…ôt
        document.getElementById('login-section').style.display = 'none'; 
        
        // 2. Maƒüaza y√ºkl…ô
        loadCustomerShop(affId, items);
    } else {
        // --- SENARƒ∞ B: PARTNYOR Gƒ∞Rƒ∞≈ûƒ∞ ---
        // 1. Maƒüazanƒ± gizl…ôt
        document.getElementById('shop-container').style.display = 'none';
        document.getElementById('intro-text').style.display = 'none';
        
        // 2. Logini a√ß (Flex olaraq)
        document.getElementById('login-section').style.display = 'flex';
    }
};

// --- LOGIC: PARTNER LOGIN ---
async function loginAffiliate() {
    const id = document.getElementById('affiliate-id').value.trim();
    if(!id) { alert("Z…ôhm…ôt olmasa ID daxil edin"); return; }

    showLoader(true);
    try {
        const res = await fetch(`${SHEETS_ENDPOINT}?action=getAffiliateData&id=${id}`);
        const data = await res.json();
        
        if (data.success) {
            affiliateData = data;
            isBuilderMode = true;
            enterBuilderMode();
        } else {
            showError(data.error || "ID tapƒ±lmadƒ±.");
        }
    } catch(e) { showError("ƒ∞nternet x…ôtasƒ±"); }
    showLoader(false);
}

async function enterBuilderMode() {
    // Ke√ßid anƒ±nda ekranlarƒ± d…ôyi≈üirik
    document.getElementById('login-section').style.display = 'none';
    
    document.getElementById('shop-container').style.display = 'block';
    document.getElementById('builder-controls').style.display = 'flex';
    document.getElementById('product-grid').style.display = 'grid';
    document.getElementById('intro-text').style.display = 'block';
    
    document.getElementById('page-title').textContent = `Salam, ${affiliateData.storeName}! üëã`;
    document.getElementById('page-subtitle').textContent = "Satmaq ist…ôdiyiniz m…ôhsullarƒ± se√ßin.";
    document.querySelector('.store-badge').style.display = 'block';

    await fetchProducts();
    renderGrid();
}

// --- LOGIC: CUSTOMER VIEW ---
async function loadCustomerShop(affId, itemsEncoded) {
    showLoader(true);
    try {
        const res = await fetch(`${SHEETS_ENDPOINT}?action=getAffiliateData&id=${affId}`);
        const data = await res.json();

        if (data.success) {
            affiliateData = data;
            
            document.title = data.storeName + " | Brendimo";
            document.getElementById('page-title').textContent = data.storeName;
            document.querySelector('.logo').textContent = "üéÅ " + data.storeName;
            
            // Maƒüazanƒ± g√∂st…ôr (Login artƒ±q gizlidir)
            document.getElementById('shop-container').style.display = 'block';
            document.getElementById('intro-text').style.display = 'block';
            document.getElementById('product-grid').style.display = 'grid';

            await fetchProducts();
            
            if (itemsEncoded) {
                const indexes = itemsEncoded.split(',').map(item => parseInt(item.trim()));
                const filtered = allProducts.filter((_, i) => indexes.includes(i));
                if(filtered.length > 0) allProducts = filtered;
            }
            renderGrid();
        } else {
            document.body.innerHTML = `<div style="text-align:center; padding:50px;"><h3>Maƒüaza tapƒ±lmadƒ±</h3></div>`;
        }
    } catch(e) { console.log(e); }
    showLoader(false);
}

// --- SHARED DATA & RENDER ---
async function fetchProducts() {
    try {
        const res = await fetch(`${SHEETS_ENDPOINT}?action=getProducts`);
        const data = await res.json();
        allProducts = data.products || [];
    } catch (e) { console.error("Error loading products"); }
}

function renderGrid() {
    const container = document.getElementById('product-grid');
    container.innerHTML = '';

    allProducts.forEach((p, index) => {
        const el = document.createElement('div');
        el.className = 'grid-item';
        
        let imgUrl = p.image || "";
        if (imgUrl.includes('drive.google.com')) { 
            const idMatch = imgUrl.match(/[-\w]{25,}/); 
            if (idMatch) imgUrl = `https://googleusercontent.com/profile/picture/0${idMatch[0]}`; 
        }

        if (isBuilderMode) {
            el.onclick = () => toggleSelection(index, el);
            el.innerHTML = `
                <div class="select-overlay"></div>
                <img src="${imgUrl}">
                <div class="grid-info"><div class="grid-title">${p.name}</div><span class="grid-price">${p.price} AZN</span></div>
            `;
        } else {
            el.innerHTML = `
                <img src="${imgUrl}">
                <div class="grid-info">
                    <div class="grid-title">${p.name}</div>
                    <span class="grid-price">${p.price} AZN</span>
                    <button class="buy-now-btn" onclick="buyItem('${p.name}', '${p.price}')">
                        Sifari≈ü Et 
                        <svg width="16" height="16" fill="white" viewBox="0 0 24 24" style="margin-left:5px;"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                    </button>
                </div>
            `;
        }
        container.appendChild(el);
    });
}

// --- UTILS ---
function toggleSelection(index, el) {
    if (selectedProducts.has(index)) { selectedProducts.delete(index); el.classList.remove('selected'); } 
    else { selectedProducts.add(index); el.classList.add('selected'); }
    document.getElementById('sel-count').textContent = `${selectedProducts.size} m…ôhsul se√ßilib`;
}

function generateLink() {
    if(selectedProducts.size === 0) { alert("∆èn azƒ± 1 m…ôhsul se√ßin!"); return; }
    const indexes = Array.from(selectedProducts).sort((a,b)=>a-b).join(',');
    const origin = window.location.origin;
    const pathname = window.location.pathname;
    const finalUrl = `${origin}${pathname}?ref=${affiliateData.id}&items=${indexes}`;
    document.getElementById('final-link').textContent = finalUrl;
    document.getElementById('share-modal').style.display = 'flex';
}

function copyLink() {
    navigator.clipboard.writeText(document.getElementById('final-link').textContent)
        .then(() => alert("Link kopyalandƒ±!"))
        .catch(() => alert("Kopyalanma alƒ±nmadƒ±."));
}

function closeModal() { document.getElementById('share-modal').style.display = 'none'; }

function buyItem(prodName, price) {
    const phone = affiliateData.phone; 
    const text = `Salam ${affiliateData.storeName}! üéÅ\n\nSifari≈ü:\n*${prodName}* - ${price} AZN`;
    const url = `https://wa.me/${phone}?text=${encodeURIComponent(text)}`;
    window.open(url, '_blank');
}

function showLoader(show) { document.getElementById('loader').style.display = show ? 'block' : 'none'; }
function showError(msg) { document.getElementById('error-msg').textContent = msg; document.getElementById('error-msg').style.display = 'block'; }
</script>
</body>
</html>
