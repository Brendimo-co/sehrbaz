<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Brendimo H…ôdiyy…ô Sehrbazƒ±</title>
  <meta property="og:type" content="website">
  <meta property="og:title" content="üéÅ Brendimo H…ôdiyy…ô Sehrbazƒ±">
  <meta property="og:description" content="H…ôdiyy…ô axtarƒ±≈üƒ±ndan yorulmusan? 30 saniy…ôy…ô ideal h…ôdiyy…ôni tap! S…ôn…ô √∂z…ôl se√ßiml…ôri g√∂rm…ôk √º√ß√ºn daxil ol.">
  
  <meta property="og:image" content="https://github.com/Brendimo-co/sehrbaz/blob/main/Gemini_Generated_Image_hzsbephzsbephzsb.png?raw=true">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:image:type" content="image/jpeg">
  <meta property="og:url" content="https://brendimo-co.github.io/sehrbaz/">
  

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* --- CSS STYLES --- */

/* RESET & BASE */
* { margin: 0; padding: 0; box-sizing: border-box; font-family: "Inter", sans-serif; -webkit-tap-highlight-color: transparent; }
body { background: #fafafa; color: #1d1d1f; overflow-x: hidden; height: 100vh; display: flex; flex-direction: column; }

/* LAYOUT */
.wizard-wrapper {
  flex: 1; width: 100%; max-width: 440px; margin: 0 auto; padding: 20px 20px 80px 20px; /* Added bottom padding for floating btns */
  display: flex; flex-direction: column; position: relative;
}

/* HEADER */
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; height: 40px; }
.back-btn { font-size: 14px; color: #777; cursor: pointer; display: flex; align-items: center; gap: 4px; font-weight: 600; }
.logo { font-size: 20px; font-weight: 800; color: #c21a1a; letter-spacing: -0.5px; }
.step-indicator { font-size: 12px; color: #999; font-weight: 600; background: #eee; padding: 4px 8px; border-radius: 12px; }

/* PROGRESS */
.progress-container { height: 4px; background: #eee; border-radius: 2px; margin-bottom: 30px; overflow: hidden; }
.progress-fill { height: 100%; background: #c21a1a; width: 20%; transition: width 0.4s ease; }

/* STEPS */
.step-content { display: none; animation: fadeIn 0.4s ease; }
.step-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.title { font-size: 24px; font-weight: 700; margin-bottom: 24px; text-align: center; line-height: 1.3; }

/* OPTIONS GRID */
.options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.option-card {
  background: white; border: 2px solid #f0f0f0; border-radius: 16px; padding: 20px 10px;
  text-align: center; cursor: pointer; transition: all 0.2s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.03);
}
.option-card:active { transform: scale(0.96); border-color: #c21a1a; background: #fffcfc; }
.option-icon { font-size: 32px; margin-bottom: 8px; display: block; }
.option-text { font-size: 15px; font-weight: 600; color: #333; }

/* --- YENƒ∞ PREMIUM KART Dƒ∞ZAYNI --- */

/* Kartlarƒ±n olduƒüu qutu - Ekranƒ±n h√ºnd√ºrl√ºy√ºn…ô g√∂r…ô d…ôyi≈üir */
#cards-wrapper { 
  position: relative; 
  width: 100%; 
  /* CHANGE THESE VALUES */
  height: 70vh;        /* Increased from 62vh */
  max-height: 650px;   /* Increased from 580px */
  min-height: 420px;
  margin-top: 10px; 
  perspective: 1000px; 
}

.card {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  background: white; 
  border-radius: 24px; /* Daha yumru k√ºncl…ôr */
  /* Daha yum≈üaq v…ô d…ôrin "Premium" k√∂lg…ô */
  box-shadow: 0 15px 40px -10px rgba(0,0,0,0.12);
  overflow: hidden; 
  transform-origin: 50% 100%; will-change: transform; touch-action: none;
  display: flex; flex-direction: column;
}

/* ≈û…ôkil sah…ôsi - */
.card-image-box {
  position: relative;
  width: 100%;
  height: 60%; 
  overflow: hidden;
  background: #f9f9f9; /* A√ßƒ±q boz studiya fonu */
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 10px; /* K…ônarlardan bir az bo≈üluq buraxƒ±r */
}

.card-image-box img { 
  width: 100%; 
  height: 100%; 
  object-fit: contain; /* ≈û…ôkli sƒ±xmadan, k…ôsm…ôd…ôn tam g√∂st…ôrir */
  filter: drop-shadow(0 4px 6px rgba(0,0,0,0.05)); /* M…ôhsula y√ºng√ºl k√∂lg…ô verir */
}

/* Glassmorphism Uyƒüunluq Faizi */
.match-badge {
  position: absolute; top: 16px; right: 16px; 
  background: rgba(255, 255, 255, 0.85); /* Yarƒ±m≈ü…ôffaf aƒü */
  color: #c21a1a; 
  padding: 6px 14px; 
  border-radius: 30px; 
  font-size: 13px; 
  font-weight: 800; 
  backdrop-filter: blur(10px); /* ≈û√º≈ü…ô effekti */
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  z-index: 2;
}

/* M…ôlumat sah…ôsi - Kartƒ±n 45%-ni tutur */
.card-info { 
  flex: 1; 
  padding: 16px 20px; 
  display: flex; 
  flex-direction: column; 
  justify-content: space-between; /* M…ôtni yuxarƒ±, qiym…ôti a≈üaƒüƒ± it…ôl…ôyir */
  background: #fff;
}

/* Premium Tag - Daha eleqant */
.premium-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  background: linear-gradient(135deg, #fff8e1 0%, #fff3cd 100%);
  color: #b78900;
  padding: 5px 10px;
  border-radius: 8px;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  width: fit-content;
  margin-bottom: 8px;
}

  
/* M…ôtnl…ôr */
.card-text-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.card h3 { 
  /* M…ôtn √∂l√ß√ºs√º ekrana g√∂r…ô d…ôyi≈üir (Min 18px, Max 24px) */
  font-size: clamp(18px, 5vw, 22px); 
  font-weight: 700;
  color: #111;
  line-height: 1.2;
  margin: 0;
  
  /* 2 s…ôtird…ôn √ßox olarsa k…ôsir (...) */
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}

.card p { 
  font-size: 14px; 
  color: #666; 
  line-height: 1.5; 
  margin: 0;
  
  /* 3 s…ôtird…ôn √ßox olarsa k…ôsir (...) */
  display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
}

/* Qiym…ôt Sah…ôsi - Altda yerl…ô≈üir */
.card-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 10px;
  padding-top: 12px;
  border-top: 1px solid #f0f0f0;
}

.price-box {
  display: flex;
  flex-direction: column;
}

.price-label {
  font-size: 10px;
  color: #999;
  font-weight: 600;
  text-transform: uppercase;
}

.price-tag { 
  font-size: 24px; 
  font-weight: 800; 
  color: #1d1d1f; 
  letter-spacing: -1px;
}

.details-arrow {
  width: 36px; height: 36px;
  background: #f5f5f7;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  color: #1d1d1f;
  font-weight: bold;
}

/* --- FADING SPELL STYLES (NEW) --- */

/* GLOBAL STICKY BAR (Main Page) */
.global-spell-wrapper {
    background: #1a1a1a;
    color: white;
    padding: 10px 15px;
    border-radius: 12px;
    margin-bottom: 20px;
    border: 1px solid #FFD700;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    animation: slideDown 0.5s ease;
}

.gs-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
    font-weight: 700;
}

.gs-amount {
    color: #FFD700;
    font-size: 18px;
    font-variant-numeric: tabular-nums;
}

.gs-timer-track {
    width: 100%;
    height: 4px;
    background: rgba(255,255,255,0.2);
    border-radius: 2px;
    overflow: hidden;
}

.gs-timer-fill {
    height: 100%;
    background: linear-gradient(90deg, #FFD700, #ff4b4b);
    width: 100%;
    transition: width 1s linear; 
}

/* MODAL BAR STYLES */
.spell-box {
  background: linear-gradient(135deg, #2b2b2b 0%, #1a1a1a 100%);
  border-radius: 12px;
  padding: 12px 16px;
  margin-bottom: 15px;
  color: white;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  border-left: 4px solid #FFD700; 
  animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.spell-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.spell-amount {
  font-size: 20px;
  font-weight: 800;
  color: #FFD700; /* Gold */
  text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
  font-variant-numeric: tabular-nums;
}

/* Shake animation when price drops */
.shake-text {
  animation: shake 0.5s;
  color: #ff4b4b !important; /* Turn red briefly */
}

.spell-timer-track {
  width: 100%;
  height: 6px;
  background: rgba(255,255,255,0.2);
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 6px;
}

.spell-timer-bar {
  height: 100%;
  width: 100%;
  background: linear-gradient(90deg, #FFD700, #ff4b4b);
  transform-origin: left;
  transition: width 1s linear; 
}

.spell-warning {
  font-size: 11px;
  color: #ccc;
  text-align: right;
  font-style: italic;
}

@keyframes shake {
  0% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  50% { transform: translateX(5px); }
  75% { transform: translateX(-5px); }
  100% { transform: translateX(0); }
}

@keyframes popIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}
@keyframes slideDown { 
    from { transform: translateY(-20px); opacity: 0; } 
    to { transform: translateY(0); opacity: 1; } 
}
  

/* FLOATING BUTTONS */
.floating-bar {
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  display: flex; gap: 12px; z-index: 90;
}
.float-btn {
  background: #1d1d1f; color: white; border: none; padding: 10px 16px; border-radius: 30px;
  font-size: 13px; font-weight: 600; cursor: pointer; box-shadow: 0 6px 16px rgba(0,0,0,0.2);
  display: flex; align-items: center; gap: 6px; text-decoration: none; white-space: nowrap;
}
.float-btn.wheel { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; }

/* ALL PRODUCTS MODAL/VIEW */
.all-products-view {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fafafa;
  z-index: 100; overflow-y: auto; padding: 20px; display: none;
}
.all-products-view.active { display: block; animation: slideUp 0.3s ease; }
.close-view-btn { 
  position: sticky; top: 0; background: rgba(250,250,250,0.9); padding: 10px 0;
  display: flex; justify-content: flex-end; margin-bottom: 10px; z-index: 2; backdrop-filter: blur(5px);
}
.grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding-bottom: 40px; }
.grid-item { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.grid-item img { width: 100%; height: 140px; object-fit: cover; }
.grid-info { padding: 10px; }
.grid-title { font-size: 13px; font-weight: 700; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.grid-price { font-size: 14px; color: #c21a1a; font-weight: 700; }
.load-more-btn {
  width: 100%; padding: 12px; background: #eee; border: none; border-radius: 8px;
  font-weight: 600; color: #555; cursor: pointer; margin-bottom: 40px;
}

/* MODAL */
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 200; padding: 24px; overflow-y: auto; display: none; }
.modal.active { display: block; animation: slideUp 0.3s ease; }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

/* LOADER */
/* --- MAGIC LOADER ANIMATIONS --- */
.magic-loader-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 60vh; /* Center on screen */
  position: relative;
}

.magic-wand-wrapper {
  position: relative;
  width: 100px;
  height: 100px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.magic-wand {
  font-size: 64px;
  z-index: 2;
  animation: waveWand 2.5s ease-in-out infinite;
  transform-origin: bottom left;
}

/* Glowing Aura behind the wand */
.magic-aura {
  position: absolute;
  width: 60px;
  height: 60px;
  background: radial-gradient(circle, rgba(194, 26, 26, 0.4) 0%, rgba(255, 215, 0, 0) 70%);
  border-radius: 50%;
  animation: pulseGlow 2s infinite;
  z-index: 1;
}

/* Floating Sparkles */
.sparkle {
  position: absolute;
  color: #FFD700;
  font-size: 20px;
  opacity: 0;
  animation: sparkleFloat 2s infinite;
}
.s1 { top: 0; right: 0; animation-delay: 0.2s; }
.s2 { top: 20px; left: -10px; animation-delay: 0.5s; font-size: 14px; }
.s3 { bottom: 0; right: -10px; animation-delay: 0.8s; font-size: 24px; }
.s4 { bottom: 20px; left: 0; animation-delay: 1.2s; }

/* Text Animation */
.magic-text {
  margin-top: 30px;
  font-size: 18px;
  font-weight: 600;
  color: #555;
  min-height: 24px; /* Prevent layout jump */
  text-align: center;
  animation: textFade 0.5s;
}

/* KEYFRAMES */
@keyframes waveWand {
  0% { transform: rotate(0deg); }
  25% { transform: rotate(-15deg); }
  50% { transform: rotate(0deg); }
  75% { transform: rotate(10deg); }
  100% { transform: rotate(0deg); }
}

@keyframes pulseGlow {
  0% { transform: scale(0.8); opacity: 0.5; }
  50% { transform: scale(1.5); opacity: 0.2; }
  100% { transform: scale(0.8); opacity: 0.5; }
}

@keyframes sparkleFloat {
  0% { transform: translateY(0) scale(0); opacity: 0; }
  50% { opacity: 1; }
  100% { transform: translateY(-40px) scale(1.2); opacity: 0; }
}

@keyframes textFade {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.hidden { display: none !important; }

 /* Premium Tag Stili */
.premium-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: #fff8e1; /* A√ßƒ±q qƒ±zƒ±lƒ± fon */
  color: #b78900;       /* T√ºnd qƒ±zƒ±lƒ± m…ôtn */
  border: 1px solid #ffe082;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  margin-bottom: 8px;
  width: fit-content;
}

/* Logo Stili (Cursor pointer …ôlav…ôsi) */
.logo { 
  font-size: 20px; 
  font-weight: 800; 
  color: #c21a1a; 
  letter-spacing: -0.5px; 
  cursor: pointer; /* Klikl…ôn…ô bil…ôn olduƒüunu g√∂st…ôrir */
}
.logo:active { opacity: 0.7; } 
  
 
  <script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '752296677155305');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=752296677155305&ev=PageView&noscript=1"
/></noscript>
</style>
</head>
<body>

<div class="wizard-wrapper">
  
 <div class="header">
    <div class="back-btn" onclick="goBack()">‚Üê Geri</div>
    <div class="logo" onclick="restartApp()">üéÅ Brendimo</div>
    <div class="step-indicator" id="step-count">1/5</div>
</div>

  <div class="progress-container">
    <div class="progress-fill" id="progress-bar"></div>
  </div>

  <div class="step-content active" id="step-0">
    <h2 class="title">H…ôdiyy…ô kimin √º√ß√ºnd√ºr?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'who')">
      <div class="option-card" data-val="Xanƒ±m"><span class="option-icon">üë©</span><span class="option-text">Xanƒ±m</span></div>
      <div class="option-card" data-val="B…ôy"><span class="option-icon">üë®</span><span class="option-text">B…ôy</span></div>
      <div class="option-card" data-val="U≈üaq"><span class="option-icon">üßí</span><span class="option-text">U≈üaq</span></div>
      <div class="option-card" data-val="H…ômkar"><span class="option-icon">üíº</span><span class="option-text">H…ômkar</span></div>
    </div>
  </div>

  <div class="step-content" id="step-1">
    <h2 class="title">Hansƒ± √∂z…ôl g√ºn √º√ß√ºn?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'occasion')">
      <div class="option-card" data-val="Ad g√ºn√º"><span class="option-icon">üéÇ</span><span class="option-text">Ad g√ºn√º</span></div>
      <div class="option-card" data-val="Yubiley"><span class="option-icon">ü•Ç</span><span class="option-text">Yubiley</span></div>
      <div class="option-card" data-val="Yeni ƒ∞l"><span class="option-icon">üéÑ</span><span class="option-text">Yeni ƒ∞l</span></div>
      <div class="option-card" data-val="S…ôb…ôbsiz"><span class="option-icon">üíù</span><span class="option-text">Sad…ôc…ô H…ôdiyy…ô</span></div>
    </div>
  </div>

  <div class="step-content" id="step-2">
    <h2 class="title">H…ôdiyy…ônin aurasƒ± nec…ô olsun?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'mood')">
      <div class="option-card" data-val="Romantik"><span class="option-icon">üåπ</span><span class="option-text">Romantik</span></div>
      <div class="option-card" data-val="R…ôsmi"><span class="option-icon">üëî</span><span class="option-text">R…ôsmi</span></div>
      <div class="option-card" data-val="Fun"><span class="option-icon">üéâ</span><span class="option-text">∆èyl…ônc…ôli</span></div>
      <div class="option-card" data-val="Faydalƒ±"><span class="option-icon">üìö</span><span class="option-text">Praktik/Faydalƒ±</span></div>
    </div>
  </div>

  <div class="step-content" id="step-3">
    <h2 class="title">Stil se√ßimi</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'style')">
      <div class="option-card" data-val="Modern"><span class="option-icon">‚ú®</span><span class="option-text">Modern</span></div>
      <div class="option-card" data-val="Klassik"><span class="option-icon">üèõÔ∏è</span><span class="option-text">Klassik</span></div>
      <div class="option-card" data-val="Minimal"><span class="option-icon">‚ö™</span><span class="option-text">Minimalist</span></div>
      <div class="option-card" data-val="L√ºks"><span class="option-icon">üíé</span><span class="option-text">L√ºks</span></div>
    </div>
  </div>

  <div class="step-content" id="step-4">
    <h2 class="title">B√ºdc…ô aralƒ±ƒüƒ±nƒ±z?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'budget')">
      <div class="option-card" data-val="0-30"><span class="option-icon">ü™ô</span><span class="option-text">0 - 30 AZN</span></div>
      <div class="option-card" data-val="30-60"><span class="option-icon">üíµ</span><span class="option-text">30 - 60 AZN</span></div>
      <div class="option-card" data-val="60-120"><span class="option-icon">üí∞</span><span class="option-text">60 - 120 AZN</span></div>
      <div class="option-card" data-val="120+"><span class="option-icon">üí≥</span><span class="option-text">120+ AZN</span></div>
    </div>
  </div>

  <div class="step-content" id="step-loading">
    <div class="magic-loader-container">
      <div class="magic-wand-wrapper">
        <div class="magic-wand">ü™Ñ</div>
        <div class="magic-aura"></div>
        <div class="sparkle s1">‚ú®</div>
        <div class="sparkle s2">‚≠ê</div>
        <div class="sparkle s3">‚ú®</div>
        <div class="sparkle s4">üí´</div>
      </div>
      <p class="magic-text" id="magic-status-text">Sehrbaz i≈ü…ô ba≈üladƒ±...</p>
    </div>
  </div>

  <div class="step-content" id="step-results">
    
    <div id="global-spell-bar" class="global-spell-wrapper hidden">
        <div class="gs-info">
            <span>üî• Aktiv Endirim:</span>
            <span id="gs-amount" class="gs-amount">-6.00 ‚Çº</span>
        </div>
        <div class="gs-timer-track">
            <div id="gs-timer-fill" class="gs-timer-fill"></div>
        </div>
    </div>

    <h2 class="title" style="font-size: 20px; margin-bottom: 10px;">Sizin √º√ß√ºn se√ßdikl…ôrimiz</h2>
    <div id="cards-wrapper"></div>
   
  </div>
</div>

<div class="floating-bar">
  <button class="float-btn" onclick="openAllProducts()">üõçÔ∏è B√ºt√ºn M…ôhsullar</button>
  <a href="https://brendimo-co.github.io/sanscarxi/" target="_blank" class="float-btn wheel" onclick="logUserAction('SpinWheel')">üéÅ H…ôdiyy…ô √áarxƒ±</a>
</div>

<div id="all-products-view" class="all-products-view">
  <div class="close-view-btn">
    <button onclick="closeAllProducts()" style="background:none; border:none; font-size:16px; font-weight:700; color:#333;">‚úï Baƒüla</button>
  </div>
  <h2 class="title" style="font-size:20px;">B√ºt√ºn M…ôhsullar</h2>
  <div class="grid-container" id="all-products-grid">
    </div>
  <button id="load-more-btn" class="load-more-btn" onclick="loadMoreGrid()">Daha √áox G√∂st…ôr (6)</button>
</div>

<div id="product-modal" class="modal">
  <div class="header"><div class="back-btn" onclick="closeModal()">‚úï Baƒüla</div></div>
  
  <img id="modal-img" src="" style="width:100%; border-radius:12px; margin-bottom:15px;">
  
  <h2 id="modal-title" style="margin-bottom:5px;"></h2>
  
  <div id="modal-spell-box" class="spell-box hidden">
    <div class="spell-header">
      <span>‚ö° Endirim ∆èriyir...</span>
      <span class="spell-amount" id="modal-spell-amount">-6.00 ‚Çº</span>
    </div>
    <div class="spell-timer-track">
      <div class="spell-timer-bar" id="modal-spell-bar"></div>
    </div>
    <p class="spell-warning">H…ôr 30 saniy…ôd…ôn bir 0.50 q…ôpik azalƒ±r!</p>
  </div>

  <h3 id="modal-price" style="color:#c21a1a; margin-bottom:15px;"></h3>
  <p id="modal-desc" style="line-height:1.6; color:#555; margin-bottom:20px;"></p>
  
  <button id="modal-whatsapp-btn" class="float-btn" style="width:100%; justify-content:center; background:#25D366; color:white;">
    WhatsApp il…ô Sifari≈ü Et
  </button>
</div>

<script>
// --- CONFIGURATION ---
const SHEETS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxe3u8E5WYNQp_e_OIDlJbR7rbmTVLdHHzc2rrhseUhFwddRDv74s2PhZKOKm3l3Qpw/exec"; 
const WHATSAPP_NUMBER = "994556742535";

// --- STATE ---
let currentStep = 0;
const totalSteps = 5;
const state = { who: null, occasion: null, mood: null, style: null, budget: null, products: [], cardStack: [] };
let gridLimit = 6; // Start with 6 items (3 rows x 2 cols)

// --- LOGGING ---
function logUserAction(action, details = '') {
  // If we haven't fetched the IP yet, use 'Loading...'
  const currentIP = typeof userIP !== 'undefined' ? userIP : 'Unknown';
  
  fetch(SHEETS_ENDPOINT, {
    method: 'POST',
    mode: 'no-cors',
    // keepalive ensures the request completes even if the user closes the tab
    keepalive: true, 
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ 
      type: 'log', 
      action: action, 
      // We append the IP to the details column automatically
      details: `[IP: ${currentIP}] ${details}` 
    })
  }).catch(e => console.log("Logging failed", e));
}

// --- NAVIGATION ---
function updateUI() {
  document.getElementById('step-count').textContent = (currentStep < totalSteps) ? `ADDIM ${currentStep + 1}/${totalSteps}` : 'N∆èTƒ∞C∆è';
  document.getElementById('progress-bar').style.width = `${((currentStep + 1) / totalSteps) * 100}%`;
  document.querySelector('.back-btn').style.opacity = currentStep === 0 ? '0' : '1';

  document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
  
  if (currentStep < totalSteps) {
    document.getElementById(`step-${currentStep}`).classList.add('active');
  } else if (currentStep === totalSteps) {
    document.getElementById('step-loading').classList.add('active');
    fetchProducts();
  } else {
    document.getElementById('step-results').classList.add('active');
  }
}

function goBack() {
  if (currentStep > 0) { currentStep--; updateUI(); }
}

function handleOptionClick(e, key) {
  const card = e.target.closest('.option-card');
  if (!card) return;
  state[key] = card.getAttribute('data-val');
  logUserAction('StepCompleted', `${key}: ${state[key]}`);
  currentStep++;
  updateUI();
}

  
// --- DATA ---

// 1. Shuffle Function
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// 2. Fetch Products with 6-second Magic Animation
// 2. Fetch Products with 4.5-second Magic Animation
async function fetchProducts() {
  const statusTextEl = document.getElementById('magic-status-text');
  
  // STORYTELLING MESSAGES
  const messages = [
    "Ulduzlar yoxlanƒ±lƒ±r... ‚ú®",          
    "Z√∂vql…ôr analiz edilir... üß†",       
    "Axtardƒ±ƒüƒ±n se√ßiml…ôr √ºmumil…ô≈üdirilir... üîç",  
    "Sehr tamamlanƒ±r... ü™Ñ"              
  ];
  
  let msgIndex = 0;
  statusTextEl.textContent = messages[0];

  // CHANGE 1: Speed up text to 1100ms (so 4 messages fit in 4.5s)
  const textInterval = setInterval(() => {
    msgIndex++;
    if (msgIndex < messages.length) {
      statusTextEl.style.animation = 'none';
      statusTextEl.offsetHeight; 
      statusTextEl.style.animation = 'textFade 1.0s ease';
      statusTextEl.textContent = messages[msgIndex];
    }
  }, 1100); 

  try {
    const [response, _] = await Promise.all([
      fetch(`${SHEETS_ENDPOINT}?action=getProducts`), 
      // CHANGE 2: Set wait time to 4500ms (4.5 seconds)
      new Promise(resolve => setTimeout(resolve, 4500)) 
    ]);

    const data = await response.json();
    clearInterval(textInterval);

    state.products = shuffleArray(data.products || []);
    processMatches();
    
    currentStep++;
    updateUI();
    renderCards();
    
  } catch (error) {
    clearInterval(textInterval);
    console.error(error);
    document.getElementById('step-loading').innerHTML = "<p style='text-align:center; margin-top:50px;'>X…ôta ba≈ü verdi. ƒ∞nternet …ôlaq…ôsini yoxlayƒ±n.</p>";
  }
}
  
// 3. Process Matches
function processMatches() {
  let candidates = shuffleArray([...state.products]);
  if (state.who) {
    candidates = candidates.filter(p => match(p.target, state.who));
  }

  state.cardStack = candidates.map(p => {
    let score = 0;
    if (match(p.target, state.who)) score += 40; 
    if (match(p.occasion, state.occasion)) score += 20;
    if (match(p.mood, state.mood)) score += 15;
    if (match(p.style, state.style)) score += 15;
    if (!checkBudget(p.price, state.budget)) score -= 30;
    p.score = Math.min(100, Math.max(0, score));
    return p;
  }).sort((a, b) => b.score - a.score);
}

function match(dbField, userSelect) {
  if (!dbField || !userSelect) return false;
  return dbField.toLowerCase().includes(userSelect.toLowerCase());
}

function checkBudget(price, budgetStr) {
  const p = Number(price);
  if (!budgetStr) return true;
  if (budgetStr === '0-20') return p <= 20;
  if (budgetStr === '20-50') return p > 20 && p <= 50;
  if (budgetStr === '50-100') return p > 50 && p <= 100;
  if (budgetStr === '100+') return p > 100;
  return true;
}

function renderCards() {
  const container = document.getElementById('cards-wrapper');
  container.innerHTML = '';
  
  if (state.cardStack.length === 0) {
    container.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">T…ô…ôss√ºf ki, uyƒüun m…ôhsul tapƒ±lmadƒ±.<br>Dig…ôr se√ßiml…ôri yoxlayƒ±n.</div>';
    return;
  }

  state.cardStack.slice(0, 5).forEach((p, index) => {
    const card = document.createElement('div');
    card.className = 'card';
    card.style.zIndex = state.cardStack.length - index;
    
    card.innerHTML = `
      <div class="card-image-box">
         <div class="match-badge">üî• ${p.score}%</div>
<img src="${fixImageLink(p.image)}" alt="${p.name}">

</div>
      
      <div class="card-info">
        <div class="card-text-group">
          <div class="premium-badge">‚ú®Premium H…ôdiyy…ôlik Qabla≈üdƒ±rma v…ô √áatdƒ±rƒ±lma Daxildir</div>
          <h3>${p.name}</h3>
          <p>${p.description || 'Bu h…ôdiyy…ô x√ºsusi g√ºnl…ôr √º√ß√ºn ideal se√ßimdir.'}</p>
        </div>
        
        <div class="card-footer">
          <div class="price-box">
            <span class="price-label">Qiym…ôt</span>
            <span class="price-tag">${p.price} ‚Çº</span>
          </div>
          <div class="details-arrow">‚ûù</div>
        </div>
      </div>
    `;
    
    if (index === 0) initSwipe(card, p);
    container.appendChild(card);
  });
}


function initSwipe(card, product) {
  let startX = 0, currentX = 0, isDragging = false;

  const onStart = (e) => {
    isDragging = true;
    startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    currentX = 0; 
    card.style.transition = 'none';
  };

  const onMove = (e) => {
    if (!isDragging) return;
    const x = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    currentX = x - startX;
    
    const rotate = currentX / 15;
    card.style.transform = `translateX(${currentX}px) rotate(${rotate}deg)`;
  };

  const onEnd = () => {
    if (!isDragging) return;
    isDragging = false;
    
    // CLICK DETECTION
    if (Math.abs(currentX) < 10) {
      openModal(product); 
      card.style.transform = 'translateX(0) rotate(0)';
      return;
    }

    // SWIPE LOGIC
    if (Math.abs(currentX) > 100) {
      const dir = currentX > 0 ? 1 : -1;
      card.style.transition = 'transform 0.4s ease';
      card.style.transform = `translateX(${dir * window.innerWidth * 1.5}px) rotate(${dir * 30}deg)`;
      
      setTimeout(() => {
        card.remove();
        state.cardStack.shift();
        if (dir === 1) {
            // ACTIVATE GLOBAL DISCOUNT IF THEY LIKE
            activateGlobalDiscount();
            redirectToWhatsApp(product);
        }
        else logUserAction('Skipped', product.name);
        renderCards();
      }, 300);
    } else {
      card.style.transition = 'transform 0.3s ease';
      card.style.transform = 'translateX(0)';
    }
    currentX = 0;
  };

  card.addEventListener('mousedown', onStart);
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onEnd);
  
  card.addEventListener('touchstart', onStart);
  document.addEventListener('touchmove', onMove);
  document.addEventListener('touchend', onEnd);
}

// --- ALL PRODUCTS VIEW ---
function openAllProducts() {
  logUserAction('ViewAllProducts');
  if(state.products.length === 0) fetchProducts(); 
  document.getElementById('all-products-view').classList.add('active');
  renderGrid();
}

function closeAllProducts() {
  document.getElementById('all-products-view').classList.remove('active');
}

function renderGrid() {
  const container = document.getElementById('all-products-grid');
  container.innerHTML = '';
  const source = state.products.length ? state.products : [];
  
  source.slice(0, gridLimit).forEach(p => {
    const el = document.createElement('div');
    el.className = 'grid-item';
    el.onclick = () => openModal(p);
    el.innerHTML = `
<img src="${fixImageLink(p.image)}" loading="lazy">

<div class="grid-info">
        <div class="grid-title">${p.name}</div>
        <div class="grid-price">${p.price} AZN</div>
      </div>
    `;
    container.appendChild(el);
  });
  
  const btn = document.getElementById('load-more-btn');
  if(gridLimit >= source.length) btn.style.display = 'none';
  else btn.style.display = 'block';
}

  
function loadMoreGrid() {
  gridLimit += 6; 
  renderGrid();
  logUserAction('LoadMoreProducts');
}


// --- GLOBAL DISCOUNT LOGIC (SINGLETON) ---
let globalDiscount = 6.00;     // Starts at 6 AZN
const discountStep = 0.50;     // Drops by 0.50 AZN
const stepDuration = 30;       // Every 30 seconds
let secondsLeftInStep = 30;    // Countdown for current step
let isTimerActive = false;     // Ensures it only starts once
let globalTimerInterval = null;

function activateGlobalDiscount() {
    if (isTimerActive) return; 
    isTimerActive = true;

    // Show Bars
    const mainBar = document.getElementById('global-spell-bar');
    const modalBar = document.getElementById('modal-spell-box');
    
    if(mainBar) mainBar.classList.remove('hidden');
    if(modalBar) modalBar.classList.remove('hidden');

    globalTimerInterval = setInterval(() => {
        secondsLeftInStep--;
        updateDiscountProgressUI();

        if (secondsLeftInStep <= 0) {
            secondsLeftInStep = stepDuration; 
            
            if (globalDiscount > 0) {
                globalDiscount -= discountStep;
                // Fix floating point math
                globalDiscount = Math.round(globalDiscount * 100) / 100;
                triggerDropEffect(); 
            } else {
                globalDiscount = 0;
                clearInterval(globalTimerInterval); 
            }
        }
        updateDiscountTextUI();
    }, 1000);
}

function updateDiscountTextUI() {
    const formattedPrice = `-${globalDiscount.toFixed(2)} ‚Çº`;
    
    const gsAmount = document.getElementById('gs-amount');
    const msAmount = document.getElementById('modal-spell-amount');
    
    if(gsAmount) gsAmount.textContent = formattedPrice;
    if(msAmount) msAmount.textContent = formattedPrice;
    
    if(globalDiscount === 0) {
         if(gsAmount) gsAmount.textContent = "0.00 ‚Çº";
         const warn = document.querySelector('.spell-warning');
         if(warn) warn.textContent = "Endirim m√ºdd…ôti bitdi.";
    }
}

function updateDiscountProgressUI() {
    const percent = (secondsLeftInStep / stepDuration) * 100;
    
    const gsFill = document.getElementById('gs-timer-fill');
    const msFill = document.getElementById('modal-spell-bar');
    
    if(gsFill) gsFill.style.width = `${percent}%`;
    if(msFill) msFill.style.width = `${percent}%`;
}

function triggerDropEffect() {
    const els = [document.getElementById('gs-amount'), document.getElementById('modal-spell-amount')];
    els.forEach(el => {
        if(el) {
            el.classList.add('shake-text');
            setTimeout(() => el.classList.remove('shake-text'), 500);
        }
    });
}

// --- MODAL & ACTIONS ---

function openModal(p) {
  logUserAction('ViewDetails', p.name);
  
  // 1. Trigger Global Timer
  activateGlobalDiscount(); 
  
  // 2. Set Modal Content
  document.getElementById('modal-img').src = p.image;
  document.getElementById('modal-title').textContent = p.name;
  document.getElementById('modal-price').textContent = p.price + ' AZN';
  document.getElementById('modal-desc').textContent = p.description;
  
  // 3. Update Text
  updateDiscountTextUI();
  
  // 4. Set Button
  const btn = document.getElementById('modal-whatsapp-btn');
  btn.onclick = () => redirectToWhatsApp(p);
  
  document.getElementById('product-modal').classList.add('active');
}

function closeModal() { document.getElementById('product-modal').classList.remove('active'); }

function redirectToWhatsApp(p) {
  logUserAction('Like_WhatsApp', p.name);
  
  const finalPrice = Math.max(0, p.price - globalDiscount).toFixed(2);
  const discountVal = globalDiscount.toFixed(2);
  
  let priceText = `${p.price} AZN`;
  if (globalDiscount > 0) {
    priceText = `${p.price} AZN\nüî• Aktiv Endirim: -${discountVal} AZN\n‚úÖ YEKUN: ${finalPrice} AZN`;
  }
  
  const text = `Salam Brendimo! üéÅ\n\nM…ôn bu m…ôhsulu b…ôy…ôndim:\n*${p.name}*\n${priceText}\n\nBu da ≈ü…ôkli:\n${p.image}\n\nSifari≈ü etm…ôk ist…ôyir…ôm.`;
  
  const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`;
  
  setTimeout(() => window.location.href = url, 100); 
}

// Init
updateUI();

// --- SESSION TRACKING ---
let sessionStartTime = Date.now();
let userIP = "Fetching...";

async function initTracking() {
  try {
    const response = await fetch('https://api.ipify.org?format=json');
    const data = await response.json();
    userIP = data.ip;
  } catch (err) { userIP = "Hidden/Error"; }
  const device = navigator.userAgent; 
  logUserAction('SessionStart', `Device: ${device}`);
}

document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') {
    const timeSpent = Math.round((Date.now() - sessionStartTime) / 1000); 
    logUserAction('SessionEnd', `Total Time: ${timeSpent} seconds`);
  }
});

function restartApp() {
  state.who = null;
  state.occasion = null;
  state.mood = null;
  state.style = null;
  state.budget = null;
  
  currentStep = 0;
  updateUI();
  closeAllProducts();
  closeModal();
}

function fixImageLink(url) {
  if (!url) return 'https://via.placeholder.com/300?text=No+Image'; // Fallback

  // 1. Fix Google Drive Links
  if (url.includes('drive.google.com') || url.includes('docs.google.com')) {
    // Extract the ID
    const idMatch = url.match(/[-\w]{25,}/);
    if (idMatch) {
      // Use the high-performance Google User Content server
      return `https://lh3.googleusercontent.com/d/${idMatch[0]}`;
    }
  }

  // 2. Fix GitHub Blob Links (which are HTML pages)
  if (url.includes('github.com') && url.includes('/blob/')) {
    // Convert to raw.githubusercontent.com
    return url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
  }

  return url;
}

  
initTracking();
  
</script>
</body>
</html>
