<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Brendimo H…ôdiyy…ô Sehrbazƒ±</title>
<meta property="og:type" content="website">
<meta property="og:title" content="üéÅ Brendimo H…ôdiyy…ô Sehrbazƒ±">
<meta property="og:description" content="H…ôdiyy…ô axtarƒ±≈üƒ±ndan yorulmusan? 30 saniy…ôy…ô ideal h…ôdiyy…ôni tap!">
<meta property="og:image" content="https://github.com/Brendimo-co/sehrbaz/blob/main/Gemini_Generated_Image_hzsbephzsbephzsb.png?raw=true">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* --- CSS STYLES --- */

/* RESET & BASE */
* { margin: 0; padding: 0; box-sizing: border-box; font-family: "Inter", sans-serif; -webkit-tap-highlight-color: transparent; }
body { background: #fafafa; color: #1d1d1f; overflow-x: hidden; height: 100vh; display: flex; flex-direction: column; }

/* LAYOUT */
.wizard-wrapper {
  flex: 1; width: 100%; max-width: 440px; margin: 0 auto; padding: 15px 20px 40px 20px; 
  display: flex; flex-direction: column; position: relative;
}

/* HEADER */
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; height: 40px; }
.back-btn { font-size: 14px; color: #777; cursor: pointer; display: flex; align-items: center; gap: 4px; font-weight: 600; }
.logo { font-size: 20px; font-weight: 800; color: #c21a1a; letter-spacing: -0.5px; cursor: pointer; }
.step-indicator { font-size: 12px; color: #999; font-weight: 600; background: #eee; padding: 4px 8px; border-radius: 12px; }

/* TOP ACTIONS */
.top-actions { display: flex; gap: 10px; justify-content: center; margin-bottom: 25px; }
.top-btn {
  background: white; border: 1px solid #e5e5e5; padding: 8px 14px; border-radius: 20px; 
  font-size: 12px; font-weight: 600; color: #333; cursor: pointer; display: flex; align-items: center; gap: 6px; 
  box-shadow: 0 2px 6px rgba(0,0,0,0.03); text-decoration: none; transition: transform 0.1s;
}
.top-btn:active { transform: scale(0.95); }
.top-btn.wheel { background: linear-gradient(135deg, #fffcf2, #fff8e1); color: #b78900; border-color: #ffe082; }

/* PROGRESS */
.progress-container { height: 4px; background: #eee; border-radius: 2px; margin-bottom: 30px; overflow: hidden; }
.progress-fill { height: 100%; background: #c21a1a; width: 20%; transition: width 0.4s ease; }

/* STEPS */
.step-content { display: none; animation: fadeIn 0.4s ease; }
.step-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.title { font-size: 24px; font-weight: 700; margin-bottom: 24px; text-align: center; line-height: 1.3; }

/* OPTIONS GRID */
.options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.option-card {
  background: white; border: 2px solid #f0f0f0; border-radius: 16px; padding: 20px 10px;
  text-align: center; cursor: pointer; transition: all 0.2s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.03);
}
.option-card:active { transform: scale(0.96); border-color: #c21a1a; background: #fffcfc; }
.option-icon { font-size: 32px; margin-bottom: 8px; display: block; }
.option-text { font-size: 15px; font-weight: 600; color: #333; }

/* CARDS STACK */
#cards-wrapper { 
  position: relative; width: 100%; height: 65vh; max-height: 600px; min-height: 450px;
  margin-top: 10px; perspective: 1000px; 
}
.card {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  background: #ffffff; border-radius: 28px; box-shadow: 0 20px 50px -12px rgba(0,0,0,0.1);
  overflow: hidden; transform-origin: 50% 100%; will-change: transform; touch-action: none;
  display: flex; flex-direction: column; padding: 12px; 
}
.card-image-box {
  position: relative; width: 100%; height: 68%; border-radius: 20px;
  overflow: hidden; background: #f4f4f5; display: flex; align-items: center; justify-content: center;
}
.card-image-box img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }

/* BADGES */
.match-badge {
  position: absolute; top: 12px; right: 12px; background: rgba(255, 255, 255, 0.9);
  color: #c21a1a; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 800;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08); backdrop-filter: blur(4px); z-index: 2;
}
.badge-bestseller {
  position: absolute; top: 12px; left: 12px; background: #FFD700; color: #000;
  padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 800;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15); z-index: 3; display: flex; align-items: center; gap: 4px;
}
.badge-lowstock {
  position: absolute; bottom: 12px; left: 12px; background: #c21a1a; color: white;
  padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 700;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15); z-index: 3;
}

.card-info { flex: 1; padding: 16px 8px 8px 8px; display: flex; flex-direction: column; justify-content: flex-end; }
.card h3 { 
  font-size: 22px; font-weight: 700; color: #1a1a1a; margin: 0 0 6px 0; letter-spacing: -0.5px;
  line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}
.card-desc-preview {
  font-size: 14px; color: #888; font-weight: 400; margin-bottom: auto; line-height: 1.4;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}
.card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }
.price-tag { font-size: 26px; font-weight: 800; color: #1a1a1a; letter-spacing: -1px; }
.price-currency { font-size: 16px; font-weight: 600; color: #999; margin-left: 4px; }
.swipe-hint {
  width: 40px; height: 40px; background: #1a1a1a; border-radius: 50%;
  display: flex; align-items: center; justify-content: center; color: white;
  font-size: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* --- THE COOL FEAR-INDUCING DISCOUNT BAR --- */
.fear-bar-wrapper {
    background: linear-gradient(135deg, #111, #222);
    color: white; padding: 12px 16px; border-radius: 12px;
    margin-bottom: 20px; border: 1px solid #FFD700;
    box-shadow: 0 8px 20px rgba(0,0,0,0.25);
    animation: slideDown 0.6s ease;
    position: relative; overflow: hidden;
}
.fear-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.fear-title { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #ccc; }
.fear-amount { 
    font-size: 22px; font-weight: 800; color: #FFD700; 
    text-shadow: 0 0 15px rgba(255, 215, 0, 0.4); 
    font-variant-numeric: tabular-nums;
}
.shake-it { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; color: #ff4d4d !important; text-shadow: 0 0 10px rgba(255, 77, 77, 0.6); }

.timer-track { width: 100%; height: 6px; background: rgba(255,255,255,0.15); border-radius: 3px; overflow: hidden; }
.timer-fill { 
    height: 100%; background: linear-gradient(90deg, #FFD700, #ff4d4d); 
    width: 100%; transition: width 1s linear; 
}
.fear-warning { 
    margin-top: 6px; font-size: 11px; color: #ff6b6b; font-weight: 600; 
    text-align: right; font-style: italic; opacity: 0; animation: flashWarn 2s infinite; 
}
@keyframes flashWarn { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
@keyframes shake { 
    10%, 90% { transform: translate3d(-1px, 0, 0); }
    20%, 80% { transform: translate3d(2px, 0, 0); }
    30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
    40%, 60% { transform: translate3d(4px, 0, 0); }
}

/* NOTIFICATION TOAST */
.notif-toast {
    position: fixed; top: 15px; left: 50%; transform: translateX(-50%) translateY(-100px);
    background: white; border-radius: 30px; padding: 8px 16px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.15); z-index: 999;
    display: flex; align-items: center; gap: 10px; min-width: 280px;
    transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: 1px solid #eee;
}
.notif-toast.show { transform: translateX(-50%) translateY(0); }
.notif-icon { width: 32px; height: 32px; background: #e0f2fe; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; }
.notif-content { display: flex; flex-direction: column; }
.notif-title { font-size: 11px; color: #888; font-weight: 600; }
.notif-desc { font-size: 13px; font-weight: 700; color: #333; }

/* MODAL */
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 200; padding: 24px; overflow-y: auto; display: none; }
.modal.active { display: block; animation: slideUp 0.3s ease; }

/* ALL PRODUCTS GRID */
.all-products-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fafafa; z-index: 100; overflow-y: auto; padding: 20px; display: none; }
.all-products-view.active { display: block; animation: slideUp 0.3s ease; }
.grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding-bottom: 40px; }
.grid-item { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; }
.grid-item img { width: 100%; height: 140px; object-fit: cover; }
.grid-info { padding: 10px; }
.grid-title { font-size: 13px; font-weight: 700; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.grid-price { font-size: 14px; color: #c21a1a; font-weight: 700; }

/* MAGIC LOADER */
.magic-loader-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 60vh; position: relative; }
.magic-wand-wrapper { position: relative; width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; }
.magic-wand { font-size: 64px; z-index: 2; animation: waveWand 2.5s ease-in-out infinite; transform-origin: bottom left; }
.magic-aura { position: absolute; width: 60px; height: 60px; background: radial-gradient(circle, rgba(194, 26, 26, 0.4) 0%, rgba(255, 215, 0, 0) 70%); border-radius: 50%; animation: pulseGlow 2s infinite; z-index: 1; }
.sparkle { position: absolute; color: #FFD700; font-size: 20px; opacity: 0; animation: sparkleFloat 2s infinite; }
.s1 { top: 0; right: 0; animation-delay: 0.2s; }
.s2 { top: 20px; left: -10px; animation-delay: 0.5s; font-size: 14px; }
.s3 { bottom: 0; right: -10px; animation-delay: 0.8s; font-size: 24px; }
.s4 { bottom: 20px; left: 0; animation-delay: 1.2s; }
.magic-text { margin-top: 30px; font-size: 18px; font-weight: 600; color: #555; text-align: center; animation: textFade 0.5s; min-height: 25px; }

@keyframes waveWand { 0% { transform: rotate(0deg); } 25% { transform: rotate(-15deg); } 50% { transform: rotate(0deg); } 75% { transform: rotate(10deg); } 100% { transform: rotate(0deg); } }
@keyframes pulseGlow { 0% { transform: scale(0.8); opacity: 0.5; } 50% { transform: scale(1.5); opacity: 0.2; } 100% { transform: scale(0.8); opacity: 0.5; } }
@keyframes sparkleFloat { 0% { transform: translateY(0) scale(0); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(-40px) scale(1.2); opacity: 0; } }
@keyframes textFade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.hidden { display: none !important; }

</style>
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '752296677155305');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=752296677155305&ev=PageView&noscript=1"
/></noscript>
</head>
<body>

<div id="notif-toast" class="notif-toast">
    <div class="notif-icon">üì¶</div>
    <div class="notif-content">
        <span class="notif-title" id="notif-user">...</span>
        <span class="notif-desc" id="notif-product">...</span>
    </div>
</div>

<div class="wizard-wrapper">
 <div class="header">
    <div class="back-btn" onclick="goBack()">‚Üê Geri</div>
    <div class="logo" onclick="restartApp()">üéÅ Brendimo</div>
    <div class="step-indicator" id="step-count">1/5</div>
</div>

 <div class="top-actions">
    <button class="top-btn" onclick="openAllProducts()">üõçÔ∏è B√ºt√ºn M…ôhsullar</button>
    <a href="https://brendimo-co.github.io/sanscarxi/" target="_blank" class="top-btn wheel" onclick="logUserAction('SpinWheel')">üéÅ H…ôdiyy…ô √áarxƒ±</a>
 </div>

  <div class="progress-container">
    <div class="progress-fill" id="progress-bar"></div>
  </div>

  <div class="step-content active" id="step-0">
    <h2 class="title">H…ôdiyy…ô kimin √º√ß√ºnd√ºr?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'who')">
      <div class="option-card" data-val="Xanƒ±m"><span class="option-icon">üë©</span><span class="option-text">Xanƒ±m</span></div>
      <div class="option-card" data-val="B…ôy"><span class="option-icon">üë®</span><span class="option-text">B…ôy</span></div>
      <div class="option-card" data-val="U≈üaq"><span class="option-icon">üßí</span><span class="option-text">U≈üaq</span></div>
      <div class="option-card" data-val="H…ômkar"><span class="option-icon">üíº</span><span class="option-text">H…ômkar</span></div>
    </div>
  </div>

  <div class="step-content" id="step-1">
    <h2 class="title">Hansƒ± √∂z…ôl g√ºn √º√ß√ºn?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'occasion')">
      <div class="option-card" data-val="Ad g√ºn√º"><span class="option-icon">üéÇ</span><span class="option-text">Ad g√ºn√º</span></div>
      <div class="option-card" data-val="Yubiley"><span class="option-icon">ü•Ç</span><span class="option-text">Yubiley</span></div>
      <div class="option-card" data-val="Yeni ƒ∞l"><span class="option-icon">üéÑ</span><span class="option-text">Yeni ƒ∞l</span></div>
      <div class="option-card" data-val="S…ôb…ôbsiz"><span class="option-icon">üíù</span><span class="option-text">Sad…ôc…ô H…ôdiyy…ô</span></div>
    </div>
  </div>

  <div class="step-content" id="step-2">
    <h2 class="title">H…ôdiyy…ônin aurasƒ± nec…ô olsun?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'mood')">
      <div class="option-card" data-val="Romantik"><span class="option-icon">üåπ</span><span class="option-text">Romantik</span></div>
      <div class="option-card" data-val="R…ôsmi"><span class="option-icon">üëî</span><span class="option-text">R…ôsmi</span></div>
      <div class="option-card" data-val="Fun"><span class="option-icon">üéâ</span><span class="option-text">∆èyl…ônc…ôli</span></div>
      <div class="option-card" data-val="Faydalƒ±"><span class="option-icon">üìö</span><span class="option-text">Praktik/Faydalƒ±</span></div>
    </div>
  </div>

  <div class="step-content" id="step-3">
    <h2 class="title">Stil se√ßimi</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'style')">
      <div class="option-card" data-val="Modern"><span class="option-icon">‚ú®</span><span class="option-text">Modern</span></div>
      <div class="option-card" data-val="Klassik"><span class="option-icon">üèõÔ∏è</span><span class="option-text">Klassik</span></div>
      <div class="option-card" data-val="Minimal"><span class="option-icon">‚ö™</span><span class="option-text">Minimalist</span></div>
      <div class="option-card" data-val="L√ºks"><span class="option-icon">üíé</span><span class="option-text">L√ºks</span></div>
    </div>
  </div>

  <div class="step-content" id="step-4">
    <h2 class="title">B√ºdc…ô aralƒ±ƒüƒ±nƒ±z?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'budget')">
      <div class="option-card" data-val="0-30"><span class="option-icon">ü™ô</span><span class="option-text">0 - 30 AZN</span></div>
      <div class="option-card" data-val="30-60"><span class="option-icon">üíµ</span><span class="option-text">30 - 60 AZN</span></div>
      <div class="option-card" data-val="60-120"><span class="option-icon">üí∞</span><span class="option-text">60 - 120 AZN</span></div>
      <div class="option-card" data-val="120+"><span class="option-icon">üí≥</span><span class="option-text">120+ AZN</span></div>
    </div>
  </div>

  <div class="step-content" id="step-loading">
    <div class="magic-loader-container">
      <div class="magic-wand-wrapper">
        <div class="magic-wand">ü™Ñ</div>
        <div class="magic-aura"></div>
        <div class="sparkle s1">‚ú®</div>
        <div class="sparkle s2">‚≠ê</div>
        <div class="sparkle s3">‚ú®</div>
        <div class="sparkle s4">üí´</div>
      </div>
      <p class="magic-text" id="magic-status-text">Sehrli alqoritm i≈ü…ô d√º≈üd√º...</p>
    </div>
  </div>

  <div class="step-content" id="step-results">
    
    <div id="fear-bar-main" class="fear-bar-wrapper hidden">
        <div class="fear-header">
            <span class="fear-title">üî• ENDƒ∞Rƒ∞M ∆èRƒ∞Yƒ∞R...</span>
            <span id="gs-amount" class="fear-amount">-6.00 ‚Çº</span>
        </div>
        <div class="timer-track">
            <div id="gs-timer-fill" class="timer-fill"></div>
        </div>
        <div class="fear-warning">T…ôl…ôsin! H…ôr 30 saniy…ôd…ô 0.50 ‚Çº itirirsiniz!</div>
    </div>

    <h2 class="title" style="font-size: 20px; margin-bottom: 10px;">Sizin √º√ß√ºn se√ßdikl…ôrimiz</h2>
    <div id="cards-wrapper"></div>
  </div>
</div>

<div id="all-products-view" class="all-products-view">
  <div style="position:sticky; top:0; z-index:2; display:flex; justify-content:flex-end; padding-bottom:10px;">
    <button onclick="closeAllProducts()" style="background:#eee; border:none; padding:8px 16px; border-radius:20px; font-weight:700;">‚úï Baƒüla</button>
  </div>
  <h2 class="title" style="font-size:20px;">B√ºt√ºn M…ôhsullar</h2>
  <div class="grid-container" id="all-products-grid"></div>
  <button id="load-more-btn" class="load-more-btn" onclick="loadMoreGrid()" style="width:100%; padding:12px; background:#eee; border:none; border-radius:8px;">Daha √áox G√∂st…ôr (6)</button>
</div>

<div id="product-modal" class="modal">
  <div class="header"><div class="back-btn" onclick="closeModal()">‚úï Baƒüla</div></div>
  
  <img id="modal-img" src="" style="width:100%; border-radius:12px; margin-bottom:15px;">
  
  <h2 id="modal-title" style="margin-bottom:5px;"></h2>

  <div id="fear-bar-modal" class="fear-bar-wrapper" style="margin-bottom: 15px; padding: 10px;">
      <div class="fear-header">
          <span class="fear-title" style="font-size: 11px;">‚ö†Ô∏è QA√áIRMA!</span>
          <span id="modal-fear-amount" class="fear-amount" style="font-size: 18px;">-6.00 ‚Çº</span>
      </div>
      <div class="timer-track" style="height: 4px;">
          <div id="modal-timer-fill" class="timer-fill"></div>
      </div>
  </div>
  
  <h3 id="modal-price" style="color:#c21a1a; margin-bottom:20px; font-size:28px;"></h3>
  
  <p id="modal-desc" style="line-height:1.6; color:#444; margin-bottom:30px; white-space: pre-line;"></p>
  
  <button id="modal-whatsapp-btn" class="float-btn" style="width:100%; padding:16px; border-radius:12px; border:none; font-weight:700; font-size:16px; background:#25D366; color:white;">
    WhatsApp il…ô Sifari≈ü Et
  </button>
</div>

<script>
// --- CONFIGURATION ---
const SHEETS_ENDPOINT = "https://script.google.com/macros/s/AKfycbwnQvncFk983Q0zEO7WLoug87JKEvXoH1VgKTC9wxHCyIgWVGQMYvrV0KnsJDs4LncR/exec"; 
const WHATSAPP_NUMBER = "994556742535";

// --- STATE ---
let currentStep = 0;
const totalSteps = 5;
const state = { who: null, occasion: null, mood: null, style: null, budget: null, products: [], cardStack: [], orders: [] };
let gridLimit = 6; 

// --- NAVIGATION ---
function updateUI() {
  document.getElementById('step-count').textContent = (currentStep < totalSteps) ? `ADDIM ${currentStep + 1}/${totalSteps}` : 'N∆èTƒ∞C∆è';
  document.getElementById('progress-bar').style.width = `${((currentStep + 1) / totalSteps) * 100}%`;
  document.querySelector('.back-btn').style.opacity = currentStep === 0 ? '0' : '1';

  document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
  
  if (currentStep < totalSteps) {
    document.getElementById(`step-${currentStep}`).classList.add('active');
  } else if (currentStep === totalSteps) {
    document.getElementById('step-loading').classList.add('active');
    fetchProducts();
  } else {
    document.getElementById('step-results').classList.add('active');
    activateGlobalDiscount(); // START THE FEAR!
  }
}

function goBack() { if (currentStep > 0) { currentStep--; updateUI(); } }

function handleOptionClick(e, key) {
  const card = e.target.closest('.option-card');
  if (!card) return;
  state[key] = card.getAttribute('data-val');
  logUserAction('StepCompleted', `${key}: ${state[key]}`);
  currentStep++;
  updateUI();
}
  
// --- DATA FETCHING & MAGIC TEXT ---
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

async function fetchProducts() {
  const statusTextEl = document.getElementById('magic-status-text');
  
  // 10 TEXT OPTIONS - FEAR REMOVAL DURING LOADING
  const messages = [
    "Sehrli alqoritm i≈ü…ô d√º≈üd√º... ü™Ñ",
    "X√ºsusi hiss etdirsin... ‚ú®",
    "Ucuz g√∂rs…ônm…ôsin... üíé",
    "Z√∂vql…ôr analiz edilir... üß†",
    "∆èn keyfiyy…ôtli se√ßiml…ôr... üåü",
    "Sƒ±radan olanlar silinir... ‚ùå",
    "B√ºdc…ôniz…ô uyƒüunla≈üƒ±r... üìâ",
    "Sevindirm…ôk z…ôman…ôti... üéÅ",
    "ƒ∞deal h…ôdiyy…ô tapƒ±ldƒ±! üéØ"
  ];
  
  let msgIndex = 0;
  statusTextEl.textContent = messages[0];

  const textInterval = setInterval(() => {
    msgIndex++;
    if (msgIndex < messages.length) {
      statusTextEl.style.animation = 'none';
      statusTextEl.offsetHeight; 
      statusTextEl.style.animation = 'textFade 0.5s ease';
      statusTextEl.textContent = messages[msgIndex];
    }
  }, 450); 

  try {
    const [prodRes, orderRes, _] = await Promise.all([
      fetch(`${SHEETS_ENDPOINT}?action=getProducts`),
      fetch(`${SHEETS_ENDPOINT}?action=getOrders`),
      new Promise(resolve => setTimeout(resolve, 5800)) 
    ]);

    const prodData = await prodRes.json();
    const orderData = await orderRes.json();
    
    clearInterval(textInterval);

    state.products = shuffleArray(prodData.products || []);
    state.orders = orderData.orders || [];

    applyBadges(state.products);
    
    processMatches();
    currentStep++;
    updateUI();
    renderCards();
    startOrderNotifications();
    
  } catch (error) {
    clearInterval(textInterval);
    console.error(error);
    document.getElementById('step-loading').innerHTML = "<p style='text-align:center; margin-top:50px;'>X…ôta ba≈ü verdi. ƒ∞nternet …ôlaq…ôsini yoxlayƒ±n.</p>";
  }
}

function applyBadges(products) {
    products.forEach(p => { delete p.isBestSeller; delete p.isLowStock; });
    if(products[2]) products[2].isBestSeller = true;
    const lowStockIndices = [1, 4, 9, 16, 23];
    lowStockIndices.forEach(idx => {
        if(products[idx]) products[idx].isLowStock = true;
    });
}
  
function processMatches() {
  let candidates = shuffleArray([...state.products]);
  if (state.who) candidates = candidates.filter(p => match(p.target, state.who));

  state.cardStack = candidates.map(p => {
    let score = 0;
    if (match(p.target, state.who)) score += 40; 
    if (match(p.occasion, state.occasion)) score += 20;
    if (match(p.mood, state.mood)) score += 15;
    if (match(p.style, state.style)) score += 15;
    if (!checkBudget(p.price, state.budget)) score -= 30;
    p.score = Math.min(100, Math.max(0, score));
    return p;
  }).sort((a, b) => b.score - a.score);
}

function match(dbField, userSelect) {
  if (!dbField || !userSelect) return false;
  return dbField.toLowerCase().includes(userSelect.toLowerCase());
}

function checkBudget(price, budgetStr) {
  const p = Number(price);
  if (!budgetStr) return true;
  if (budgetStr === '0-30') return p <= 30;
  if (budgetStr === '30-60') return p > 30 && p <= 60;
  if (budgetStr === '60-120') return p > 60 && p <= 120;
  if (budgetStr === '120+') return p > 120;
  return true;
}

// --- RENDER CARDS ---
function renderCards() {
  const container = document.getElementById('cards-wrapper');
  container.innerHTML = '';
  
  if (state.cardStack.length === 0) {
    container.innerHTML = '<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#888;"><p>Ba≈üqa se√ßim qalmadƒ±.</p></div>';
    return;
  }

  state.cardStack.slice(0, 3).forEach((p, index) => {
    const card = document.createElement('div');
    card.className = 'card';
    const scale = 1 - (index * 0.05);
    const translateY = index * 20;
    card.style.zIndex = state.cardStack.length - index;
    card.style.transform = `translateY(${translateY}px) scale(${scale})`;
    if (index !== 0) card.style.opacity = '0.5';
    else card.style.boxShadow = "0 20px 50px -12px rgba(0,0,0,0.15)";

    let badgesHtml = `<div class="match-badge">${p.score}% Uyƒüunluq</div>`;
    if (p.isBestSeller) badgesHtml += `<div class="badge-bestseller">üèÜ H…ôft…ônin Best Selleri</div>`;
    if (p.isLowStock) badgesHtml += `<div class="badge-lowstock">‚ö†Ô∏è C…ômi 4 …ôd…ôd qaldƒ±</div>`;

    card.innerHTML = `
      <div class="card-image-box">
         ${badgesHtml}
         <img src="${fixImageLink(p.image)}" alt="${p.name}" draggable="false">
      </div>
      <div class="card-info">
        <h3>${p.name}</h3>
        <p class="card-desc-preview">${p.description || '∆ètraflƒ± m…ôlumat...'}</p>
        <div class="card-footer">
          <div><span class="price-tag">${p.price}</span><span class="price-currency">AZN</span></div>
          <div class="swipe-hint">üëâ</div>
        </div>
      </div>
    `;
    if (index === 0) initSwipe(card, p);
    container.appendChild(card);
  });
}

function initSwipe(card, product) {
  let startX = 0, currentX = 0, isDragging = false;
  const onStart = (e) => {
    isDragging = true;
    startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    card.style.transition = 'none';
  };
  const onMove = (e) => {
    if (!isDragging) return;
    const x = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    currentX = x - startX;
    card.style.transform = `translateX(${currentX}px) rotate(${currentX / 15}deg)`;
  };
  const onEnd = () => {
    if (!isDragging) return;
    isDragging = false;
    if (Math.abs(currentX) < 10) { openModal(product); card.style.transform = 'translateY(0) scale(1) rotate(0)'; return; }
    if (Math.abs(currentX) > 100) {
      const dir = currentX > 0 ? 1 : -1;
      card.style.transition = 'transform 0.4s ease';
      card.style.transform = `translateX(${dir * window.innerWidth * 1.5}px) rotate(${dir * 30}deg)`;
      setTimeout(() => {
        card.remove();
        state.cardStack.shift();
        if (dir === 1) redirectToWhatsApp(product);
        else logUserAction('Skipped', product.name);
        renderCards();
      }, 300);
    } else {
      card.style.transition = 'transform 0.3s';
      card.style.transform = 'translateY(0) scale(1) rotate(0)';
    }
    currentX = 0;
  };
  card.addEventListener('mousedown', onStart); document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onEnd);
  card.addEventListener('touchstart', onStart); document.addEventListener('touchmove', onMove); document.addEventListener('touchend', onEnd);
}

// --- ORDER NOTIFICATIONS ---
function startOrderNotifications() {
    if (state.orders.length === 0) return;
    setInterval(() => {
        const order = state.orders[Math.floor(Math.random() * state.orders.length)];
        const phone = order.phone || "555555555";
        const maskedPhone = `*******${phone.slice(-2)}`;
        
        const toast = document.getElementById('notif-toast');
        document.getElementById('notif-user').textContent = `${maskedPhone} n√∂mr…ôsi indic…ô aldƒ±:`;
        document.getElementById('notif-product').textContent = order.product;
        
        toast.classList.add('show');
        setTimeout(() => { toast.classList.remove('show'); }, 9000);
    }, 40000); 
}

// --- GLOBAL DISCOUNT LOGIC (THE FEAR FACTOR) ---
let globalDiscount = 6.00;     
const discountStep = 0.50;     
const stepDuration = 30;       
let secondsLeftInStep = 30;    
let isTimerActive = false;     
let globalTimerInterval = null;

function activateGlobalDiscount() {
    if (isTimerActive) return; 
    isTimerActive = true;

    // Show Main Bar
    const mainBar = document.getElementById('fear-bar-main');
    if(mainBar) mainBar.classList.remove('hidden');

    globalTimerInterval = setInterval(() => {
        secondsLeftInStep--;
        updateDiscountProgressUI();

        if (secondsLeftInStep <= 0) {
            secondsLeftInStep = stepDuration; 
            
            if (globalDiscount > 0) {
                globalDiscount -= discountStep;
                globalDiscount = Math.round(globalDiscount * 100) / 100;
                triggerDropEffect(); 
            } else {
                globalDiscount = 0;
                clearInterval(globalTimerInterval); 
            }
        }
        updateDiscountTextUI();
    }, 1000);
}

function updateDiscountTextUI() {
    const formattedPrice = `-${globalDiscount.toFixed(2)} ‚Çº`;
    const gsAmount = document.getElementById('gs-amount');
    const msAmount = document.getElementById('modal-fear-amount');
    
    if(gsAmount) gsAmount.textContent = formattedPrice;
    if(msAmount) msAmount.textContent = formattedPrice;
}

function updateDiscountProgressUI() {
    const percent = (secondsLeftInStep / stepDuration) * 100;
    const gsFill = document.getElementById('gs-timer-fill');
    const msFill = document.getElementById('modal-timer-fill');
    
    if(gsFill) gsFill.style.width = `${percent}%`;
    if(msFill) msFill.style.width = `${percent}%`;
}

function triggerDropEffect() {
    const els = [document.getElementById('gs-amount'), document.getElementById('modal-fear-amount')];
    els.forEach(el => {
        if(el) {
            el.classList.add('shake-it');
            setTimeout(() => el.classList.remove('shake-it'), 500);
        }
    });
}

// --- ALL PRODUCTS ---
async function openAllProducts() {
  document.getElementById('all-products-view').classList.add('active');
  logUserAction('ViewAllProducts');
  if (state.products.length > 0) { renderGrid(); return; }
  
  const container = document.getElementById('all-products-grid');
  container.innerHTML = '<div style="grid-column:1/-1;text-align:center;">Y√ºkl…ônir...</div>';
  try {
    const response = await fetch(`${SHEETS_ENDPOINT}?action=getProducts`);
    const data = await response.json();
    state.products = shuffleArray(data.products || []);
    applyBadges(state.products); 
    renderGrid();
  } catch(e) { container.innerHTML = '<p style="text-align:center">Y√ºkl…ônm…ô x…ôtasƒ±.</p>'; }
}

function closeAllProducts() { document.getElementById('all-products-view').classList.remove('active'); }

function renderGrid() {
  const container = document.getElementById('all-products-grid');
  container.innerHTML = '';
  state.products.slice(0, gridLimit).forEach(p => {
    const el = document.createElement('div');
    el.className = 'grid-item';
    el.onclick = () => openModal(p);
    
    let badge = "";
    if (p.isBestSeller) badge = `<div class="badge-bestseller" style="top:5px; left:5px; font-size:10px;">üèÜ Best Seller</div>`;
    else if (p.isLowStock) badge = `<div class="badge-lowstock" style="bottom:5px; left:5px; font-size:10px;">‚ö†Ô∏è 4 …ôd…ôd qaldƒ±</div>`;

    el.innerHTML = `
        ${badge}
        <img src="${fixImageLink(p.image)}" loading="lazy">
        <div class="grid-info">
            <div class="grid-title">${p.name}</div>
            <div class="grid-price">${p.price} AZN</div>
        </div>`;
    container.appendChild(el);
  });
  document.getElementById('load-more-btn').style.display = (gridLimit >= state.products.length) ? 'none' : 'block';
}
function loadMoreGrid() { gridLimit += 6; renderGrid(); logUserAction('LoadMoreProducts'); }

// --- MODAL & WHATSAPP ---
function openModal(p) {
  logUserAction('ViewDetails', p.name);
  activateGlobalDiscount(); // Ensure timer is running

  document.getElementById('modal-img').src = fixImageLink(p.image);
  document.getElementById('modal-title').textContent = p.name;
  document.getElementById('modal-price').textContent = p.price + ' AZN';
  document.getElementById('modal-desc').textContent = p.description;
  
  updateDiscountTextUI();
  updateDiscountProgressUI();

  const btn = document.getElementById('modal-whatsapp-btn');
  btn.onclick = () => redirectToWhatsApp(p);
  document.getElementById('product-modal').classList.add('active');
}
function closeModal() { document.getElementById('product-modal').classList.remove('active'); }

function redirectToWhatsApp(p) {
  logUserAction('Like_WhatsApp', p.name);
  
  const finalPrice = Math.max(0, p.price - globalDiscount).toFixed(2);
  const discountVal = globalDiscount.toFixed(2);
  
  let priceText = `${p.price} AZN`;
  if (globalDiscount > 0) {
    priceText = `${p.price} AZN\nüî• Aktiv Endirim: -${discountVal} AZN\n‚úÖ YEKUN: ${finalPrice} AZN`;
  }
  
  const text = `Salam Brendimo! üéÅ\n\nBu m…ôhsulu b…ôy…ôndim:\n*${p.name}*\n${priceText}\n\nLink:\n${fixImageLink(p.image)}\n\nSifari≈ü etm…ôk ist…ôyir…ôm.`;
  const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`;
  setTimeout(() => window.location.href = url, 100); 
}

// --- UTILS & LOGGING ---
function logUserAction(action, details = '') {
  const currentIP = typeof userIP !== 'undefined' ? userIP : 'Unknown';
  fetch(SHEETS_ENDPOINT, {
    method: 'POST', mode: 'no-cors', keepalive: true, 
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ type: 'log', action: action, details: `[IP: ${currentIP}] ${details}` })
  }).catch(e => console.log(e));
}

function fixImageLink(url) {
  if (!url) return 'https://via.placeholder.com/300?text=No+Image';
  if (url.includes('drive.google.com') || url.includes('docs.google.com')) {
    const idMatch = url.match(/[-\w]{25,}/);
    if (idMatch) return `https://googleusercontent.com/profile/picture/0${idMatch[0]}`;
  }
  if (url.includes('github.com') && url.includes('/blob/')) {
    return url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
  }
  return url;
}

function restartApp() {
  state.who = null; state.occasion = null; state.mood = null; state.style = null; state.budget = null;
  currentStep = 0; updateUI(); closeAllProducts(); closeModal();
}

// TRACKING
let userIP = "Fetching...";
async function initTracking() {
  try {
    const response = await fetch('https://api.ipify.org?format=json');
    const data = await response.json();
    userIP = data.ip;
  } catch (err) { userIP = "Hidden/Error"; }
  logUserAction('SessionStart', navigator.userAgent);
}

initTracking();
updateUI();
</script>
</body>
</html>
