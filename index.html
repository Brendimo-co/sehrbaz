<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Brendimo HÉ™diyyÉ™ SehrbazÄ±</title>
  <meta property="og:type" content="website">
  <meta property="og:title" content="ğŸ Brendimo HÉ™diyyÉ™ SehrbazÄ±">
  <meta property="og:description" content="HÉ™diyyÉ™ axtarÄ±ÅŸÄ±ndan yorulmusan? 30 saniyÉ™yÉ™ ideal hÉ™diyyÉ™ni tap! SÉ™nÉ™ Ã¶zÉ™l seÃ§imlÉ™ri gÃ¶rmÉ™k Ã¼Ã§Ã¼n daxil ol.">
  
  <meta property="og:image" content="https://github.com/Brendimo-co/sehrbaz/blob/main/Gemini_Generated_Image_hzsbephzsbephzsb.png?raw=true">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:image:type" content="image/jpeg">
  <meta property="og:url" content="https://brendimo-co.github.io/sehrbaz/">
  

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* --- CSS STYLES --- */

/* RESET & BASE */
* { margin: 0; padding: 0; box-sizing: border-box; font-family: "Inter", sans-serif; -webkit-tap-highlight-color: transparent; }
body { background: #fafafa; color: #1d1d1f; overflow-x: hidden; height: 100vh; display: flex; flex-direction: column; }

/* LAYOUT */
.wizard-wrapper {
  flex: 1; width: 100%; max-width: 440px; margin: 0 auto; padding: 20px 20px 80px 20px; /* Added bottom padding for floating btns */
  display: flex; flex-direction: column; position: relative;
}

/* HEADER */
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; height: 40px; }
.back-btn { font-size: 14px; color: #777; cursor: pointer; display: flex; align-items: center; gap: 4px; font-weight: 600; }
.logo { font-size: 20px; font-weight: 800; color: #c21a1a; letter-spacing: -0.5px; }
.step-indicator { font-size: 12px; color: #999; font-weight: 600; background: #eee; padding: 4px 8px; border-radius: 12px; }

/* PROGRESS */
.progress-container { height: 4px; background: #eee; border-radius: 2px; margin-bottom: 30px; overflow: hidden; }
.progress-fill { height: 100%; background: #c21a1a; width: 20%; transition: width 0.4s ease; }

/* STEPS */
.step-content { display: none; animation: fadeIn 0.4s ease; }
.step-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.title { font-size: 24px; font-weight: 700; margin-bottom: 24px; text-align: center; line-height: 1.3; }

/* OPTIONS GRID */
.options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.option-card {
  background: white; border: 2px solid #f0f0f0; border-radius: 16px; padding: 20px 10px;
  text-align: center; cursor: pointer; transition: all 0.2s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.03);
}
.option-card:active { transform: scale(0.96); border-color: #c21a1a; background: #fffcfc; }
.option-icon { font-size: 32px; margin-bottom: 8px; display: block; }
.option-text { font-size: 15px; font-weight: 600; color: #333; }

/* --- YENÄ° PREMIUM KART DÄ°ZAYNI --- */

/* KartlarÄ±n olduÄŸu qutu - EkranÄ±n hÃ¼ndÃ¼rlÃ¼yÃ¼nÉ™ gÃ¶rÉ™ dÉ™yiÅŸir */
#cards-wrapper { 
  position: relative; 
  width: 100%; 
  /* EkranÄ±n 62%-ni tutur, amma Ã§ox uzanmÄ±r vÉ™ ya Ã§ox qÄ±salmÄ±r */
  height: 62vh; 
  max-height: 580px; 
  min-height: 420px;
  margin-top: 10px; 
  perspective: 1000px; 
}

.card {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  background: white; 
  border-radius: 24px; /* Daha yumru kÃ¼nclÉ™r */
  /* Daha yumÅŸaq vÉ™ dÉ™rin "Premium" kÃ¶lgÉ™ */
  box-shadow: 0 15px 40px -10px rgba(0,0,0,0.12);
  overflow: hidden; 
  transform-origin: 50% 100%; will-change: transform; touch-action: none;
  display: flex; flex-direction: column;
}

/* ÅÉ™kil sahÉ™si - */
.card-image-box {
  position: relative;
  width: 100%;
  height: 60%; 
  overflow: hidden;
  background: #f9f9f9; /* AÃ§Ä±q boz studiya fonu */
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 10px; /* KÉ™narlardan bir az boÅŸluq buraxÄ±r */
}

.card-image-box img { 
  width: 100%; 
  height: 100%; 
  object-fit: contain; /* ÅÉ™kli sÄ±xmadan, kÉ™smÉ™dÉ™n tam gÃ¶stÉ™rir */
  filter: drop-shadow(0 4px 6px rgba(0,0,0,0.05)); /* MÉ™hsula yÃ¼ngÃ¼l kÃ¶lgÉ™ verir */
}

/* Glassmorphism UyÄŸunluq Faizi */
.match-badge {
  position: absolute; top: 16px; right: 16px; 
  background: rgba(255, 255, 255, 0.85); /* YarÄ±mÅŸÉ™ffaf aÄŸ */
  color: #c21a1a; 
  padding: 6px 14px; 
  border-radius: 30px; 
  font-size: 13px; 
  font-weight: 800; 
  backdrop-filter: blur(10px); /* ÅÃ¼ÅŸÉ™ effekti */
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  z-index: 2;
}

/* MÉ™lumat sahÉ™si - KartÄ±n 45%-ni tutur */
.card-info { 
  flex: 1; 
  padding: 16px 20px; 
  display: flex; 
  flex-direction: column; 
  justify-content: space-between; /* MÉ™tni yuxarÄ±, qiymÉ™ti aÅŸaÄŸÄ± itÉ™lÉ™yir */
  background: #fff;
}

/* Premium Tag - Daha eleqant */
.premium-badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  background: linear-gradient(135deg, #fff8e1 0%, #fff3cd 100%);
  color: #b78900;
  padding: 5px 10px;
  border-radius: 8px;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  width: fit-content;
  margin-bottom: 8px;
}

  
/* MÉ™tnlÉ™r */
.card-text-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.card h3 { 
  /* MÉ™tn Ã¶lÃ§Ã¼sÃ¼ ekrana gÃ¶rÉ™ dÉ™yiÅŸir (Min 18px, Max 24px) */
  font-size: clamp(18px, 5vw, 22px); 
  font-weight: 700;
  color: #111;
  line-height: 1.2;
  margin: 0;
  
  /* 2 sÉ™tirdÉ™n Ã§ox olarsa kÉ™sir (...) */
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}

.card p { 
  font-size: 14px; 
  color: #666; 
  line-height: 1.5; 
  margin: 0;
  
  /* 3 sÉ™tirdÉ™n Ã§ox olarsa kÉ™sir (...) */
  display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
}

/* QiymÉ™t SahÉ™si - Altda yerlÉ™ÅŸir */
.card-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 10px;
  padding-top: 12px;
  border-top: 1px solid #f0f0f0;
}

.price-box {
  display: flex;
  flex-direction: column;
}

.price-label {
  font-size: 10px;
  color: #999;
  font-weight: 600;
  text-transform: uppercase;
}

.price-tag { 
  font-size: 24px; 
  font-weight: 800; 
  color: #1d1d1f; 
  letter-spacing: -1px;
}

.details-arrow {
  width: 36px; height: 36px;
  background: #f5f5f7;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  color: #1d1d1f;
  font-weight: bold;
}

/* ACTIONS */
.actions { display: flex; justify-content: center; gap: 20px; margin-top: 20px; position: relative; z-index: 10; }
.action-btn {
  width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 24px;
  cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.15); transition: transform 0.2s;
  display: flex; align-items: center; justify-content: center;
}
.btn-skip { background: white; color: #ff4b4b; }
.btn-like { background: #25D366; color: white; /* WhatsApp Green */ }
.action-btn:active { transform: scale(0.9); }

/* FLOATING BUTTONS */
.floating-bar {
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  display: flex; gap: 12px; z-index: 90;
}
.float-btn {
  background: #1d1d1f; color: white; border: none; padding: 10px 16px; border-radius: 30px;
  font-size: 13px; font-weight: 600; cursor: pointer; box-shadow: 0 6px 16px rgba(0,0,0,0.2);
  display: flex; align-items: center; gap: 6px; text-decoration: none; white-space: nowrap;
}
.float-btn.wheel { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; }

/* ALL PRODUCTS MODAL/VIEW */
.all-products-view {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fafafa;
  z-index: 100; overflow-y: auto; padding: 20px; display: none;
}
.all-products-view.active { display: block; animation: slideUp 0.3s ease; }
.close-view-btn { 
  position: sticky; top: 0; background: rgba(250,250,250,0.9); padding: 10px 0;
  display: flex; justify-content: flex-end; margin-bottom: 10px; z-index: 2; backdrop-filter: blur(5px);
}
.grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding-bottom: 40px; }
.grid-item { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.grid-item img { width: 100%; height: 140px; object-fit: cover; }
.grid-info { padding: 10px; }
.grid-title { font-size: 13px; font-weight: 700; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.grid-price { font-size: 14px; color: #c21a1a; font-weight: 700; }
.load-more-btn {
  width: 100%; padding: 12px; background: #eee; border: none; border-radius: 8px;
  font-weight: 600; color: #555; cursor: pointer; margin-bottom: 40px;
}

/* MODAL */
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 200; padding: 24px; overflow-y: auto; display: none; }
.modal.active { display: block; animation: slideUp 0.3s ease; }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

/* LOADER */
/* --- MAGIC LOADER ANIMATIONS --- */
.magic-loader-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 60vh; /* Center on screen */
  position: relative;
}

.magic-wand-wrapper {
  position: relative;
  width: 100px;
  height: 100px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.magic-wand {
  font-size: 64px;
  z-index: 2;
  animation: waveWand 2.5s ease-in-out infinite;
  transform-origin: bottom left;
}

/* Glowing Aura behind the wand */
.magic-aura {
  position: absolute;
  width: 60px;
  height: 60px;
  background: radial-gradient(circle, rgba(194, 26, 26, 0.4) 0%, rgba(255, 215, 0, 0) 70%);
  border-radius: 50%;
  animation: pulseGlow 2s infinite;
  z-index: 1;
}

/* Floating Sparkles */
.sparkle {
  position: absolute;
  color: #FFD700;
  font-size: 20px;
  opacity: 0;
  animation: sparkleFloat 2s infinite;
}
.s1 { top: 0; right: 0; animation-delay: 0.2s; }
.s2 { top: 20px; left: -10px; animation-delay: 0.5s; font-size: 14px; }
.s3 { bottom: 0; right: -10px; animation-delay: 0.8s; font-size: 24px; }
.s4 { bottom: 20px; left: 0; animation-delay: 1.2s; }

/* Text Animation */
.magic-text {
  margin-top: 30px;
  font-size: 18px;
  font-weight: 600;
  color: #555;
  min-height: 24px; /* Prevent layout jump */
  text-align: center;
  animation: textFade 0.5s;
}

/* KEYFRAMES */
@keyframes waveWand {
  0% { transform: rotate(0deg); }
  25% { transform: rotate(-15deg); }
  50% { transform: rotate(0deg); }
  75% { transform: rotate(10deg); }
  100% { transform: rotate(0deg); }
}

@keyframes pulseGlow {
  0% { transform: scale(0.8); opacity: 0.5; }
  50% { transform: scale(1.5); opacity: 0.2; }
  100% { transform: scale(0.8); opacity: 0.5; }
}

@keyframes sparkleFloat {
  0% { transform: translateY(0) scale(0); opacity: 0; }
  50% { opacity: 1; }
  100% { transform: translateY(-40px) scale(1.2); opacity: 0; }
}

@keyframes textFade {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.hidden { display: none !important; }

 /* Premium Tag Stili */
.premium-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: #fff8e1; /* AÃ§Ä±q qÄ±zÄ±lÄ± fon */
  color: #b78900;       /* TÃ¼nd qÄ±zÄ±lÄ± mÉ™tn */
  border: 1px solid #ffe082;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
  margin-bottom: 8px;
  width: fit-content;
}

/* Logo Stili (Cursor pointer É™lavÉ™si) */
.logo { 
  font-size: 20px; 
  font-weight: 800; 
  color: #c21a1a; 
  letter-spacing: -0.5px; 
  cursor: pointer; /* KliklÉ™nÉ™ bilÉ™n olduÄŸunu gÃ¶stÉ™rir */
}
.logo:active { opacity: 0.7; } 
  
 
  <!-- Meta Pixel Code -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '752296677155305');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=752296677155305&ev=PageView&noscript=1"
/></noscript>
<!-- End Meta Pixel Code -->
</style>
</head>
<body>

<div class="wizard-wrapper">
  
 <div class="header">
    <div class="back-btn" onclick="goBack()">â† Geri</div>
    <div class="logo" onclick="restartApp()">ğŸ Brendimo</div>
    <div class="step-indicator" id="step-count">1/5</div>
</div>

  <div class="progress-container">
    <div class="progress-fill" id="progress-bar"></div>
  </div>

  <div class="step-content active" id="step-0">
    <h2 class="title">HÉ™diyyÉ™ kimin Ã¼Ã§Ã¼ndÃ¼r?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'who')">
      <div class="option-card" data-val="XanÄ±m"><span class="option-icon">ğŸ‘©</span><span class="option-text">XanÄ±m</span></div>
      <div class="option-card" data-val="BÉ™y"><span class="option-icon">ğŸ‘¨</span><span class="option-text">BÉ™y</span></div>
      <div class="option-card" data-val="UÅŸaq"><span class="option-icon">ğŸ§’</span><span class="option-text">UÅŸaq</span></div>
      <div class="option-card" data-val="HÉ™mkar"><span class="option-icon">ğŸ’¼</span><span class="option-text">HÉ™mkar</span></div>
    </div>
  </div>

  <div class="step-content" id="step-1">
    <h2 class="title">HansÄ± Ã¶zÉ™l gÃ¼n Ã¼Ã§Ã¼n?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'occasion')">
      <div class="option-card" data-val="Ad gÃ¼nÃ¼"><span class="option-icon">ğŸ‚</span><span class="option-text">Ad gÃ¼nÃ¼</span></div>
      <div class="option-card" data-val="Yubiley"><span class="option-icon">ğŸ¥‚</span><span class="option-text">Yubiley</span></div>
      <div class="option-card" data-val="Yeni Ä°l"><span class="option-icon">ğŸ„</span><span class="option-text">Yeni Ä°l</span></div>
      <div class="option-card" data-val="SÉ™bÉ™bsiz"><span class="option-icon">ğŸ’</span><span class="option-text">SadÉ™cÉ™ HÉ™diyyÉ™</span></div>
    </div>
  </div>

  <div class="step-content" id="step-2">
    <h2 class="title">HÉ™diyyÉ™nin aurasÄ± necÉ™ olsun?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'mood')">
      <div class="option-card" data-val="Romantik"><span class="option-icon">ğŸŒ¹</span><span class="option-text">Romantik</span></div>
      <div class="option-card" data-val="RÉ™smi"><span class="option-icon">ğŸ‘”</span><span class="option-text">RÉ™smi</span></div>
      <div class="option-card" data-val="Fun"><span class="option-icon">ğŸ‰</span><span class="option-text">ÆylÉ™ncÉ™li</span></div>
      <div class="option-card" data-val="FaydalÄ±"><span class="option-icon">ğŸ“š</span><span class="option-text">Praktik/FaydalÄ±</span></div>
    </div>
  </div>

  <div class="step-content" id="step-3">
    <h2 class="title">Stil seÃ§imi</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'style')">
      <div class="option-card" data-val="Modern"><span class="option-icon">âœ¨</span><span class="option-text">Modern</span></div>
      <div class="option-card" data-val="Klassik"><span class="option-icon">ğŸ›ï¸</span><span class="option-text">Klassik</span></div>
      <div class="option-card" data-val="Minimal"><span class="option-icon">âšª</span><span class="option-text">Minimalist</span></div>
      <div class="option-card" data-val="LÃ¼ks"><span class="option-icon">ğŸ’</span><span class="option-text">LÃ¼ks</span></div>
    </div>
  </div>

  <div class="step-content" id="step-4">
    <h2 class="title">BÃ¼dcÉ™ aralÄ±ÄŸÄ±nÄ±z?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'budget')">
      <div class="option-card" data-val="0-30"><span class="option-icon">ğŸª™</span><span class="option-text">0 - 30 AZN</span></div>
      <div class="option-card" data-val="30-60"><span class="option-icon">ğŸ’µ</span><span class="option-text">30 - 60 AZN</span></div>
      <div class="option-card" data-val="60-120"><span class="option-icon">ğŸ’°</span><span class="option-text">60 - 120 AZN</span></div>
      <div class="option-card" data-val="120+"><span class="option-icon">ğŸ’³</span><span class="option-text">120+ AZN</span></div>
    </div>
  </div>

  <div class="step-content" id="step-loading">
    <div class="magic-loader-container">
      <div class="magic-wand-wrapper">
        <div class="magic-wand">ğŸª„</div>
        <div class="magic-aura"></div>
        <div class="sparkle s1">âœ¨</div>
        <div class="sparkle s2">â­</div>
        <div class="sparkle s3">âœ¨</div>
        <div class="sparkle s4">ğŸ’«</div>
      </div>
      <p class="magic-text" id="magic-status-text">Sehrbaz iÅŸÉ™ baÅŸladÄ±...</p>
    </div>
  </div>

  <div class="step-content" id="step-results">
    <h2 class="title" style="font-size: 20px; margin-bottom: 10px;">Sizin Ã¼Ã§Ã¼n seÃ§diklÉ™rimiz</h2>
    <div id="cards-wrapper"></div>
    <div class="actions">
      <button class="action-btn btn-skip" id="btn-skip">âœ•</button>
      <button class="action-btn btn-like" id="btn-like">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
      </button>
    </div>
  </div>
</div>

<div class="floating-bar">
  <button class="float-btn" onclick="openAllProducts()">ğŸ›ï¸ BÃ¼tÃ¼n MÉ™hsullar</button>
  <a href="https://brendimo-co.github.io/sanscarxi/" target="_blank" class="float-btn wheel" onclick="logUserAction('SpinWheel')">ğŸ HÉ™diyyÉ™ Ã‡arxÄ±</a>
</div>

<div id="all-products-view" class="all-products-view">
  <div class="close-view-btn">
    <button onclick="closeAllProducts()" style="background:none; border:none; font-size:16px; font-weight:700; color:#333;">âœ• BaÄŸla</button>
  </div>
  <h2 class="title" style="font-size:20px;">BÃ¼tÃ¼n MÉ™hsullar</h2>
  <div class="grid-container" id="all-products-grid">
    </div>
  <button id="load-more-btn" class="load-more-btn" onclick="loadMoreGrid()">Daha Ã‡ox GÃ¶stÉ™r (6)</button>
</div>

<div id="product-modal" class="modal">
  <div class="header"><div class="back-btn" onclick="closeModal()">âœ• BaÄŸla</div></div>
  <img id="modal-img" src="" style="width:100%; border-radius:12px; margin-bottom:15px;">
  <h2 id="modal-title" style="margin-bottom:10px;"></h2>
  <h3 id="modal-price" style="color:#c21a1a; margin-bottom:15px;"></h3>
  <p id="modal-desc" style="line-height:1.6; color:#555; margin-bottom:20px;"></p>
  <button id="modal-whatsapp-btn" class="float-btn" style="width:100%; justify-content:center; background:#25D366; color:white;">WhatsApp ilÉ™ SifariÅŸ</button>
</div>

<script>
// --- CONFIGURATION ---
const SHEETS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxe3u8E5WYNQp_e_OIDlJbR7rbmTVLdHHzc2rrhseUhFwddRDv74s2PhZKOKm3l3Qpw/exec"; 
const WHATSAPP_NUMBER = "994556742535";

// --- STATE ---
let currentStep = 0;
const totalSteps = 5;
const state = { who: null, occasion: null, mood: null, style: null, budget: null, products: [], cardStack: [] };
let gridLimit = 6; // Start with 6 items (3 rows x 2 cols)

// --- LOGGING ---
function logUserAction(action, details = '') {
  // If we haven't fetched the IP yet, use 'Loading...'
  const currentIP = typeof userIP !== 'undefined' ? userIP : 'Unknown';
  
  fetch(SHEETS_ENDPOINT, {
    method: 'POST',
    mode: 'no-cors',
    // keepalive ensures the request completes even if the user closes the tab
    keepalive: true, 
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ 
      type: 'log', 
      action: action, 
      // We append the IP to the details column automatically
      details: `[IP: ${currentIP}] ${details}` 
    })
  }).catch(e => console.log("Logging failed", e));
}

// --- NAVIGATION ---
function updateUI() {
  document.getElementById('step-count').textContent = (currentStep < totalSteps) ? `ADDIM ${currentStep + 1}/${totalSteps}` : 'NÆTÄ°CÆ';
  document.getElementById('progress-bar').style.width = `${((currentStep + 1) / totalSteps) * 100}%`;
  document.querySelector('.back-btn').style.opacity = currentStep === 0 ? '0' : '1';

  document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
  
  if (currentStep < totalSteps) {
    document.getElementById(`step-${currentStep}`).classList.add('active');
  } else if (currentStep === totalSteps) {
    document.getElementById('step-loading').classList.add('active');
    fetchProducts();
  } else {
    document.getElementById('step-results').classList.add('active');
  }
}

function goBack() {
  if (currentStep > 0) { currentStep--; updateUI(); }
}

function handleOptionClick(e, key) {
  const card = e.target.closest('.option-card');
  if (!card) return;
  state[key] = card.getAttribute('data-val');
  logUserAction('StepCompleted', `${key}: ${state[key]}`);
  currentStep++;
  updateUI();
}

// --- DATA ---
// --- DATA ---

// 1. Yeni QarÄ±ÅŸdÄ±rma FunksiyasÄ± (Bunu skriptin istÉ™nilÉ™n yerinÉ™ É™lavÉ™ edÉ™ bilÉ™rsiniz)
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// 2. Fetch Products (YÃ¼klÉ™nÉ™n kimi qarÄ±ÅŸdÄ±rÄ±rÄ±q ki, "BÃ¼tÃ¼n mÉ™hsullar" bÃ¶lmÉ™si dÉ™ qarÄ±ÅŸÄ±q olsun)
// --- NEW FETCH & ANIMATION LOGIC ---

async function fetchProducts() {
  const statusTextEl = document.getElementById('magic-status-text');
  
  // 1. STORYTELLING MESSAGES (Timed for 6 seconds total)
  // We have 4 messages. If we show each for 1.5 seconds, that equals exactly 6 seconds.
  const messages = [
    "Ulduzlar yoxlanÄ±lÄ±r... âœ¨",        // 0s - 1.5s
    "ZÃ¶vqlÉ™r analiz edilir... ğŸ§ ",      // 1.5s - 3.0s
    "AxtardÄ±ÄŸÄ±n seÃ§imlÉ™r Ã¼mumilÉ™ÅŸdirilir... ğŸ”",  // 3.0s - 4.5s
    "Sehr tamamlanÄ±r... ğŸª„"             // 4.5s - 6.0s
  ];
  
  let msgIndex = 0;
  
  // Set initial text immediately
  statusTextEl.textContent = messages[0];

  // 2. SLOWER INTERVAL (1500ms = 1.5 seconds)
  const textInterval = setInterval(() => {
    msgIndex++;
    if (msgIndex < messages.length) {
      // Trigger CSS reflow for fade animation restart
      statusTextEl.style.animation = 'none';
      statusTextEl.offsetHeight; 
      statusTextEl.style.animation = 'textFade 1.0s ease'; // Slower fade for smoother look
      
      statusTextEl.textContent = messages[msgIndex];
    }
  }, 1500); // Change text every 1.5 seconds

  try {
    // 3. WAIT FOR 6 SECONDS (6000ms)
    const [response, _] = await Promise.all([
      fetch(`${SHEETS_ENDPOINT}?action=getProducts`), 
      new Promise(resolve => setTimeout(resolve, 6000)) // <--- CHANGED TO 6000
    ]);

    const data = await response.json();
    
    // Stop the text cycle
    clearInterval(textInterval);

    // 4. Process Data
    state.products = shuffleArray(data.products || []);
    processMatches();
    
    // 5. Move to next step
    currentStep++;
    updateUI();
    renderCards();
    
  } catch (error) {
    clearInterval(textInterval);
    console.error(error);
    document.getElementById('step-loading').innerHTML = "<p style='text-align:center; margin-top:50px;'>XÉ™ta baÅŸ verdi. Ä°nternet É™laqÉ™sini yoxlayÄ±n.</p>";
  }
}
  
// 3. Process Matches (ÆvvÉ™l qarÄ±ÅŸdÄ±rÄ±r, sonra xallara gÃ¶rÉ™ dÃ¼zÃ¼r)
function processMatches() {
  // 1. SiyahÄ±nÄ± qarÄ±ÅŸdÄ±rÄ±rÄ±q (Shuffle)
  let candidates = shuffleArray([...state.products]);

  // 2. QÆTÄ° FÄ°LTR (STRICT FILTER)
  // ÆgÉ™r istifadÉ™Ã§i "Kim Ã¼Ã§Ã¼n" (state.who) seÃ§imi edibsÉ™, 
  // uyÄŸun gÉ™lmÉ™yÉ™n bÃ¼tÃ¼n digÉ™r mÉ™hsullarÄ± siyahÄ±dan silirik.
  if (state.who) {
    candidates = candidates.filter(p => match(p.target, state.who));
  }

  // 3. XallarÄ± hesablayÄ±rÄ±q
  state.cardStack = candidates.map(p => {
    let score = 0;
    
    // Target (Kim Ã¼Ã§Ã¼n) artÄ±q yuxarÄ±da filtrlÉ™nib, ona gÃ¶rÉ™ buna xal vermÉ™yÉ™ ehtiyac yoxdur,
    // amma "HÉ™mkar" kimi Ã¼mumi kateqoriyalar Ã¼Ã§Ã¼n saxlayÄ±rÄ±q.
    if (match(p.target, state.who)) score += 40; 
    
    if (match(p.occasion, state.occasion)) score += 20;
    if (match(p.mood, state.mood)) score += 15;
    if (match(p.style, state.style)) score += 15;
    if (!checkBudget(p.price, state.budget)) score -= 30;
    
    p.score = Math.min(100, Math.max(0, score));
    return p;
  }).sort((a, b) => b.score - a.score);
}

// DigÉ™r funksiyalar (match, checkBudget vÉ™ s.) olduÄŸu kimi qalÄ±r...

function match(dbField, userSelect) {
  if (!dbField || !userSelect) return false;
  return dbField.toLowerCase().includes(userSelect.toLowerCase());
}

function checkBudget(price, budgetStr) {
  const p = Number(price);
  if (!budgetStr) return true;
  if (budgetStr === '0-20') return p <= 20;
  if (budgetStr === '20-50') return p > 20 && p <= 50;
  if (budgetStr === '50-100') return p > 50 && p <= 100;
  if (budgetStr === '100+') return p > 100;
  return true;
}

function renderCards() {
  const container = document.getElementById('cards-wrapper');
  container.innerHTML = '';
  
  if (state.cardStack.length === 0) {
    container.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">TÉ™É™ssÃ¼f ki, uyÄŸun mÉ™hsul tapÄ±lmadÄ±.<br>DigÉ™r seÃ§imlÉ™ri yoxlayÄ±n.</div>';
    return;
  }

  state.cardStack.slice(0, 5).forEach((p, index) => {
    const card = document.createElement('div');
    card.className = 'card';
    card.style.zIndex = state.cardStack.length - index;
    
    // YENÄ° HTML STRUKTURU
    card.innerHTML = `
      <div class="card-image-box">
         <div class="match-badge">ğŸ”¥ ${p.score}%</div>
         <img src="${p.image}" alt="${p.name}">
      </div>
      
      <div class="card-info">
        <div class="card-text-group">
          <div class="premium-badge">âœ¨Premium HÉ™diyyÉ™lik QablaÅŸdÄ±rma vÉ™ Ã‡atdÄ±rÄ±lma Daxildir</div>
          <h3>${p.name}</h3>
          <p>${p.description || 'Bu hÉ™diyyÉ™ xÃ¼susi gÃ¼nlÉ™r Ã¼Ã§Ã¼n ideal seÃ§imdir.'}</p>
        </div>
        
        <div class="card-footer">
          <div class="price-box">
            <span class="price-label">QiymÉ™t</span>
            <span class="price-tag">${p.price} â‚¼</span>
          </div>
          <div class="details-arrow">â</div>
        </div>
      </div>
    `;
    
    if (index === 0) initSwipe(card, p);
    container.appendChild(card);
  });
}


function initSwipe(card, product) {
  let startX = 0, currentX = 0, isDragging = false;

  const onStart = (e) => {
    isDragging = true;
    // Get correct X coordinate for Mouse or Touch
    startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    currentX = 0; // Reset currentX ensures previous swipes don't interfere
    card.style.transition = 'none';
  };

  const onMove = (e) => {
    if (!isDragging) return;
    const x = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    currentX = x - startX;
    
    // Visual feedback for swiping
    const rotate = currentX / 15;
    card.style.transform = `translateX(${currentX}px) rotate(${rotate}deg)`;
  };

  const onEnd = () => {
    if (!isDragging) return;
    isDragging = false;
    
    // --- NEW CLICK DETECTION LOGIC ---
    // If moved less than 10 pixels, consider it a CLICK
    if (Math.abs(currentX) < 10) {
      openModal(product); // Open the info modal
      // Reset card position visually just in case
      card.style.transform = 'translateX(0) rotate(0)';
      return;
    }
    // ---------------------------------

    // --- SWIPE LOGIC ---
    if (Math.abs(currentX) > 100) {
      const dir = currentX > 0 ? 1 : -1;
      card.style.transition = 'transform 0.4s ease';
      card.style.transform = `translateX(${dir * window.innerWidth * 1.5}px) rotate(${dir * 30}deg)`;
      
      setTimeout(() => {
        card.remove();
        state.cardStack.shift();
        if (dir === 1) redirectToWhatsApp(product);
        else logUserAction('Skipped', product.name);
        renderCards();
      }, 300);
    } else {
      // If swipe was too weak, bounce back
      card.style.transition = 'transform 0.3s ease';
      card.style.transform = 'translateX(0)';
    }
    currentX = 0;
  };

  // Event Listeners
  card.addEventListener('mousedown', onStart);
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onEnd);
  
  card.addEventListener('touchstart', onStart);
  document.addEventListener('touchmove', onMove);
  document.addEventListener('touchend', onEnd);
}

// --- ALL PRODUCTS VIEW ---
function openAllProducts() {
  logUserAction('ViewAllProducts');
  if(state.products.length === 0) fetchProducts(); // Fetch if clicked on step 1
  document.getElementById('all-products-view').classList.add('active');
  renderGrid();
}

function closeAllProducts() {
  document.getElementById('all-products-view').classList.remove('active');
}

function renderGrid() {
  const container = document.getElementById('all-products-grid');
  container.innerHTML = '';
  // Use state.products (all items) or state.cardStack (filtered items)? 
  // User said "All Products", so we use state.products if available, otherwise fetch.
  const source = state.products.length ? state.products : [];
  
  source.slice(0, gridLimit).forEach(p => {
    const el = document.createElement('div');
    el.className = 'grid-item';
    el.onclick = () => openModal(p);
    el.innerHTML = `
      <img src="${p.image}" loading="lazy">
      <div class="grid-info">
        <div class="grid-title">${p.name}</div>
        <div class="grid-price">${p.price} AZN</div>
      </div>
    `;
    container.appendChild(el);
  });
  
  const btn = document.getElementById('load-more-btn');
  if(gridLimit >= source.length) btn.style.display = 'none';
  else btn.style.display = 'block';
}

function loadMoreGrid() {
  gridLimit += 6; // Load 3 more rows (6 items)
  renderGrid();
  logUserAction('LoadMoreProducts');
}

// --- ACTIONS ---
function redirectToWhatsApp(p) {
  logUserAction('Like_WhatsApp', p.name);
  
  // We use \n for new lines to make it look clean
  // We add the Image URL at the bottom so WhatsApp creates a preview
  const text = `Salam Brendimo! ğŸ\n\nMÉ™n bu mÉ™hsulu bÉ™yÉ™ndim:\n*${p.name}*\nQiymÉ™t: ${p.price} AZN\n\nBu da ÅŸÉ™kli:\n${p.image}\n\nSifariÅŸ etmÉ™k istÉ™yirÉ™m.`;
  
  const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`;
  
  // Slight delay to ensure the UI animation finishes before switching apps
  setTimeout(() => window.location.href = url, 100); 
}

// --- MODAL ---
function openModal(p) {
  logUserAction('ViewDetails', p.name);
  document.getElementById('modal-img').src = p.image;
  document.getElementById('modal-title').textContent = p.name;
  document.getElementById('modal-price').textContent = p.price + ' AZN';
  document.getElementById('modal-desc').textContent = p.description;
  
  // Set Modal WhatsApp Button
  const btn = document.getElementById('modal-whatsapp-btn');
  btn.onclick = () => redirectToWhatsApp(p);
  
  document.getElementById('product-modal').classList.add('active');
}
function closeModal() { document.getElementById('product-modal').classList.remove('active'); }

// Init
updateUI();

  // --- SESSION TRACKING (IP, DEVICE, TIME) ---

let sessionStartTime = Date.now();
let userIP = "Fetching...";

async function initTracking() {
  try {
    // 1. Get User IP (using free API)
    const response = await fetch('https://api.ipify.org?format=json');
    const data = await response.json();
    userIP = data.ip;
  } catch (err) {
    userIP = "Hidden/Error";
  }

  // 2. Get Device Info
  const device = navigator.userAgent; // Contains info like "iPhone", "Android", "Chrome"

  // 3. Log the Start of Session
  logUserAction('SessionStart', `Device: ${device}`);
}

// 4. Track Time Spent (Triggered when user switches tabs or closes app)
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') {
    const timeSpent = Math.round((Date.now() - sessionStartTime) / 1000); // Seconds
    logUserAction('SessionEnd', `Total Time: ${timeSpent} seconds`);
  }
});


function restartApp() {
  // BÃ¼tÃ¼n seÃ§imlÉ™ri sÄ±fÄ±rla
  state.who = null;
  state.occasion = null;
  state.mood = null;
  state.style = null;
  state.budget = null;
  
  // 1-ci addÄ±ma qaytar
  currentStep = 0;
  
  // UI-Ä± yenilÉ™
  updateUI();
  
  // ÆgÉ™r modal vÉ™ ya grid aÃ§Ä±qdÄ±rsa baÄŸla
  closeAllProducts();
  closeModal();
}

  
// Start tracking immediately
initTracking();
  
</script>
</body>
</html>
