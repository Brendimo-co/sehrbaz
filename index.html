<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Brendimo H…ôdiyy…ô Sehrbazƒ±</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* --- CSS STYLES --- */

/* RESET */
* { margin: 0; padding: 0; box-sizing: border-box; font-family: "Inter", sans-serif; -webkit-tap-highlight-color: transparent; }
body { background: #fafafa; color: #1d1d1f; overflow-x: hidden; height: 100vh; display: flex; flex-direction: column; }

/* MAIN CONTAINER */
.wizard-wrapper {
  flex: 1;
  width: 100%;
  max-width: 440px;
  margin: 0 auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  position: relative;
}

/* HEADER */
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; height: 40px; }
.back-btn { font-size: 14px; color: #777; cursor: pointer; display: flex; align-items: center; gap: 4px; font-weight: 600; }
.logo { font-size: 20px; font-weight: 800; color: #c21a1a; letter-spacing: -0.5px; }
.step-indicator { font-size: 12px; color: #999; font-weight: 600; background: #eee; padding: 4px 8px; border-radius: 12px; }

/* PROGRESS BAR */
.progress-container { height: 4px; background: #eee; border-radius: 2px; margin-bottom: 30px; overflow: hidden; }
.progress-fill { height: 100%; background: #c21a1a; width: 20%; transition: width 0.4s ease; }

/* STEPS (WIZARD) */
.step-content { display: none; animation: fadeIn 0.4s ease; }
.step-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.title { font-size: 24px; font-weight: 700; margin-bottom: 24px; text-align: center; line-height: 1.3; }

/* GRID OPTIONS */
.options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.option-card {
  background: white; border: 2px solid #f0f0f0; border-radius: 16px; padding: 20px 10px;
  text-align: center; cursor: pointer; transition: all 0.2s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.03);
}
.option-card:active { transform: scale(0.96); border-color: #c21a1a; background: #fffcfc; }
.option-icon { font-size: 32px; margin-bottom: 8px; display: block; }
.option-text { font-size: 15px; font-weight: 600; color: #333; }

/* TINDER CARDS CONTAINER */
#cards-wrapper {
  position: relative; width: 100%; height: 420px; margin-top: 20px; perspective: 1000px;
}
.card {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  background: white; border-radius: 20px;
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  overflow: hidden; transform-origin: 50% 100%;
  will-change: transform; touch-action: none; /* Crucial for mobile drag */
  display: flex; flex-direction: column;
}

.card img { width: 100%; height: 260px; object-fit: cover; pointer-events: none; }
.card-info { padding: 20px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
.card h3 { font-size: 20px; margin-bottom: 6px; }
.card p { font-size: 14px; color: #666; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.price-tag { font-size: 18px; font-weight: 800; color: #c21a1a; margin-top: 8px; }
.match-badge {
  position: absolute; top: 16px; right: 16px; background: rgba(0,0,0,0.7);
  color: #fff; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700;
  backdrop-filter: blur(4px);
}

/* ACTION BUTTONS */
.actions {
  display: flex; justify-content: center; gap: 20px; margin-top: 20px;
}
.action-btn {
  width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 24px;
  cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s;
  display: flex; align-items: center; justify-content: center;
}
.btn-skip { background: white; color: #ff4b4b; }
.btn-like { background: #c21a1a; color: white; }
.action-btn:active { transform: scale(0.9); }

/* PRODUCT DETAILS MODAL */
.modal {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white;
  z-index: 100; padding: 24px; overflow-y: auto; display: none; animation: slideUp 0.3s ease;
}
.modal.active { display: block; }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

/* LOADER */
.loader { text-align: center; margin-top: 50px; color: #888; }
.spinner { width: 30px; height: 30px; border: 3px solid #ddd; border-top-color: #c21a1a; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px; }
@keyframes spin { 100% { transform: rotate(360deg); } }

.hidden { display: none !important; }

</style>
</head>
<body>

<div class="wizard-wrapper">
  
  <div class="header">
    <div class="back-btn" onclick="goBack()">‚Üê Geri</div>
    <div class="logo">üéÅ Brendimo</div>
    <div class="step-indicator" id="step-count">1/5</div>
  </div>

  <div class="progress-container">
    <div class="progress-fill" id="progress-bar"></div>
  </div>

  <div class="step-content active" id="step-0">
    <h2 class="title">H…ôdiyy…ô kimin √º√ß√ºnd√ºr?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'who')">
      <div class="option-card" data-val="Xanƒ±m"><span class="option-icon">üë©</span><span class="option-text">Xanƒ±m</span></div>
      <div class="option-card" data-val="B…ôy"><span class="option-icon">üë®</span><span class="option-text">B…ôy</span></div>
      <div class="option-card" data-val="U≈üaq"><span class="option-icon">üßí</span><span class="option-text">U≈üaq</span></div>
      <div class="option-card" data-val="H…ômkar"><span class="option-icon">üíº</span><span class="option-text">H…ômkar</span></div>
    </div>
  </div>

  <div class="step-content" id="step-1">
    <h2 class="title">Hansƒ± √∂z…ôl g√ºn √º√ß√ºn?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'occasion')">
      <div class="option-card" data-val="Ad g√ºn√º"><span class="option-icon">üéÇ</span><span class="option-text">Ad g√ºn√º</span></div>
      <div class="option-card" data-val="Yubiley"><span class="option-icon">ü•Ç</span><span class="option-text">Yubiley</span></div>
      <div class="option-card" data-val="Yeni il"><span class="option-icon">üéÑ</span><span class="option-text">Yeni il</span></div>
      <div class="option-card" data-val="S…ôb…ôbsiz"><span class="option-icon">üíù</span><span class="option-text">Sad…ôc…ô H…ôdiyy…ô</span></div>
    </div>
  </div>

  <div class="step-content" id="step-2">
    <h2 class="title">H…ôdiyy…ônin aurasƒ± nec…ô olsun?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'mood')">
      <div class="option-card" data-val="Romantik"><span class="option-icon">üåπ</span><span class="option-text">Romantik</span></div>
      <div class="option-card" data-val="R…ôsmi"><span class="option-icon">üëî</span><span class="option-text">R…ôsmi</span></div>
      <div class="option-card" data-val="Fun"><span class="option-icon">üéâ</span><span class="option-text">∆èyl…ônc…ôli</span></div>
      <div class="option-card" data-val="Faydalƒ±"><span class="option-icon">üìö</span><span class="option-text">Praktik/Faydalƒ±</span></div>
    </div>
  </div>

  <div class="step-content" id="step-3">
    <h2 class="title">Stil se√ßimi</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'style')">
      <div class="option-card" data-val="Modern"><span class="option-icon">‚ú®</span><span class="option-text">Modern</span></div>
      <div class="option-card" data-val="Klassik"><span class="option-icon">üèõÔ∏è</span><span class="option-text">Klassik</span></div>
      <div class="option-card" data-val="Minimal"><span class="option-icon">‚ö™</span><span class="option-text">Minimalist</span></div>
      <div class="option-card" data-val="L√ºks"><span class="option-icon">üíé</span><span class="option-text">L√ºks</span></div>
    </div>
  </div>

  <div class="step-content" id="step-4">
    <h2 class="title">B√ºdc…ô aralƒ±ƒüƒ±nƒ±z?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'budget')">
      <div class="option-card" data-val="0-20"><span class="option-icon">ü™ô</span><span class="option-text">0 - 20 AZN</span></div>
      <div class="option-card" data-val="20-50"><span class="option-icon">üíµ</span><span class="option-text">20 - 50 AZN</span></div>
      <div class="option-card" data-val="50-100"><span class="option-icon">üí∞</span><span class="option-text">50 - 100 AZN</span></div>
      <div class="option-card" data-val="100+"><span class="option-icon">üí≥</span><span class="option-text">100+ AZN</span></div>
    </div>
  </div>

  <div class="step-content" id="step-loading">
    <div class="loader">
      <div class="spinner"></div>
      <p>Sehrbaz sizin √º√ß√ºn se√ßim edir...</p>
    </div>
  </div>

  <div class="step-content" id="step-results">
    <h2 class="title" style="font-size: 20px; margin-bottom: 10px;">Sizin √º√ß√ºn se√ßdikl…ôrimiz</h2>
    <div id="cards-wrapper"></div>
    
    <div class="actions">
      <button class="action-btn btn-skip" id="btn-skip">‚úï</button>
      <button class="action-btn btn-like" id="btn-like">‚ô•</button>
    </div>
  </div>

</div>

<div id="product-modal" class="modal">
  <div class="header">
    <div class="back-btn" onclick="closeModal()">‚úï Baƒüla</div>
  </div>
  <img id="modal-img" src="" style="width:100%; border-radius:12px; margin-bottom:15px;">
  <h2 id="modal-title" style="margin-bottom:10px;"></h2>
  <h3 id="modal-price" style="color:#c21a1a; margin-bottom:15px;"></h3>
  <p id="modal-desc" style="line-height:1.6; color:#555; margin-bottom:20px;"></p>
  <a id="modal-link" href="#" target="_blank" style="display:block; width:100%; padding:15px; background:#c21a1a; color:white; text-align:center; border-radius:12px; text-decoration:none; font-weight:700;">Sifari≈ü et</a>
</div>

<script>
// --- CONFIGURATION ---
const SHEETS_ENDPOINT = "https://script.google.com/macros/s/AKfycbztp8UrgbssLeCbkkA-oyh-unKxUBdXw45rXB0gQpp3vNpMO54PudFkdmlfu_6au_fdBg/exec"; 

// --- STATE MANAGEMENT ---
let currentStep = 0;
const totalSteps = 5;
const state = { who: null, occasion: null, mood: null, style: null, budget: null, products: [], cardStack: [] };

// --- NAVIGATION ---
function updateUI() {
  // Update Header & Progress
  document.getElementById('step-count').textContent = (currentStep < totalSteps) ? `ADDIM ${currentStep + 1}/${totalSteps}` : 'N∆èTƒ∞C∆è';
  document.getElementById('progress-bar').style.width = `${((currentStep + 1) / totalSteps) * 100}%`;
  
  // Back button visibility
  document.querySelector('.back-btn').style.opacity = currentStep === 0 ? '0' : '1';

  // Show correct step div
  document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
  
  if (currentStep < totalSteps) {
    document.getElementById(`step-${currentStep}`).classList.add('active');
  } else if (currentStep === totalSteps) {
    document.getElementById('step-loading').classList.add('active');
    fetchProducts();
  } else {
    document.getElementById('step-results').classList.add('active');
  }
}

function goBack() {
  if (currentStep > 0) {
    currentStep--;
    updateUI();
  }
}

function handleOptionClick(e, key) {
  const card = e.target.closest('.option-card');
  if (!card) return;
  
  state[key] = card.getAttribute('data-val');
  currentStep++;
  updateUI();
}

// --- DATA FETCHING ---
async function fetchProducts() {
  try {
    // Correct URL construction
    const response = await fetch(`${SHEETS_ENDPOINT}?action=getProducts`);
    const data = await response.json();
    
    state.products = data.products || [];
    processMatches();
    
    // Move to results
    currentStep++;
    updateUI();
    renderCards();
    
  } catch (error) {
    console.error("Error loading products:", error);
    document.getElementById('step-loading').innerHTML = "<p>X…ôta ba≈ü verdi. Z…ôhm…ôt olmasa yenil…ôyin.</p>";
  }
}

// --- MATCHING LOGIC ---
function processMatches() {
  state.cardStack = state.products.map(p => {
    let score = 0;
    // Simple tag matching
    if (match(p.target, state.who)) score += 40;
    if (match(p.occasion, state.occasion)) score += 20;
    if (match(p.mood, state.mood)) score += 15;
    if (match(p.style, state.style)) score += 15;
    
    // Budget check
    if (!checkBudget(p.price, state.budget)) score -= 30; // Penalty

    p.score = Math.min(100, Math.max(0, score)); // Clamp 0-100
    return p;
  }).sort((a, b) => b.score - a.score); // Sort best matches first
}

function match(dbField, userSelect) {
  if (!dbField || !userSelect) return false;
  return dbField.toLowerCase().includes(userSelect.toLowerCase());
}

function checkBudget(price, budgetStr) {
  const p = Number(price);
  if (!budgetStr) return true;
  if (budgetStr === '0-20') return p <= 20;
  if (budgetStr === '20-50') return p > 20 && p <= 50;
  if (budgetStr === '50-100') return p > 50 && p <= 100;
  if (budgetStr === '100+') return p > 100;
  return true;
}

// --- CARD RENDERING & SWIPE LOGIC ---
function renderCards() {
  const container = document.getElementById('cards-wrapper');
  container.innerHTML = '';
  
  if (state.cardStack.length === 0) {
    container.innerHTML = '<div style="text-align:center; padding:40px;">Uyƒüun m…ôhsul tapƒ±lmadƒ±.</div>';
    return;
  }

  // Render top 5 cards only for performance
  state.cardStack.slice(0, 5).forEach((p, index) => {
    const card = document.createElement('div');
    card.className = 'card';
    card.style.zIndex = state.cardStack.length - index; // Stack order
    card.innerHTML = `
      <div class="match-badge">${p.score}% Uyƒüunluq</div>
      <img src="${p.image}" alt="${p.name}">
      <div class="card-info">
        <div>
          <h3>${p.name}</h3>
          <p>${p.description || ''}</p>
        </div>
        <div class="price-tag">${p.price} AZN</div>
      </div>
    `;
    
    // Attach Swipe Events to the TOP card only
    if (index === 0) initSwipe(card, p);
    
    // Double click to view details
    card.addEventListener('dblclick', () => openModal(p));
    
    container.appendChild(card);
  });
}

function initSwipe(card, product) {
  let startX = 0, currentX = 0, isDragging = false;

  const onStart = (e) => {
    isDragging = true;
    startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    card.style.transition = 'none';
  };

  const onMove = (e) => {
    if (!isDragging) return;
    const x = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    currentX = x - startX;
    const rotate = currentX / 15;
    card.style.transform = `translateX(${currentX}px) rotate(${rotate}deg)`;
  };

  const onEnd = () => {
    if (!isDragging) return;
    isDragging = false;
    
    // Threshold to swipe
    if (Math.abs(currentX) > 100) {
      const dir = currentX > 0 ? 1 : -1; // 1 = right (like), -1 = left (skip)
      const endX = dir * window.innerWidth * 1.5;
      
      card.style.transition = 'transform 0.4s ease';
      card.style.transform = `translateX(${endX}px) rotate(${dir * 30}deg)`;
      
      setTimeout(() => {
        card.remove();
        state.cardStack.shift(); // Remove from data
        if (dir === 1) sendLike(product);
        renderCards(); // Re-render next batch
      }, 300);
    } else {
      // Reset position
      card.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
      card.style.transform = 'translateX(0) rotate(0)';
    }
    currentX = 0;
  };

  // Mouse Events
  card.addEventListener('mousedown', onStart);
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onEnd);
  
  // Touch Events
  card.addEventListener('touchstart', onStart);
  document.addEventListener('touchmove', onMove);
  document.addEventListener('touchend', onEnd);
}

// --- BUTTON CONTROLS ---
document.getElementById('btn-skip').onclick = () => simulateSwipe(-1);
document.getElementById('btn-like').onclick = () => simulateSwipe(1);

function simulateSwipe(dir) {
  const card = document.querySelector('.card');
  if (!card) return;
  
  card.style.transition = 'transform 0.5s ease';
  card.style.transform = `translateX(${dir * window.innerWidth}px) rotate(${dir * 30}deg)`;
  
  setTimeout(() => {
    const product = state.cardStack[0];
    state.cardStack.shift();
    if(dir === 1) sendLike(product);
    renderCards();
  }, 300);
}

// --- MODAL & LIKES ---
function openModal(p) {
  document.getElementById('modal-img').src = p.image;
  document.getElementById('modal-title').textContent = p.name;
  document.getElementById('modal-price').textContent = p.price + ' AZN';
  document.getElementById('modal-desc').textContent = p.description;
  document.getElementById('modal-link').href = p.url;
  document.getElementById('product-modal').classList.add('active');
}

function closeModal() {
  document.getElementById('product-modal').classList.remove('active');
}

function sendLike(product) {
  // Use mode: 'no-cors' to avoid CORS errors with simple GAS POSTs
  fetch(SHEETS_ENDPOINT, {
    method: 'POST',
    mode: 'no-cors', 
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'like', productId: product.id })
  }).catch(e => console.log('Like tracking error', e)); // Silent fail for UX
}

// Start
updateUI();
</script>

</body>
</html>
