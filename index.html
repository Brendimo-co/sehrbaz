<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Brendimo H…ôdiyy…ô Sehrbazƒ±</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* --- CSS STYLES --- */

/* RESET & BASE */
* { margin: 0; padding: 0; box-sizing: border-box; font-family: "Inter", sans-serif; -webkit-tap-highlight-color: transparent; }
body { background: #fafafa; color: #1d1d1f; overflow-x: hidden; height: 100vh; display: flex; flex-direction: column; }

/* LAYOUT */
.wizard-wrapper {
  flex: 1; width: 100%; max-width: 440px; margin: 0 auto; padding: 20px 20px 80px 20px; /* Added bottom padding for floating btns */
  display: flex; flex-direction: column; position: relative;
}

/* HEADER */
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; height: 40px; }
.back-btn { font-size: 14px; color: #777; cursor: pointer; display: flex; align-items: center; gap: 4px; font-weight: 600; }
.logo { font-size: 20px; font-weight: 800; color: #c21a1a; letter-spacing: -0.5px; }
.step-indicator { font-size: 12px; color: #999; font-weight: 600; background: #eee; padding: 4px 8px; border-radius: 12px; }

/* PROGRESS */
.progress-container { height: 4px; background: #eee; border-radius: 2px; margin-bottom: 30px; overflow: hidden; }
.progress-fill { height: 100%; background: #c21a1a; width: 20%; transition: width 0.4s ease; }

/* STEPS */
.step-content { display: none; animation: fadeIn 0.4s ease; }
.step-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.title { font-size: 24px; font-weight: 700; margin-bottom: 24px; text-align: center; line-height: 1.3; }

/* OPTIONS GRID */
.options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.option-card {
  background: white; border: 2px solid #f0f0f0; border-radius: 16px; padding: 20px 10px;
  text-align: center; cursor: pointer; transition: all 0.2s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.03);
}
.option-card:active { transform: scale(0.96); border-color: #c21a1a; background: #fffcfc; }
.option-icon { font-size: 32px; margin-bottom: 8px; display: block; }
.option-text { font-size: 15px; font-weight: 600; color: #333; }

/* TINDER CARDS */
#cards-wrapper { position: relative; width: 100%; height: 460px; margin-top: 10px; perspective: 1000px; }
.card {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  overflow: hidden; transform-origin: 50% 100%; will-change: transform; touch-action: none;
  display: flex; flex-direction: column;
}
.card img { width: 100%; height: 280px; object-fit: cover; pointer-events: none; }
.card-info { padding: 20px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
/* Responsive Text Clamping */
.card h3 { 
  font-size: clamp(18px, 4vw, 22px); margin-bottom: 4px; 
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}
.card p { 
  font-size: 14px; color: #666; line-height: 1.4; 
  display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
}
.price-tag { font-size: 20px; font-weight: 800; color: #c21a1a; margin-top: 8px; }
.match-badge {
  position: absolute; top: 16px; right: 16px; background: rgba(0,0,0,0.7);
  color: #fff; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; backdrop-filter: blur(4px);
}

/* ACTIONS */
.actions { display: flex; justify-content: center; gap: 20px; margin-top: 20px; position: relative; z-index: 10; }
.action-btn {
  width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 24px;
  cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.15); transition: transform 0.2s;
  display: flex; align-items: center; justify-content: center;
}
.btn-skip { background: white; color: #ff4b4b; }
.btn-like { background: #25D366; color: white; /* WhatsApp Green */ }
.action-btn:active { transform: scale(0.9); }

/* FLOATING BUTTONS */
.floating-bar {
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  display: flex; gap: 12px; z-index: 90;
}
.float-btn {
  background: #1d1d1f; color: white; border: none; padding: 10px 16px; border-radius: 30px;
  font-size: 13px; font-weight: 600; cursor: pointer; box-shadow: 0 6px 16px rgba(0,0,0,0.2);
  display: flex; align-items: center; gap: 6px; text-decoration: none; white-space: nowrap;
}
.float-btn.wheel { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; }

/* ALL PRODUCTS MODAL/VIEW */
.all-products-view {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fafafa;
  z-index: 100; overflow-y: auto; padding: 20px; display: none;
}
.all-products-view.active { display: block; animation: slideUp 0.3s ease; }
.close-view-btn { 
  position: sticky; top: 0; background: rgba(250,250,250,0.9); padding: 10px 0;
  display: flex; justify-content: flex-end; margin-bottom: 10px; z-index: 2; backdrop-filter: blur(5px);
}
.grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding-bottom: 40px; }
.grid-item { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.grid-item img { width: 100%; height: 140px; object-fit: cover; }
.grid-info { padding: 10px; }
.grid-title { font-size: 13px; font-weight: 700; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.grid-price { font-size: 14px; color: #c21a1a; font-weight: 700; }
.load-more-btn {
  width: 100%; padding: 12px; background: #eee; border: none; border-radius: 8px;
  font-weight: 600; color: #555; cursor: pointer; margin-bottom: 40px;
}

/* MODAL */
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 200; padding: 24px; overflow-y: auto; display: none; }
.modal.active { display: block; animation: slideUp 0.3s ease; }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

/* LOADER */
.loader { text-align: center; margin-top: 50px; color: #888; }
.spinner { width: 30px; height: 30px; border: 3px solid #ddd; border-top-color: #c21a1a; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px; }
@keyframes spin { 100% { transform: rotate(360deg); } }

.hidden { display: none !important; }
</style>
</head>
<body>

<div class="wizard-wrapper">
  
  <div class="header">
    <div class="back-btn" onclick="goBack()">‚Üê Geri</div>
    <div class="logo">üéÅ Brendimo</div>
    <div class="step-indicator" id="step-count">1/5</div>
  </div>

  <div class="progress-container">
    <div class="progress-fill" id="progress-bar"></div>
  </div>

  <div class="step-content active" id="step-0">
    <h2 class="title">H…ôdiyy…ô kimin √º√ß√ºnd√ºr?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'who')">
      <div class="option-card" data-val="Xanƒ±m"><span class="option-icon">üë©</span><span class="option-text">Xanƒ±m</span></div>
      <div class="option-card" data-val="B…ôy"><span class="option-icon">üë®</span><span class="option-text">B…ôy</span></div>
      <div class="option-card" data-val="U≈üaq"><span class="option-icon">üßí</span><span class="option-text">U≈üaq</span></div>
      <div class="option-card" data-val="H…ômkar"><span class="option-icon">üíº</span><span class="option-text">H…ômkar</span></div>
    </div>
  </div>

  <div class="step-content" id="step-1">
    <h2 class="title">Hansƒ± √∂z…ôl g√ºn √º√ß√ºn?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'occasion')">
      <div class="option-card" data-val="Ad g√ºn√º"><span class="option-icon">üéÇ</span><span class="option-text">Ad g√ºn√º</span></div>
      <div class="option-card" data-val="Yubiley"><span class="option-icon">ü•Ç</span><span class="option-text">Yubiley</span></div>
      <div class="option-card" data-val="Yeni ƒ∞l"><span class="option-icon">üéÑ</span><span class="option-text">Yeni ƒ∞l</span></div>
      <div class="option-card" data-val="S…ôb…ôbsiz"><span class="option-icon">üíù</span><span class="option-text">Sad…ôc…ô H…ôdiyy…ô</span></div>
    </div>
  </div>

  <div class="step-content" id="step-2">
    <h2 class="title">H…ôdiyy…ônin aurasƒ± nec…ô olsun?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'mood')">
      <div class="option-card" data-val="Romantik"><span class="option-icon">üåπ</span><span class="option-text">Romantik</span></div>
      <div class="option-card" data-val="R…ôsmi"><span class="option-icon">üëî</span><span class="option-text">R…ôsmi</span></div>
      <div class="option-card" data-val="Fun"><span class="option-icon">üéâ</span><span class="option-text">∆èyl…ônc…ôli</span></div>
      <div class="option-card" data-val="Faydalƒ±"><span class="option-icon">üìö</span><span class="option-text">Praktik/Faydalƒ±</span></div>
    </div>
  </div>

  <div class="step-content" id="step-3">
    <h2 class="title">Stil se√ßimi</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'style')">
      <div class="option-card" data-val="Modern"><span class="option-icon">‚ú®</span><span class="option-text">Modern</span></div>
      <div class="option-card" data-val="Klassik"><span class="option-icon">üèõÔ∏è</span><span class="option-text">Klassik</span></div>
      <div class="option-card" data-val="Minimal"><span class="option-icon">‚ö™</span><span class="option-text">Minimalist</span></div>
      <div class="option-card" data-val="L√ºks"><span class="option-icon">üíé</span><span class="option-text">L√ºks</span></div>
    </div>
  </div>

  <div class="step-content" id="step-4">
    <h2 class="title">B√ºdc…ô aralƒ±ƒüƒ±nƒ±z?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'budget')">
      <div class="option-card" data-val="0-20"><span class="option-icon">ü™ô</span><span class="option-text">0 - 20 AZN</span></div>
      <div class="option-card" data-val="20-50"><span class="option-icon">üíµ</span><span class="option-text">20 - 50 AZN</span></div>
      <div class="option-card" data-val="50-100"><span class="option-icon">üí∞</span><span class="option-text">50 - 100 AZN</span></div>
      <div class="option-card" data-val="100+"><span class="option-icon">üí≥</span><span class="option-text">100+ AZN</span></div>
    </div>
  </div>

  <div class="step-content" id="step-loading">
    <div class="loader"><div class="spinner"></div><p>Sehrbaz sizin √º√ß√ºn se√ßim edir...</p></div>
  </div>

  <div class="step-content" id="step-results">
    <h2 class="title" style="font-size: 20px; margin-bottom: 10px;">Sizin √º√ß√ºn se√ßdikl…ôrimiz</h2>
    <div id="cards-wrapper"></div>
    <div class="actions">
      <button class="action-btn btn-skip" id="btn-skip">‚úï</button>
      <button class="action-btn btn-like" id="btn-like">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
      </button>
    </div>
  </div>
</div>

<div class="floating-bar">
  <button class="float-btn" onclick="openAllProducts()">üõçÔ∏è B√ºt√ºn M…ôhsullar</button>
  <a href="https://brendimo-co.github.io/sanscarxi/" target="_blank" class="float-btn wheel" onclick="logUserAction('SpinWheel')">üéÅ H…ôdiyy…ô √áarxƒ±</a>
</div>

<div id="all-products-view" class="all-products-view">
  <div class="close-view-btn">
    <button onclick="closeAllProducts()" style="background:none; border:none; font-size:16px; font-weight:700; color:#333;">‚úï Baƒüla</button>
  </div>
  <h2 class="title" style="font-size:20px;">B√ºt√ºn M…ôhsullar</h2>
  <div class="grid-container" id="all-products-grid">
    </div>
  <button id="load-more-btn" class="load-more-btn" onclick="loadMoreGrid()">Daha √áox G√∂st…ôr (6)</button>
</div>

<div id="product-modal" class="modal">
  <div class="header"><div class="back-btn" onclick="closeModal()">‚úï Baƒüla</div></div>
  <img id="modal-img" src="" style="width:100%; border-radius:12px; margin-bottom:15px;">
  <h2 id="modal-title" style="margin-bottom:10px;"></h2>
  <h3 id="modal-price" style="color:#c21a1a; margin-bottom:15px;"></h3>
  <p id="modal-desc" style="line-height:1.6; color:#555; margin-bottom:20px;"></p>
  <button id="modal-whatsapp-btn" class="float-btn" style="width:100%; justify-content:center; background:#25D366; color:white;">WhatsApp il…ô Sifari≈ü</button>
</div>

<script>
// --- CONFIGURATION ---
const SHEETS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxe3u8E5WYNQp_e_OIDlJbR7rbmTVLdHHzc2rrhseUhFwddRDv74s2PhZKOKm3l3Qpw/exec"; 
const WHATSAPP_NUMBER = "994556742535";

// --- STATE ---
let currentStep = 0;
const totalSteps = 5;
const state = { who: null, occasion: null, mood: null, style: null, budget: null, products: [], cardStack: [] };
let gridLimit = 6; // Start with 6 items (3 rows x 2 cols)

// --- LOGGING ---
function logUserAction(action, details = '') {
  fetch(SHEETS_ENDPOINT, {
    method: 'POST', mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ type: 'log', action: action, details: details })
  }).catch(console.error);
}

// --- NAVIGATION ---
function updateUI() {
  document.getElementById('step-count').textContent = (currentStep < totalSteps) ? `ADDIM ${currentStep + 1}/${totalSteps}` : 'N∆èTƒ∞C∆è';
  document.getElementById('progress-bar').style.width = `${((currentStep + 1) / totalSteps) * 100}%`;
  document.querySelector('.back-btn').style.opacity = currentStep === 0 ? '0' : '1';

  document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
  
  if (currentStep < totalSteps) {
    document.getElementById(`step-${currentStep}`).classList.add('active');
  } else if (currentStep === totalSteps) {
    document.getElementById('step-loading').classList.add('active');
    fetchProducts();
  } else {
    document.getElementById('step-results').classList.add('active');
  }
}

function goBack() {
  if (currentStep > 0) { currentStep--; updateUI(); }
}

function handleOptionClick(e, key) {
  const card = e.target.closest('.option-card');
  if (!card) return;
  state[key] = card.getAttribute('data-val');
  logUserAction('StepCompleted', `${key}: ${state[key]}`);
  currentStep++;
  updateUI();
}

// --- DATA ---
async function fetchProducts() {
  try {
    const response = await fetch(`${SHEETS_ENDPOINT}?action=getProducts`);
    const data = await response.json();
    state.products = data.products || [];
    processMatches();
    currentStep++;
    updateUI();
    renderCards();
  } catch (error) {
    document.getElementById('step-loading').innerHTML = "<p>X…ôta ba≈ü verdi. Z…ôhm…ôt olmasa yenil…ôyin.</p>";
  }
}

function processMatches() {
  state.cardStack = state.products.map(p => {
    let score = 0;
    if (match(p.target, state.who)) score += 40;
    if (match(p.occasion, state.occasion)) score += 20;
    if (match(p.mood, state.mood)) score += 15;
    if (match(p.style, state.style)) score += 15;
    if (!checkBudget(p.price, state.budget)) score -= 30;
    p.score = Math.min(100, Math.max(0, score));
    return p;
  }).sort((a, b) => b.score - a.score);
}

function match(dbField, userSelect) {
  if (!dbField || !userSelect) return false;
  return dbField.toLowerCase().includes(userSelect.toLowerCase());
}

function checkBudget(price, budgetStr) {
  const p = Number(price);
  if (!budgetStr) return true;
  if (budgetStr === '0-20') return p <= 20;
  if (budgetStr === '20-50') return p > 20 && p <= 50;
  if (budgetStr === '50-100') return p > 50 && p <= 100;
  if (budgetStr === '100+') return p > 100;
  return true;
}

// --- CARD RENDERING & SWIPE ---
function renderCards() {
  const container = document.getElementById('cards-wrapper');
  container.innerHTML = '';
  
  if (state.cardStack.length === 0) {
    container.innerHTML = '<div style="text-align:center; padding:40px;">Uyƒüun m…ôhsul tapƒ±lmadƒ±.</div>';
    return;
  }

  state.cardStack.slice(0, 5).forEach((p, index) => {
    const card = document.createElement('div');
    card.className = 'card';
    card.style.zIndex = state.cardStack.length - index;
    card.innerHTML = `
      <div class="match-badge">${p.score}% Uyƒüunluq</div>
      <img src="${p.image}" alt="${p.name}">
      <div class="card-info">
        <div>
          <h3>${p.name}</h3>
          <p>${p.description || ''}</p>
        </div>
        <div class="price-tag">${p.price} AZN</div>
      </div>
    `;
    if (index === 0) initSwipe(card, p);
    card.addEventListener('dblclick', () => openModal(p));
    container.appendChild(card);
  });
}

function initSwipe(card, product) {
  let startX = 0, currentX = 0, isDragging = false;
  const onStart = (e) => { isDragging = true; startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX; card.style.transition = 'none'; };
  const onMove = (e) => {
    if (!isDragging) return;
    currentX = (e.type.includes('mouse') ? e.clientX : e.touches[0].clientX) - startX;
    card.style.transform = `translateX(${currentX}px) rotate(${currentX / 15}deg)`;
  };
  const onEnd = () => {
    if (!isDragging) return;
    isDragging = false;
    if (Math.abs(currentX) > 100) {
      const dir = currentX > 0 ? 1 : -1;
      card.style.transition = 'transform 0.4s ease';
      card.style.transform = `translateX(${dir * window.innerWidth * 1.5}px) rotate(${dir * 30}deg)`;
      setTimeout(() => {
        card.remove();
        state.cardStack.shift();
        if (dir === 1) redirectToWhatsApp(product); // Direct to WA on Like
        else logUserAction('Skipped', product.name);
        renderCards();
      }, 300);
    } else {
      card.style.transition = 'transform 0.3s ease';
      card.style.transform = 'translateX(0)';
    }
    currentX = 0;
  };
  card.addEventListener('mousedown', onStart); document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onEnd);
  card.addEventListener('touchstart', onStart); document.addEventListener('touchmove', onMove); document.addEventListener('touchend', onEnd);
}

// --- ALL PRODUCTS VIEW ---
function openAllProducts() {
  logUserAction('ViewAllProducts');
  if(state.products.length === 0) fetchProducts(); // Fetch if clicked on step 1
  document.getElementById('all-products-view').classList.add('active');
  renderGrid();
}

function closeAllProducts() {
  document.getElementById('all-products-view').classList.remove('active');
}

function renderGrid() {
  const container = document.getElementById('all-products-grid');
  container.innerHTML = '';
  // Use state.products (all items) or state.cardStack (filtered items)? 
  // User said "All Products", so we use state.products if available, otherwise fetch.
  const source = state.products.length ? state.products : [];
  
  source.slice(0, gridLimit).forEach(p => {
    const el = document.createElement('div');
    el.className = 'grid-item';
    el.onclick = () => openModal(p);
    el.innerHTML = `
      <img src="${p.image}" loading="lazy">
      <div class="grid-info">
        <div class="grid-title">${p.name}</div>
        <div class="grid-price">${p.price} AZN</div>
      </div>
    `;
    container.appendChild(el);
  });
  
  const btn = document.getElementById('load-more-btn');
  if(gridLimit >= source.length) btn.style.display = 'none';
  else btn.style.display = 'block';
}

function loadMoreGrid() {
  gridLimit += 6; // Load 3 more rows (6 items)
  renderGrid();
  logUserAction('LoadMoreProducts');
}

// --- ACTIONS ---
function redirectToWhatsApp(p) {
  logUserAction('Like_WhatsApp', p.name);
  const text = `Salam Brendimo! M…ôn bu m…ôhsulu b…ôy…ôndim: ${p.name} - ${p.price} AZN. Sifari≈ü etm…ôk ist…ôyir…ôm.`;
  const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`;
  // Slight delay to allow animation to finish visually
  setTimeout(() => window.location.href = url, 100); 
}

// --- MODAL ---
function openModal(p) {
  logUserAction('ViewDetails', p.name);
  document.getElementById('modal-img').src = p.image;
  document.getElementById('modal-title').textContent = p.name;
  document.getElementById('modal-price').textContent = p.price + ' AZN';
  document.getElementById('modal-desc').textContent = p.description;
  
  // Set Modal WhatsApp Button
  const btn = document.getElementById('modal-whatsapp-btn');
  btn.onclick = () => redirectToWhatsApp(p);
  
  document.getElementById('product-modal').classList.add('active');
}
function closeModal() { document.getElementById('product-modal').classList.remove('active'); }

// Init
updateUI();
</script>
</body>
</html>
