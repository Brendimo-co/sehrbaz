<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Brendimo H…ôdiyy…ô Sehrbazƒ±</title>
<meta property="og:type" content="website">
<meta property="og:title" content="üéÅ Brendimo H…ôdiyy…ô Sehrbazƒ±">
<meta property="og:description" content="H…ôdiyy…ô axtarƒ±≈üƒ±ndan yorulmusan? 30 saniy…ôy…ô ideal h…ôdiyy…ôni tap!">
<meta property="og:image" content="https://github.com/Brendimo-co/sehrbaz/blob/main/Gemini_Generated_Image_hzsbephzsbephzsb.png?raw=true">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* --- CSS STYLES --- */

/* RESET & BASE */
* { margin: 0; padding: 0; box-sizing: border-box; font-family: "Inter", sans-serif; -webkit-tap-highlight-color: transparent; }
body { 
  background: #fafafa; color: #1d1d1f; overflow-x: hidden; height: 100vh; display: flex; flex-direction: column; 
  /* Padding for Bottom Nav */
  padding-bottom: 70px; 
  overscroll-behavior-y: none; /* Prevent pull-to-refresh */
}

/* LAYOUT */
.wizard-wrapper {
  flex: 1; width: 100%; max-width: 440px; margin: 0 auto; padding: 15px 20px 40px 20px; 
  display: flex; flex-direction: column; position: relative;
}

/* HEADER */
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; height: 40px; }
.back-btn { font-size: 14px; color: #777; cursor: pointer; display: flex; align-items: center; gap: 4px; font-weight: 600; z-index: 50; }
.logo { font-size: 20px; font-weight: 800; color: #c21a1a; letter-spacing: -0.5px; cursor: pointer; }
.step-indicator { font-size: 12px; color: #999; font-weight: 600; background: #eee; padding: 4px 8px; border-radius: 12px; }

/* --- BOTTOM NAVIGATION --- */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 65px;
  background: rgba(255, 255, 255, 0.95); /* Blur effect */
  backdrop-filter: blur(10px);
  border-top: 1px solid #f0f0f0;
  display: flex;
  justify-content: space-around;
  align-items: center;
  z-index: 150; /* Above cards, below modals */
  padding-bottom: 5px; /* iOS Safe Area adjustment */
  box-shadow: 0 -4px 20px rgba(0,0,0,0.02);
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 20%;
  height: 100%;
  cursor: pointer;
  color: #999;
  transition: all 0.2s ease;
}

.nav-item.active {
  color: #c21a1a;
  transform: translateY(-2px);
}

.nav-icon {
  width: 24px;
  height: 24px;
  margin-bottom: 4px;
  fill: currentColor;
}

.nav-text {
  font-size: 10px;
  font-weight: 600;
}


/* --- STORIES SECTION --- */
.stories-wrapper {
  display: flex;
  gap: 14px;
  overflow-x: auto;
  padding: 5px 5px 20px 5px;
  margin-bottom: 10px;
  -webkit-overflow-scrolling: touch; /* Smooth scroll mobile */
  scrollbar-width: none; /* Firefox scrollbar gizl…ôt */
}
.stories-wrapper::-webkit-scrollbar { display: none; }

.story-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  min-width: 68px;
  cursor: pointer;
  transition: transform 0.2s;
}
.story-item:active { transform: scale(0.95); }

.story-ring {
  width: 66px;
  height: 66px;
  border-radius: 50%;
  padding: 3px; /* Border qalƒ±nlƒ±ƒüƒ± */
  position: relative;
  /* Instagram gradient r…ôngl…ôri v…ô ya Brendimo qƒ±rmƒ±zƒ±sƒ± */
  background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); 
  margin-bottom: 6px;
}

/* X√ºsusi r…ôngl…ôr: M…ôhsullar v…ô √áarx √º√ß√ºn */
.story-item[data-type="action"] .story-ring { background: #c21a1a; } /* Qƒ±rmƒ±zƒ± */
.story-item[data-type="link"] .story-ring { background: #FFD700; }   /* Qƒ±zƒ±lƒ± */

.story-ring img {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  border: 3px solid #fafafa; /* Aƒü ha≈üiy…ô */
  object-fit: cover;
  background: white;
}

.story-title {
  font-size: 11px;
  font-weight: 600;
  text-align: center;
  color: #333;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 70px;
}

/* --- STORY VIEWER (TAM EKRAN) --- */
.story-viewer {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: #000; z-index: 300;
  display: flex; flex-direction: column;
  transform: scale(0.9); opacity: 0; pointer-events: none;
  transition: all 0.2s ease;
}
.story-viewer.active { transform: scale(1); opacity: 1; pointer-events: all; }

.story-progress-container {
  display: flex; gap: 4px; padding: 10px; width: 100%;
  position: absolute; top: 0; z-index: 302;
}
.story-progress-bar {
  height: 2px; flex: 1; background: rgba(255,255,255,0.3);
  border-radius: 2px; overflow: hidden;
}
.story-progress-fill {
  height: 100%; background: white; width: 0%;
}

.story-header {
  position: absolute; top: 25px; left: 15px; z-index: 302;
  display: flex; align-items: center; gap: 10px;
}
.story-avatar { width: 32px; height: 32px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.5); }
.story-username { color: white; font-size: 13px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

.story-content {
  width: 100%; height: 100%; object-fit: cover;
}
.story-close {
  position: absolute; top: 20px; right: 20px;
  color: white; font-size: 24px; z-index: 303; cursor: pointer;
  padding: 10px;
}

/* Click areas for navigation */
.story-nav-left, .story-nav-right {
  position: absolute; top: 0; bottom: 0; width: 30%; z-index: 301;
}
.story-nav-left { left: 0; }
.story-nav-right { right: 0; }

/* PROGRESS */
.progress-container { height: 4px; background: #eee; border-radius: 2px; margin-bottom: 30px; overflow: hidden; }
.progress-fill { height: 100%; background: #c21a1a; width: 20%; transition: width 0.4s ease; }

/* --- NEW PREMIUM STEPS ANIMATION --- */
/* 1. Staggered Entrance Animation for Step Content */
.step-content { 
    display: none; 
}
.step-content.active { 
    display: block; 
}

/* We animate the grid items instead of the container for a "waterfall" effect */
.step-content.active .option-card {
    opacity: 0;
    animation: cardPopUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

/* Stagger delays for 4 items */
.step-content.active .option-card:nth-child(1) { animation-delay: 0.1s; }
.step-content.active .option-card:nth-child(2) { animation-delay: 0.2s; }
.step-content.active .option-card:nth-child(3) { animation-delay: 0.3s; }
.step-content.active .option-card:nth-child(4) { animation-delay: 0.4s; }

@keyframes cardPopUp {
    from { opacity: 0; transform: translateY(20px) scale(0.9); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

/* --- PREMIUM OPTIONS GRID --- */
.options-grid { 
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 16px; 
    padding: 5px; /* Space for shadows */
}

.option-card {
    background: #ffffff;
    /* Clean, soft shadow instead of border */
    box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.08); 
    border-radius: 24px; /* More rounded = more modern */
    padding: 30px 15px;
    text-align: center;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    border: 2px solid transparent; /* Prepare for border change */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    min-height: 160px; /* Taller cards look more expensive */
}

/* Floating Glow Background behind Icon */
.option-card::before {
    content: '';
    position: absolute;
    width: 80px;
    height: 80px;
    background: radial-gradient(circle, rgba(194, 26, 26, 0.08) 0%, rgba(255, 255, 255, 0) 70%);
    top: 50%;
    left: 50%;
    transform: translate(-50%, -80%);
    border-radius: 50%;
    z-index: 0;
    transition: all 0.4s ease;
}

.option-icon { 
    font-size: 42px; 
    margin-bottom: 15px; 
    display: block; 
    position: relative;
    z-index: 1;
    /* Subtle drop shadow on the emoji itself for 3D feel */
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
    transition: transform 0.3s ease;
}

.option-text { 
    font-size: 15px; 
    font-weight: 700; 
    color: #333; 
    line-height: 1.3; 
    position: relative;
    z-index: 1;
    transition: color 0.3s;
}

/* --- HOVER & ACTIVE STATES --- */
.option-card:active { 
    transform: scale(0.95); 
    box-shadow: 0 4px 10px rgba(194, 26, 26, 0.2);
}

/* Selected State (We will add this class via JS momentarily) */
.option-card.selected {
    border-color: #c21a1a;
    background: #fffafa; /* Very light red tint */
}

.option-card.selected .option-icon {
    transform: scale(1.15) rotate(-10deg);
}

.option-card.selected::before {
    background: radial-gradient(circle, rgba(194, 26, 26, 0.2) 0%, rgba(255, 255, 255, 0) 70%);
    transform: translate(-50%, -50%) scale(1.5);
}

.option-card.selected .option-text {
    color: #c21a1a;
}
/* Gradient overlay on hover/active for premium feel */
.option-card::before {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(194, 26, 26, 0.05) 100%);
    opacity: 0; transition: opacity 0.3s;
}
.option-card:active { transform: scale(0.96); border-color: #c21a1a; box-shadow: 0 2px 8px rgba(194, 26, 26, 0.1); }
.option-card:active::before { opacity: 1; }

.option-icon { font-size: 36px; margin-bottom: 12px; display: block; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
.option-text { font-size: 14px; font-weight: 700; color: #333; line-height: 1.4; }

/* CARDS STACK */
/* Update #cards-wrapper */
#cards-wrapper { 
  position: relative; 
  width: 100%; 
  height: 60vh; 
  max-height: 580px; 
  min-height: 420px;
  margin-top: 10px; 
  perspective: 1000px; 
  /* Prevent scrolling on the wrapper area */
  touch-action: none; 
  overscroll-behavior: contain;
}

/* Update .card */
.card {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  background: #ffffff; border-radius: 28px; 
  box-shadow: 0 15px 40px -10px rgba(0,0,0,0.12);
  overflow: hidden; 
  transform-origin: 50% 100%; 
  will-change: transform; 
  /* Critical for mobile smoothness */
  touch-action: none; 
  user-select: none;
  display: flex; flex-direction: column; padding: 12px; 
}
/* 1. Ensure the container holds the image and stamps together */
.card-image-box {
  position: relative; /* Acts as the anchor */
  width: 100%; 
  height: 68%; /* Or whatever height you prefer */
  border-radius: 20px;
  overflow: hidden; 
  background: #f4f4f5; 
  display: block; /* changed from flex to block to prevent squeezing */
}

.card-image-box img { 
  width: 100%; 
  height: 100%; 
  object-fit: cover; 
  display: block;
  pointer-events: none; /* Prevent drag issues */
}

/* 2. The Stamps (Floating Labels) */
/* --- 1. NEW SWIPE OVERLAYS (Icons instead of Text) --- */
.swipe-overlay {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  width: 80px;
  height: 80px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px; /* Icon size */
  z-index: 10;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.1s ease;
  backdrop-filter: blur(4px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

/* Red Cross for "NOPE" (Left Swipe) */
.overlay-nope {
  right: 30px; /* Positioned on the right side */
  background: rgba(255, 255, 255, 0.9);
  color: #ff4d4d;
  border: 2px solid #ff4d4d;
}

/* Green Heart for "LIKE" (Right Swipe) */
.overlay-like {
  left: 30px; /* Positioned on the left side */
  background: rgba(255, 255, 255, 0.9);
  color: #2ecc71;
  border: 2px solid #2ecc71;
}

/* --- 2. NEW ANIMATED SWIPE HINT (Finger Animation) --- */
.card-footer { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  margin-top: 12px; 
  position: relative; /* Needed for absolute positioning of hint */
}

/* Container for the hint */
.swipe-instruction {
  position: absolute;
  bottom: 0px; 
  right: 0px;
  display: flex;
  align-items: center;
  gap: 8px;
  opacity: 0.7;
}

/* The Finger Icon */
.hand-icon {
  font-size: 24px;
  animation: swipeHand 2s infinite ease-in-out;
}

/* The Text */
.hint-text {
  font-size: 11px;
  font-weight: 600;
  color: #888;
  display: flex;
  flex-direction: column;
  line-height: 1.2;
  text-align: right;
}

/* Animation: Moves hand left and right */
@keyframes swipeHand {
  0% { transform: translateX(0) rotate(0deg); }
  25% { transform: translateX(-10px) rotate(-10deg); } /* Swipe Left */
  50% { transform: translateX(0) rotate(0deg); }
  75% { transform: translateX(10px) rotate(10deg); } /* Swipe Right */
  100% { transform: translateX(0) rotate(0deg); }
}

/* 3. Specific Styles for Like (Green) */
.overlay-like {
  left: 40px;
  color: #2ecc71;
  border-color: #2ecc71;
  transform: rotate(-20deg);
}

/* 4. Specific Styles for Nope (Red) */
.overlay-nope {
  right: 40px;
  color: #c21a1a;
  border-color: #c21a1a;
  transform: rotate(20deg);
}

/* BADGES - FIXED (Point 1 & 2) */
.match-badge {
  position: absolute; top: 12px; right: 12px; background: rgba(255, 255, 255, 0.95);
  color: #c21a1a; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 800;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1); backdrop-filter: blur(4px); z-index: 2;
}
.badge-bestseller {
  position: absolute; top: 12px; left: 12px; background: #FFD700; color: #000;
  padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 800;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15); z-index: 3; display: flex; align-items: center; gap: 4px;
}
/* New Fixed Low Stock Badge - On Image */
.badge-lowstock-fixed {
  position: absolute; bottom: 12px; left: 12px; background: rgba(194, 26, 26, 0.9); color: white;
  padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 700;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 3; backdrop-filter: blur(2px);
}

.card-info { flex: 1; padding: 16px 8px 8px 8px; display: flex; flex-direction: column; justify-content: flex-end; }
.card h3 { 
  font-size: 22px; font-weight: 700; color: #1a1a1a; margin: 0 0 6px 0; letter-spacing: -0.5px;
  line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}
.card-desc-preview {
  font-size: 14px; color: #888; font-weight: 400; margin-bottom: auto; line-height: 1.4;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}
.card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }


/* --- THE COOL FEAR-INDUCING DISCOUNT BAR --- */
.fear-bar-wrapper {
    background: linear-gradient(135deg, #111, #222);
    color: white; padding: 12px 16px; border-radius: 12px;
    margin-bottom: 20px; border: 1px solid #FFD700;
    box-shadow: 0 8px 20px rgba(0,0,0,0.25);
    animation: slideDown 0.6s ease;
    position: relative; overflow: hidden;
}
.fear-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.fear-title { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: #ccc; }
.fear-amount { 
    font-size: 22px; font-weight: 800; color: #FFD700; 
    text-shadow: 0 0 15px rgba(255, 215, 0, 0.4); 
    font-variant-numeric: tabular-nums;
}
.shake-it { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; color: #ff4d4d !important; text-shadow: 0 0 10px rgba(255, 77, 77, 0.6); }

.timer-track { width: 100%; height: 6px; background: rgba(255,255,255,0.15); border-radius: 3px; overflow: hidden; }
.timer-fill { 
    height: 100%; background: linear-gradient(90deg, #FFD700, #ff4d4d); 
    width: 100%; transition: width 1s linear; 
}
.fear-warning { 
    margin-top: 6px; font-size: 11px; color: #ff6b6b; font-weight: 600; 
    text-align: right; font-style: italic; opacity: 0; animation: flashWarn 2s infinite; 
}
@keyframes flashWarn { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
@keyframes shake { 
    10%, 90% { transform: translate3d(-1px, 0, 0); }
    20%, 80% { transform: translate3d(2px, 0, 0); }
    30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
    40%, 60% { transform: translate3d(4px, 0, 0); }
}

/* NOTIFICATION TOAST (SWIPEABLE) */
.notif-toast {
    position: fixed; top: 15px; left: 50%; transform: translateX(-50%) translateY(-150px);
    background: white; border-radius: 30px; padding: 8px 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 999;
    display: flex; align-items: center; gap: 10px; min-width: 280px;
    transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: 1px solid #eee; touch-action: none; /* For swipe up to dismiss */
}
.notif-toast.show { transform: translateX(-50%) translateY(0); }
.notif-icon { width: 32px; height: 32px; background: #e0f2fe; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; }
.notif-content { display: flex; flex-direction: column; }
.notif-title { font-size: 11px; color: #888; font-weight: 600; }
.notif-desc { font-size: 13px; font-weight: 700; color: #333; }

/* MODAL & REVIEWS (INSTAGRAM STYLE) */
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 200; display: none; padding-bottom: 0; }
.modal.active { display: block; animation: slideUp 0.3s ease; }
.modal-content-scroll { height: 100%; overflow-y: auto; padding: 20px 20px 100px 20px; overscroll-behavior-y: contain; }

.review-section { margin-top: 30px; border-top: 1px solid #f0f0f0; padding-top: 20px; }
.review-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.review-stats { display: flex; align-items: center; gap: 5px; }
.star-icon { color: #FFD700; font-size: 14px; }
.comment-box { background: #f9f9f9; border-radius: 12px; padding: 12px; margin-bottom: 15px; }
.comment-user { display: flex; gap: 10px; margin-bottom: 8px; }
.user-avatar { width: 30px; height: 30px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: #555; }
.user-text { flex: 1; }
.u-name { font-size: 12px; font-weight: 700; display: block; }
.u-comment { font-size: 13px; color: #333; line-height: 1.4; }
.add-review-btn { color: #c21a1a; font-size: 13px; font-weight: 600; cursor: pointer; }

/* INPUT FORM FOR REVIEW */
.review-form { display: none; margin-top: 10px; background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 12px; }
.review-form.active { display: block; }
.form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; font-size: 14px; }
.star-select { display: flex; gap: 5px; margin-bottom: 10px; cursor: pointer; }
.star-opt { font-size: 20px; color: #ddd; }
.star-opt.selected { color: #FFD700; }

/* ALL PRODUCTS GRID */
/* Adjusted z-index to sit below navbar but above content */
.all-products-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fafafa; z-index: 100; overflow-y: auto; padding: 20px; padding-bottom: 80px; display: none; }
.all-products-view.active { display: block; animation: slideUp 0.3s ease; }
.grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding-bottom: 40px; }
.grid-item { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; cursor: pointer; }
.grid-item img { width: 100%; height: 150px; object-fit: cover; }
.grid-info { padding: 12px; }
.grid-title { font-size: 13px; font-weight: 700; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.grid-price-box { display: flex; flex-direction: column; }
.grid-old-price { font-size: 11px; text-decoration: line-through; color: #bbb; }
.grid-new-price { color: #c21a1a; font-weight: 800; font-size: 15px; }

/* MAGIC LOADER */
.magic-loader-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 60vh; position: relative; }
.magic-wand-wrapper { position: relative; width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; }
.magic-wand { font-size: 64px; z-index: 2; animation: waveWand 2.5s ease-in-out infinite; transform-origin: bottom left; }
.magic-aura { position: absolute; width: 60px; height: 60px; background: radial-gradient(circle, rgba(194, 26, 26, 0.4) 0%, rgba(255, 215, 0, 0) 70%); border-radius: 50%; animation: pulseGlow 2s infinite; z-index: 1; }
.sparkle { position: absolute; color: #FFD700; font-size: 20px; opacity: 0; animation: sparkleFloat 2s infinite; }
.s1 { top: 0; right: 0; animation-delay: 0.2s; }
.s2 { top: 20px; left: -10px; animation-delay: 0.5s; font-size: 14px; }
.s3 { bottom: 0; right: -10px; animation-delay: 0.8s; font-size: 24px; }
.s4 { bottom: 20px; left: 0; animation-delay: 1.2s; }
.magic-text { margin-top: 30px; font-size: 18px; font-weight: 600; color: #555; text-align: center; animation: textFade 0.5s; min-height: 25px; }

@keyframes waveWand { 0% { transform: rotate(0deg); } 25% { transform: rotate(-15deg); } 50% { transform: rotate(0deg); } 75% { transform: rotate(10deg); } 100% { transform: rotate(0deg); } }
@keyframes pulseGlow { 0% { transform: scale(0.8); opacity: 0.5; } 50% { transform: scale(1.5); opacity: 0.2; } 100% { transform: scale(0.8); opacity: 0.5; } }
@keyframes sparkleFloat { 0% { transform: translateY(0) scale(0); opacity: 0; } 50% { opacity: 1; } 100% { transform: translateY(-40px) scale(1.2); opacity: 0; } }
@keyframes textFade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.hidden { display: none !important; }
/* --- AMBIENT BACKGROUND ANIMATION --- */
.ambient-bg {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: -1; /* H…ôr ≈üeyin arxasƒ±nda */
  overflow: hidden;
  background: #fafafa; /* ∆èsas fon */
}

.blob {
  position: absolute;
  border-radius: 50%;
  filter: blur(80px); /* L…ôk…ôl…ôri yum≈üaldƒ±r */
  opacity: 0.6;
  animation: floatBackground 20s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
}

/* 1. Brendimo Qƒ±rmƒ±zƒ±sƒ±nƒ±n √ßox a√ßƒ±q tonu (Romantik/ƒ∞sti) */
.blob-1 {
  width: 500px;
  height: 500px;
  background: #ffe3e3; 
  top: -10%;
  left: -10%;
  animation-delay: 0s;
}

/* 2. Qƒ±zƒ±lƒ± ton (Premium/L√ºks) */
.blob-2 {
  width: 400px;
  height: 400px;
  background: #fff8d6;
  bottom: -10%;
  right: -10%;
  animation-delay: -5s;
}

/* 3. B…ôn√∂v≈ü…ôyi/Mavi ton (D…ôrinlik/Rahatlƒ±q) */
.blob-3 {
  width: 300px;
  height: 300px;
  background: #f0f4ff;
  top: 40%;
  left: 30%;
  opacity: 0.4;
  animation-delay: -10s;
}

/* Taxƒ±l (Noise) Effekti - Daha "Kaƒüƒ±z" hissi verir */
.noise-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0.03;
  pointer-events: none;
  background-image: url("https://grainy-gradients.vercel.app/noise.svg");
}

@keyframes floatBackground {
  0% { transform: translate(0, 0) scale(1); }
  33% { transform: translate(30px, 50px) scale(1.1); }
  66% { transform: translate(-20px, 20px) scale(0.9); }
  100% { transform: translate(20px, -40px) scale(1.05); }
}

/* --- ABOUT / FOOTER STYLES --- */
.home-footer {
  margin-top: 30px;
  text-align: center;
  padding-bottom: 20px;
}

.about-trigger {
  font-size: 13px;
  color: #999;
  text-decoration: underline;
  cursor: pointer;
  padding: 10px;
}

.about-content h3 {
  color: #c21a1a;
  font-size: 20px;
  margin-bottom: 10px;
  margin-top: 20px;
}

.about-content p {
  font-size: 15px;
  line-height: 1.6;
  color: #444;
  margin-bottom: 15px;
}

.mission-box {
  background: #fffcf0;
  border: 1px solid #FFD700;
  padding: 15px;
  border-radius: 12px;
  margin-top: 20px;
}

/* --- DISCOUNT PRICING STYLES --- */
.price-container {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.old-price {
  text-decoration: line-through;
  color: #999;
  font-size: 16px;
  font-weight: 500;
}

.current-price-styled {
  color: #c21a1a;
  font-weight: 800;
  font-size: 24px;
}

.discount-badge-small {
  background: #ffebee;
  color: #c21a1a;
  border: 1px solid #ffcdd2;
  padding: 2px 6px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
}

/* --- MODAL SWIPE HINT --- */
.modal-image-wrapper {
  position: relative;
  width: 100%;
  min-height: 300px;
  border-radius: 20px;
  overflow: hidden;
  margin-bottom: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.modal-hint {
  bottom: 15px;
  right: 15px;
  background: rgba(255, 255, 255, 0.75); /* Semi-transparent background */
  backdrop-filter: blur(4px);
  padding: 6px 12px;
  border-radius: 20px;
  z-index: 10;
  border: 1px solid rgba(255,255,255,0.5);
}

/* Make the text slightly darker for readability on images */
.modal-hint .hint-text {
  color: #333; 
  font-weight: 700;
  text-transform: uppercase;
  font-size: 10px;
}

  /* --- SECONDARY BACK BUTTON --- */
.secondary-back-btn {
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  border: 2px solid #eee; /* Subtle border */
  background: transparent;
  color: #777;
  font-weight: 700;
  font-size: 15px;
  cursor: pointer;
  margin-bottom: 30px; /* Space before reviews section */
  transition: all 0.2s ease;
}

.secondary-back-btn:active {
  background: #f5f5f5;
  border-color: #ddd;
  transform: scale(0.98); /* Slight click effect */
  color: #333;
}

.swipe-instruction {
  pointer-events: none; /* Bunu …ôlav…ô edin */
}
 
/* --- FAVORITES STYLES --- */
.fav-remove-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255, 255, 255, 0.9);
    color: #ff4d4d;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    z-index: 5;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.bulk-btn-wrapper {
    position: fixed;
    bottom: 80px; /* Above nav bar */
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    max-width: 400px;
    z-index: 101;
}
.bulk-btn {
    width: 100%;
    background: #25D366;
    color: white;
    padding: 15px;
    border-radius: 15px;
    border: none;
    font-weight: 700;
    font-size: 16px;
    box-shadow: 0 5px 20px rgba(37, 211, 102, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    cursor: pointer;
    transition: transform 0.2s;
}
.bulk-btn:active { transform: scale(0.96); }

/* --- 1. FORCE NAV BAR ON TOP --- */
.bottom-nav {
    z-index: 250 !important; /* Higher than modal (200) */
}

/* --- 2. COOL FLOATING LIKE BUTTON --- */
/* --- FIXED LIKE BUTTON --- */
.modal-like-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 45px;
    height: 45px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 50%;
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    z-index: 100; /* Increased to sit above everything */
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    color: #ccc; /* Default (Gray/Empty) */
    
    /* CRITICAL FIXES FOR MOBILE TOUCH */
    touch-action: manipulation; 
    -webkit-tap-highlight-color: transparent;
    user-select: none;
}

.modal-like-btn.liked {
    color: #c21a1a; /* Red when liked */
    transform: scale(1.1);
    box-shadow: 0 5px 20px rgba(194, 26, 26, 0.2);
}

.modal-like-btn:active {
    transform: scale(0.9);
}
 /* --- PROMO BUBBLE (MOVABLE) --- */
.promo-bubble {
    position: fixed;
    bottom: 100px;
    right: 20px;
    width: 80px;
    height: 80px;
    background: rgba(194, 26, 26, 0.85); /* Brendimo Red Transparent */
    backdrop-filter: blur(8px);
    border-radius: 50%;
    box-shadow: 0 8px 25px rgba(194, 26, 26, 0.4);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: white;
    touch-action: none; /* Critical for dragging */
    transition: transform 0.1s;
    animation: floatBubble 3s ease-in-out infinite;
    border: 1px solid rgba(255,255,255,0.2);
}

.bubble-content { position: relative; z-index: 2; pointer-events: none; }
.bubble-text { font-size: 9px; line-height: 1.2; display: block; }
.bubble-icon { font-size: 18px; display: block; margin-bottom: 2px; }

.bubble-close {
    position: absolute; top: -5px; right: -5px;
    background: #333; color: white;
    width: 20px; height: 20px;
    border-radius: 50%; font-size: 12px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; z-index: 3;
}

/* Heart Impulse Animation */
.bubble-pulse {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    border-radius: 50%; border: 2px solid #c21a1a;
    animation: pulseRing 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
    z-index: 1; pointer-events: none;
}

@keyframes pulseRing {
    0% { transform: scale(0.95); opacity: 1; }
    100% { transform: scale(1.6); opacity: 0; }
}
@keyframes floatBubble {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-6px); }
}

/* --- CUSTOM POPUPS --- */
.custom-popup {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 10000; display: none;
    align-items: center; justify-content: center;
}
.custom-popup.active { display: flex; animation: fadeIn 0.3s forwards; }

.popup-backdrop {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); backdrop-filter: blur(3px);
}

.popup-card {
    background: white; width: 85%; max-width: 320px;
    padding: 25px 20px; border-radius: 24px;
    text-align: center; position: relative; z-index: 2;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    transform: scale(0.8); opacity: 0;
    animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

.popup-icon { font-size: 40px; margin-bottom: 10px; }
.popup-card h3 { color: #c21a1a; font-size: 20px; margin-bottom: 10px; font-weight: 800; }
.popup-card p { font-size: 15px; color: #444; line-height: 1.5; margin-bottom: 20px; }
.popup-btn {
    background: #c21a1a; color: white; border: none;
    padding: 12px 30px; border-radius: 12px;
    font-size: 16px; font-weight: 700; cursor: pointer;
    box-shadow: 0 4px 15px rgba(194, 26, 26, 0.3);
}

@keyframes popIn { to { transform: scale(1); opacity: 1; } } 
</style>
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '752296677155305');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=752296677155305&ev=PageView&noscript=1"
/></noscript>
</head>
<body>
<div class="ambient-bg">
  <div class="blob blob-1"></div>
  <div class="blob blob-2"></div>
  <div class="blob blob-3"></div>
  <div class="noise-overlay"></div>
</div>

<div id="notif-toast" class="notif-toast">
    <div class="notif-icon">üì¶</div>
    <div class="notif-content">
        <span class="notif-title" id="notif-user">...</span>
        <span class="notif-desc" id="notif-product">...</span>
    </div>
</div>

<div class="wizard-wrapper">
 <div class="header">
    <div class="back-btn" onclick="goBack()">‚Üê Geri</div>
    <div class="logo" onclick="restartApp()">üéÅ Brendimo</div>
    <div class="step-indicator" id="step-count">1/5</div>
</div>

 <div class="stories-wrapper" id="stories-container"></div>

 <div class="story-viewer" id="story-viewer">
    <div class="story-progress-container" id="story-progress-bars"></div>
    <div class="story-header">
      <img src="https://via.placeholder.com/50" class="story-avatar" id="sv-avatar">
      <span class="story-username" id="sv-name">Brendimo</span>
    </div>
    <div class="story-close" onclick="closeStory()">‚úï</div>
    <div class="story-nav-left" onclick="prevStory()"></div>
    <div class="story-nav-right" onclick="nextStory()"></div>
    <img src="" class="story-content" id="sv-image">
  </div>

  <div class="progress-container">
    <div class="progress-fill" id="progress-bar"></div>
  </div>

  <div class="step-content active" id="step-0">
    <h2 class="title">H…ôdiyy…ôni kim √º√ß√ºn axtarƒ±rƒ±q?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'who')">
      <div class="option-card" data-val="Xanƒ±m"><span class="option-icon">üë©</span><span class="option-text">Xanƒ±m</span></div>
      <div class="option-card" data-val="B…ôy"><span class="option-icon">üë®</span><span class="option-text">B…ôy</span></div>
      <div class="option-card" data-val="U≈üaq"><span class="option-icon">üßí</span><span class="option-text">U≈üaq/Yeniyetm…ô</span></div>
      <div class="option-card" data-val="H…ômkar"><span class="option-icon">üíº</span><span class="option-text">H…ômkar</span></div>
    </div>
  </div>
  
  <div class="step-content" id="step-1">
    <h2 class="title">Hansƒ± √∂z…ôl g√ºn √º√ß√ºn?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'occasion')">
      <div class="option-card" data-val="Adg√ºn√º"><span class="option-icon">üéÇ</span><span class="option-text">Ad g√ºn√º/ƒ∞l d√∂n√ºm√º</span></div>
      <div class="option-card" data-val="T…ôbrik"><span class="option-icon">ü•Ç</span><span class="option-text">T…ôbrik/T…ô≈ü…ôkk√ºr</span></div>
      <div class="option-card" data-val="Yeniil"><span class="option-icon">üéÑ</span><span class="option-text">Yeni il</span></div>
      <div class="option-card" data-val="S…ôb…ôbsiz"><span class="option-icon">üíù</span><span class="option-text">ƒ∞√ßimd…ôn g…ôldi</span></div>
    </div>
  </div>

  <div class="step-content" id="step-2">
    <h2 class="title">Hansƒ± tip h…ôdiyy…ô daha uyƒüundur?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'mood')">
      <div class="option-card" data-val="Aksesuar"><span class="option-icon">üëù</span><span class="option-text">Aksesuar</span></div>
      <div class="option-card" data-val="Giftset"><span class="option-icon">üõç</span><span class="option-text">H…ôdiyy…ô seti</span></div>
      <div class="option-card" data-val="G√∂z…ôllik"><span class="option-icon">üï∂Ô∏è</span><span class="option-text">G√∂z…ôllik/√ñz√ºn…ô qulluq</span></div>
      <div class="option-card" data-val="Qarƒ±≈üƒ±q"><span class="option-icon">üîÆ</span><span class="option-text">Sehrbaz uyƒüunla≈üdƒ±rsƒ±n!</span></div>
    </div>
  </div>

  <div class="step-content" id="step-3">
    <h2 class="title">H…ôdiyy…ônin xarakteri nec…ô olmalƒ±dƒ±r?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'style')">
      <div class="option-card" data-val="Praktik"><span class="option-icon">üòá</span><span class="option-text">Praktik: G√ºnd…ôlik istifad…ô ed…ô bil…ôc…ôyi, i≈ü…ô yarayan bir …ô≈üya.</span></div>
      <div class="option-card" data-val="Emosional"><span class="option-icon">üò≤</span><span class="option-text">Emosional: Nadir, qeyri-adi, he√ß kimd…ô olmayan</span></div>
      <div class="option-card" data-val="L√ºks"><span class="option-icon">üòé</span><span class="option-text">L√ºks/Status: Brend, keyfiyy…ôtli v…ô prestijli bir …ô≈üya.</span></div>
      <div class="option-card" data-val="G√ºl√º≈ü"><span class="option-icon">ü§≠</span><span class="option-text">G√ºl√º≈ü v…ô T…ôb…ôss√ºm: (Zarafatcƒ±l, …ôyl…ônc…ôli, stressi alan h…ôdiyy…ô).</span></div>
    </div>
  </div>

  <div class="step-content" id="step-4">
    <h2 class="title">B√ºdc…ô aralƒ±ƒüƒ±nƒ±z t…ôxmin…ôn n…ô q…ôd…ôrdir?</h2>
    <div class="options-grid" onclick="handleOptionClick(event, 'budget')">
      <div class="option-card" data-val="0-30"><span class="option-icon">ü™ô</span><span class="option-text">Simvolik - Ki√ßik, amma m…ônalƒ± (0 - 30 AZN)</span></div>
      <div class="option-card" data-val="30-60"><span class="option-icon">üíµ</span><span class="option-text">Standart - Keyfiyy…ôtli h…ôdiyy…ô (30 - 60 AZN)</span></div>
      <div class="option-card" data-val="60-120"><span class="option-icon">üí∞</span><span class="option-text">Y√ºks…ôk - D…ôy…ôrli v…ô √∂z…ôl (60 - 120 AZN)</span></div>
      <div class="option-card" data-val="120+"><span class="option-icon">üí≥</span><span class="option-text">Limitsiz - Qiym…ôt √∂n…ômli deyil, …ôsas t…ôsiredici olsun (120+ AZN)</span></div>
    </div>
  </div>

  <div class="step-content" id="step-loading">
    <div class="magic-loader-container">
      <div class="magic-wand-wrapper">
        <div class="magic-wand">ü™Ñ</div>
        <div class="magic-aura"></div>
        <div class="sparkle s1">‚ú®</div>
        <div class="sparkle s2">‚≠ê</div>
        <div class="sparkle s3">‚ú®</div>
        <div class="sparkle s4">üí´</div>
      </div>
      <p class="magic-text" id="magic-status-text">Sehrli alqoritm i≈ü…ô d√º≈üd√º...</p>
    </div>
  </div>

  <div class="step-content" id="step-results">
    
    <div id="fear-bar-main" class="fear-bar-wrapper hidden">
        <div class="fear-header">
            <span class="fear-title">üî• ENDƒ∞Rƒ∞M ∆èRƒ∞Yƒ∞R...</span>
            <span id="gs-amount" class="fear-amount">-6.00 ‚Çº</span>
        </div>
        <div class="timer-track">
            <div id="gs-timer-fill" class="timer-fill"></div>
        </div>
        <div class="fear-warning">T…ôl…ôsin! H…ôr 30 saniy…ôd…ô 0.50 ‚Çº itirirsiniz!</div>
    </div>

    <h2 class="title" style="font-size: 20px; margin-bottom: 10px;">Onu xo≈üb…ôxt ed…ôc…ôk se√ßiml…ôr ‚ú®</h2>
    <div id="cards-wrapper"></div>
  </div>
  
  <div class="home-footer">
      <div class="about-trigger" onclick="openAboutModal()">
          Biz kimik? Haqqƒ±mƒ±zda oxu
      </div>
  </div>
</div>

<div id="about-modal" class="modal">
  <div class="header">
    <div class="back-btn" onclick="closeAboutModal()">‚úï Baƒüla</div>
  </div>

  <div class="about-content" style="padding-bottom: 50px;">
    <div style="text-align: center; margin-bottom: 20px;">
      <span style="font-size: 40px;">üéÅ</span>
      <h2 style="font-size: 24px; font-weight: 800; margin-top: 10px;">Brendimo</h2>
      <p style="color: #888; font-size: 14px;">H…ôdiyy…ô Sehrbazƒ±</p>
    </div>

    <h3>Biz Kimik?</h3>
    <p>
      Brendimo, h…ôdiyy…ô axtarƒ±≈üƒ±nƒ± stressd…ôn azad edib, …ôyl…ônc…ôli bir t…ôcr√ºb…ôy…ô √ßevir…ôn innovativ bir platformadƒ±r. Biz standart onlayn maƒüaza deyilik; biz sizin ≈ü…ôxsi h…ôdiyy…ô k√∂m…ôk√ßinizik.
    </p>

    <h3>N…ô Etm…ôy…ô √áalƒ±≈üƒ±rƒ±q?</h3>
    <div class="mission-box">
      <p style="margin-bottom: 0; font-weight: 600; color: #555;">
        üéØ Missiyamƒ±z:
      </p>
      <p style="margin-bottom: 0;">
        "N…ô alƒ±m?" sualƒ±nƒ± aradan qaldƒ±rmaq. S√ºni intellekt alqoritml…ôrimizl…ô, sevdiyiniz insan √º√ß√ºn …ôn ideal, …ôn uyƒüun v…ô …ôn yaddaqalan h…ôdiyy…ôni saniy…ôl…ôr i√ßind…ô tapmaƒüƒ±nƒ±za k√∂m…ôk edirik.
      </p>
    </div>

    <h3>D…ôy…ôrl…ôrimiz</h3>
    <ul style="padding-left: 20px; line-height: 1.8; color: #444;">
      <li>‚ú® <b>Kreativlik:</b> Sƒ±radan olmayan se√ßiml…ôr.</li>
      <li>üöÄ <b>S√ºr…ôt:</b> Vaxtƒ±nƒ±za q…ôna…ôt.</li>
      <li>‚ù§Ô∏è <b>Emosiya:</b> Sad…ôc…ô …ô≈üya yox, hiss b…ôx≈ü etm…ôk.</li>
    </ul>

    <div style="margin-top: 30px; text-align: center;">
      <p style="font-size: 12px; color: #aaa;">Brendimo ¬© 2025. B√ºt√ºn h√ºquqlar qorunur.</p>
    </div>
  </div>
</div>

<div id="all-products-view" class="all-products-view">
  <div id="all-products-close" style="position:sticky; top:0; z-index:2; display:flex; justify-content:flex-end; padding-bottom:10px;">
    <button onclick="handleNavClick('wizard')" style="background:#eee; border:none; padding:8px 16px; border-radius:20px; font-weight:700;">‚úï Baƒüla</button>
  </div>
  <h2 class="title" style="font-size:20px;">B√ºt√ºn M…ôhsullar</h2>
  <div class="grid-container" id="all-products-grid"></div>
  <button id="load-more-btn" class="load-more-btn" onclick="loadMoreGrid()" style="width:100%; padding:12px; background:#eee; border:none; border-radius:8px;">Daha √áox G√∂st…ôr (6)</button>
</div>

<div id="favorites-view" class="all-products-view">
  <div style="position:sticky; top:0; z-index:2; display:flex; justify-content:space-between; padding-bottom:10px; align-items:center;">
    <h2 class="title" style="font-size:20px; margin:0;">B…ôy…ôndikl…ôrim ‚ù§Ô∏è</h2>
    <button onclick="clearFavorites()" style="background:transparent; border:none; color:#999; font-size:12px; font-weight:600;">Hamƒ±sƒ±nƒ± Sil</button>
  </div>
  
  <div class="grid-container" id="favorites-grid" style="padding-bottom: 100px;"></div>
  
  <div id="fav-empty-msg" style="text-align:center; color:#999; margin-top:50px; display:none;">
    <span style="font-size:40px; display:block; margin-bottom:10px;">üíî</span>
    H…ôl…ô he√ß n…ô b…ôy…ônm…ômisiniz.
  </div>

  <div id="bulk-whatsapp-btn" class="bulk-btn-wrapper" style="display:none;">
      <button onclick="sendBulkWhatsApp()" class="bulk-btn">
         <span>Sifari≈üi Tamamla</span>
         <span style="font-size:18px;">üëâ</span>
      </button>
  </div>
</div>

<div id="product-modal" class="modal">
  <div class="header" style="padding:15px; position:absolute; top:0; left:0; width:100%; z-index:10; background:rgba(255,255,255,0.8); backdrop-filter:blur(5px);">
      <div class="back-btn" onclick="closeModal()">‚Üê Geri</div>
      <div id="modal-match-score" style="font-size:12px; font-weight:800; color:#c21a1a;"></div>
  </div>
  
  <div class="modal-content-scroll" style="padding-top:60px;">

      
      <div class="modal-image-wrapper">
          <img id="modal-img" src="" style="width:100%; height:100%; object-fit:cover;">
          
          <div class="swipe-instruction modal-hint">
             <div class="hint-text">
                <span>√áevir</span>
             </div>
             <div class="hand-icon">üëÜ</div>
          </div>
      </div>
      <h2 id="modal-title" style="margin-bottom:5px; line-height:1.3;"></h2>

      
      
      <div id="fear-bar-modal" class="fear-bar-wrapper" style="margin-bottom: 15px; padding: 10px; display:none;">
          <div class="fear-header">
              <span class="fear-title" style="font-size: 11px;">‚ö†Ô∏è QA√áIRMA!</span>
              <span id="modal-fear-amount" class="fear-amount" style="font-size: 18px;">-4.00 ‚Çº</span>
          </div>
          <div class="timer-track" style="height: 4px;">
              <div id="modal-timer-fill" class="timer-fill"></div>
          </div>
      </div>
      
      <div id="modal-price" style="margin-bottom:20px;"></div>
      <p id="modal-desc" style="line-height:1.6; color:#444; margin-bottom:30px; white-space: pre-line;"></p>
      
     <button id="modal-whatsapp-btn" style="width:100%; padding:16px; border-radius:12px; border:none; font-weight:700; font-size:16px; background:#25D366; color:white; box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3); margin-bottom:12px;">
       WhatsApp il…ô Sifari≈ü Et
     </button>

      <button onclick="closeModal()" class="secondary-back-btn">
         ‚Üê Geri Qayƒ±t
      </button>

      <div class="review-section">
          <div class="review-header">
              <h3 style="font-size:16px;">R…ôyl…ôr</h3>
              <div class="add-review-btn" onclick="toggleReviewForm()">+ R…ôy Yaz</div>
          </div>
          
          <div id="review-form" class="review-form">
              <div class="star-select" id="star-select">
                  <span class="star-opt" data-v="1">‚òÖ</span>
                  <span class="star-opt" data-v="2">‚òÖ</span>
                  <span class="star-opt" data-v="3">‚òÖ</span>
                  <span class="star-opt" data-v="4">‚òÖ</span>
                  <span class="star-opt" data-v="5">‚òÖ</span>
              </div>
              <input type="text" id="rev-name" placeholder="Adƒ±nƒ±z" class="form-input">
              <textarea id="rev-msg" placeholder="R…ôyiniz..." class="form-input" rows="2"></textarea>
              <button onclick="submitReview()" style="background:#333; color:white; border:none; padding:8px 15px; border-radius:8px; width:100%;">G√∂nd…ôr</button>
          </div>

          <div id="reviews-list"></div>
      </div>
  </div>
</div>

<nav class="bottom-nav">
  <div class="nav-item active" onclick="handleNavClick('wizard')" id="nav-wizard">
    <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5 9.5 9.75 12 11zm0 2.5l-5-2.5-5 2.5 10 5 10-5-5-2.5-5 2.5z"/></svg>
    <span class="nav-text">Sehrbaz</span>
  </div>
  <div class="nav-item" onclick="handleNavClick('mall')" id="nav-mall">
    <svg class="nav-icon" viewBox="0 0 24 24"><path d="M19 6h-2c0-2.76-2.24-5-5-5S7 3.24 7 6H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-7-3c1.66 0 3 1.34 3 3H9c0-1.66 1.34-3 3-3zm7 15H5V8h14v10z"/></svg>
    <span class="nav-text">SehrMall</span>
  </div>
  <div class="nav-item" onclick="handleNavClick('chat')" id="nav-chat">
    <svg class="nav-icon" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
    <span class="nav-text">SehrChat</span>
  </div>
  <div class="nav-item" onclick="handleNavClick('wheel')" id="nav-wheel">
    <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v4h-2zm0 6h2v4h-2z"/></svg>
    <span class="nav-text">SehrQazan</span>
  </div>
  <div class="nav-item" onclick="handleNavClick('fav')" id="nav-fav">
    <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
    <span class="nav-text">B…ôy…ôndikl…ôrim</span>
  </div>
</nav>

<div id="promo-bubble" class="promo-bubble">
    <div class="bubble-close" onclick="closeBubble()">‚úï</div>
    <div class="bubble-content">
        <span class="bubble-icon">üî•</span>
        <span class="bubble-text">3+ Sifari≈ü<br><b>-15‚Çº Endirim</b></span>
    </div>
    <div class="bubble-pulse"></div>
</div>

<div id="popup-welcome" class="custom-popup">
    <div class="popup-backdrop"></div>
    <div class="popup-card">
        <div class="popup-icon">üéâ</div>
        <h3>M√∂ht…ô≈ü…ôm X…ôb…ôr!</h3>
        <p>B√ºt√ºn m…ôhsullarda <b>5 G√ºnl√ºk √ñz…ôl Endirim</b> ba≈üladƒ±!</p>
        <p style="font-size: 13px; color: #666; margin-top: 8px;">B…ôy…ôndiyiniz m…ôhsullarƒ± toplayƒ±n, s…ôb…ôt b√∂y√ºd√ºkc…ô endirim artacaq.</p>
        <button onclick="closeCustomPopup('popup-welcome')" class="popup-btn">Ba≈üla üöÄ</button>
    </div>
</div>

<div id="popup-delivery" class="custom-popup">
    <div class="popup-backdrop"></div>
    <div class="popup-card">
        <div class="popup-icon">üöö</div>
        <h3>√áatdƒ±rƒ±lma H…ôdiyy…ô!</h3>
        <p>∆èla gedirs…ôn! ∆èg…ôr <b>2 v…ô daha √ßox</b> m…ôhsul sifari≈ü ets…ôn, √ßatdƒ±rƒ±lma bizd…ôn olacaq.</p>
        <button onclick="closeCustomPopup('popup-delivery')" class="popup-btn">Super! üòç</button>
    </div>
</div>
  
<script>
// --- CONFIGURATION ---
const SHEETS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzMLzwp2qpBlUT1tZkKuKh0rzE7I7BRTCxdMZv8gvK2c8u9SNlFrFfBCO6HiR5nJjVpEw/exec"; 
const WHATSAPP_NUMBER = "994556742535";

// --- STATE ---
let currentStep = 0;
const totalSteps = 5;
// --- STATE (UPDATED) ---
// This line ensures we load saved favorites from memory instead of starting empty!
// SAFE MEMORY LOADER
let savedLikes = [];
try {
    // Try to get data, but if Instagram blocks it, don't crash!
    const localData = localStorage.getItem('brendimo_likes');
    if (localData) savedLikes = JSON.parse(localData);
} catch (e) {
    console.log("Instagram DM Storage Restricted");
    savedLikes = []; // Fallback to empty list
}

const state = { 
    who: null, occasion: null, mood: null, style: null, budget: null, 
    products: [], cardStack: [], orders: [], viewedProductCount: 0,
    likedProducts: savedLikes
};
let gridLimit = 6; 
let currentModalIndex = -1;
let currentModalSource = []; 
let currentReviewRating = 0;
let reviewsCache = {};

// --- ANALYTICS DATA ---
let userIP = "Fetching...";
let sessionID = Math.random().toString(36).substring(2, 15);
let deviceName = getDeviceType();

// --- INITIALIZATION ---
function init() {
    initStories();
    preloadStories(); // Starts downloading story images immediately in background
    // We call this first. It will fetch IP -> Then Log "AppOpen" automatically
    fetchIP(); 
    
    initGlobalSwipe(); 
    initNotificationSwipe(); 
  initModalSwipe();
  initBubbleDrag(); // <--- ADD THIS 
  updateUI();
}
function preloadStories() {
  // Loops through all stories and forces the browser to download them now
  storiesData.forEach(s => {
    if(s.type === 'story' && s.content) {
      const img = new Image();
      img.src = s.content; 
    }
  });
}
// --- ANALYTICS FUNCTIONS (NEW) ---
function getDeviceType() {
    const ua = navigator.userAgent;
    if (/Android/i.test(ua)) return "Android Mobile";
    if (/iPhone|iPad|iPod/i.test(ua)) return "iPhone/iOS";
    if (/Windows/i.test(ua)) return "Windows PC";
    if (/Mac/i.test(ua)) return "Macbook/iMac";
    return "Other/Mobile";
}

async function fetchIP() {
    try {
        const res = await fetch('https://api.ipify.org?format=json');
        const data = await res.json();
        userIP = data.ip;
    } catch (e) {
        userIP = "Hidden/Error";
    }
    
    // MOVED HERE: Now we only log "App Open" after we have the IP (or failed to get it)
    initTracking();
}

// Enhanced Logger
function logUserAction(action, label = "-", value = "-") {
    // Sends structured data to the backend columns
    const payload = {
        type: 'log',
        sessionId: sessionID,
        ip: userIP,
        device: deviceName,
        action: action,
        label: label,   // e.g., "Product Name" or "Step Name"
        value: value,   // e.g., "50 AZN" or "For Him"
        screen: `${window.innerWidth}x${window.innerHeight}`
    };

    fetch(SHEETS_ENDPOINT, {
        method: 'POST', mode: 'no-cors', keepalive: true,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    }).catch(e => console.log("Log error"));
}

// --- NAVIGATION ---
function updateUI() {
  document.getElementById('step-count').textContent = (currentStep < totalSteps) ? `ADDIM ${currentStep + 1}/${totalSteps}` : 'N∆èTƒ∞C∆è';
  document.getElementById('progress-bar').style.width = `${((currentStep + 1) / totalSteps) * 100}%`;
  document.querySelector('.back-btn').style.opacity = currentStep === 0 ? '0' : '1';

  document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
  
  if (currentStep < totalSteps) {
    document.getElementById(`step-${currentStep}`).classList.add('active');
    // Log which step the user is on
    logUserAction("StepView", `Step ${currentStep+1}`);
  } else if (currentStep === totalSteps) {
    document.getElementById('step-loading').classList.add('active');
    fetchProducts();
  } else {
    document.getElementById('step-results').classList.add('active');
    logUserAction("ResultsView", "Showing Cards");
  }
}

function goBack() { 
    if (currentStep > 0) { 
        currentStep--; 
        logUserAction("Nav", "Back Button");
        updateUI(); 
    } 
}

function handleOptionClick(e, key) {
  // 1. Find the card
  const card = e.target.closest('.option-card');
  if (!card) return;

  // 2. Visual Feedback: Add 'selected' class
  // Remove 'selected' from siblings first (just in case)
  const siblings = card.parentElement.querySelectorAll('.option-card');
  siblings.forEach(s => s.classList.remove('selected'));
  
  card.classList.add('selected');

  // 3. Store the value
  const val = card.getAttribute('data-val');
  state[key] = val;

  // LOGGING
  logUserAction("StepCompleted", key, val);

  // 4. Slight Delay before moving (Premium Feel)
  // This allows the user to see the red border/animation confirmation
  setTimeout(() => {
    currentStep++;
    updateUI();
  }, 350); // 350ms delay
}

// --- NEW HELPER: CENTRAL FAVORITE LOGIC ---
function addToFavorites(product) {
    // 1. Check if it already exists to prevent duplicates
    const exists = state.likedProducts.some(p => p.name === product.name);
    
    // 2. If not in list, add it
    if (!exists) {
        state.likedProducts.push(product);
      try {
            localStorage.setItem('brendimo_likes', JSON.stringify(state.likedProducts));
        } catch (e) {
            console.log("Saving not supported in DM");
        }
    }

    }

function removeFromFavoritesGlobal(productName) {
    const index = state.likedProducts.findIndex(p => p.name === productName);
    if (index > -1) {
        state.likedProducts.splice(index, 1);
        localStorage.setItem('brendimo_likes', JSON.stringify(state.likedProducts));
    }
}
  
// --- DATA FETCHING ---
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

async function fetchProducts() {
  const statusTextEl = document.getElementById('magic-status-text');
  const messages = ["Sehrli axtarƒ±≈ü i≈ü…ô d√º≈üd√º... ü™Ñ", "Ona √∂z√ºn√º d…ôy…ôrli hiss etdir…ôc…ôk... ‚ú®", "Sizin √º√ß√ºn x√ºsusi Endirim …ôlav…ô olunur ü™Ñ", "V…ô... ƒ∞deal se√ßim tapƒ±ldƒ±! üéØ"];
  let msgIndex = 0;
  statusTextEl.textContent = messages[0];

  const textInterval = setInterval(() => {
    msgIndex++;
    if (msgIndex < messages.length) {
      statusTextEl.style.animation = 'none';
      statusTextEl.offsetHeight; 
      statusTextEl.style.animation = 'textFade 0.5s ease';
      statusTextEl.textContent = messages[msgIndex];
    }
  }, 1200); 

  try {
    const [prodRes, orderRes] = await Promise.all([
      fetch(`${SHEETS_ENDPOINT}?action=getProducts`),
      fetch(`${SHEETS_ENDPOINT}?action=getOrders`),
      new Promise(resolve => setTimeout(resolve, 4800)) 
    ]);

    const prodData = await prodRes.json();
    const orderData = await orderRes.json();
    clearInterval(textInterval);

    let rawProducts = shuffleArray(prodData.products || []);
    state.products = rawProducts.map(p => {
        const randomDisc = Math.floor(Math.random() * (35 - 20 + 1)) + 20; 
        const oldPriceVal = (parseFloat(p.price) / (1 - (randomDisc / 100))).toFixed(0);
        const isStockLow = Math.random() < 0.3;
        const stockCount = isStockLow ? Math.floor(Math.random() * 5) + 1 : null;
        return { ...p, discountPercent: randomDisc, oldPrice: oldPriceVal, isLowStock: isStockLow, stockCount: stockCount };
    });

    state.orders = orderData.orders || [];
    applyBadges(state.products);
    processMatches();
    currentStep++;
    updateUI();
    renderCards();
    
    // Start notifications INSIDE the try block
    startOrderNotifications(); 

    // Show popup 2 seconds later
    setTimeout(() => {
          showCustomPopup('popup-welcome');
    }, 2000); 

  } catch (error) {
    clearInterval(textInterval);
    console.error(error);
    document.getElementById('step-loading').innerHTML = "<p>X…ôta ba≈ü verdi. Z…ôhm…ôt olmasa yenil…ôyin.</p>";
  }
}

function applyBadges(products) {
    if (!products || products.length === 0) return;
    products.forEach(p => { delete p.isBestSeller; });
    if(products.length > 2 && products[2]) { products[2].isBestSeller = true; }
}

function processMatches() {
  let candidates = shuffleArray([...state.products]);
  if (state.who) candidates = candidates.filter(p => match(p.target, state.who));

  state.cardStack = candidates.map(p => {
    let score = 0;
    if (match(p.target, state.who)) score += 50; 
    if (match(p.occasion, state.occasion)) score += 20;
    if (match(p.mood, state.mood)) score += 15;
    if (match(p.style, state.style)) score += 15;
    if (!checkBudget(p.price, state.budget)) score -= 40;
    p.score = Math.min(100, Math.max(0, score));
    return p;
  }).sort((a, b) => b.score - a.score);
}

function match(dbField, userSelect) {
  if (!dbField || !userSelect) return false;
  return dbField.toLowerCase().includes(userSelect.toLowerCase());
}

function checkBudget(price, budgetStr) {
  const p = Number(price);
  if (!budgetStr) return true;
  if (budgetStr === '0-30') return p <= 30;
  if (budgetStr === '30-60') return p > 30 && p <= 60;
  if (budgetStr === '60-120') return p > 60 && p <= 120;
  if (budgetStr === '120+') return p > 120;
  return true;
}

// --- RENDER CARDS ---
function renderCards() {
  const container = document.getElementById('cards-wrapper');
  container.innerHTML = '';
  if (state.cardStack.length === 0) {
    container.innerHTML = '<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#888;"><p>Ba≈üqa se√ßim qalmadƒ±.</p><button onclick="restartApp()" style="margin-top:10px; padding:10px 20px; background:#333; color:white; border:none; border-radius:8px;">Yenid…ôn Ba≈üla</button></div>';
    return;
  }
  state.cardStack.slice(0, 3).forEach((p, index) => {
    const card = document.createElement('div');
    card.className = 'card';
    const scale = 1 - (index * 0.05);
    const translateY = index * 20;
    card.style.zIndex = state.cardStack.length - index;
    card.style.transform = `translateY(${translateY}px) scale(${scale})`;
    if (index !== 0) card.style.opacity = '0.5';
    else card.style.boxShadow = "0 20px 50px -12px rgba(0,0,0,0.15)";

    let badgesHtml = `<div class="match-badge">${p.score}% Uyƒüunluq</div>`;
    if (p.isBestSeller) badgesHtml += `<div class="badge-bestseller">üèÜ Best Seller</div>`;
    if (p.isLowStock) badgesHtml += `<div class="badge-lowstock-fixed">‚ö†Ô∏è ${p.stockCount} …ôd…ôd qaldƒ±</div>`;

    card.innerHTML = `
      <div class="card-image-box">
          <div class="swipe-overlay overlay-like">üíö</div> 
          <div class="swipe-overlay overlay-nope">‚úñÔ∏è</div>  
          ${badgesHtml} <img src="${fixImageLink(p.image)}" alt="${p.name}" draggable="false">
      </div>
      <div class="card-info">
        <h3>${p.name}</h3>
        <p class="card-desc-preview">${p.description || '∆ètraflƒ± m…ôlumat...'}</p>
        <div class="card-footer">
          <div class="price-container">
            <span class="old-price">${p.oldPrice}‚Çº</span>
            <div style="display:flex; flex-direction:column; align-items:flex-start; line-height:1;">
                <span class="current-price-styled">${p.price} AZN</span>
                <span class="discount-badge-small">üî• -${p.discountPercent}% Endirim</span>
            </div>
          </div>
          <div class="swipe-instruction">
             <div class="hint-text"><span>Saƒüa: <b>B…ôy…ôn</b></span><span>Sola: <b>KE√á</b></span></div>
             <div class="hand-icon">üëÜ</div>
          </div>
        </div>
      </div>`;
    if (index === 0) initCardSwipe(card, p);
    container.appendChild(card);
  });
}

// --- CARD SWIPE ---
function initCardSwipe(card, product) {
  let startX = 0, startY = 0, currentX = 0, currentY = 0, isDragging = false;
  const likeInd = card.querySelector('.overlay-like');
  const nopeInd = card.querySelector('.overlay-nope');

  const onStart = (e) => {
    isDragging = true;
    startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    startY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
    currentX = 0; currentY = 0;
    card.style.transition = 'none';
    addDocumentListeners();
  };

  const onMove = (e) => {
    if (!isDragging) return;
    const x = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    const y = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
    currentX = x - startX; currentY = y - startY;

    if (Math.abs(currentX) > Math.abs(currentY)) {
        if(e.cancelable && e.type === 'touchmove') e.preventDefault(); 
        card.style.transform = `translate(${currentX}px, ${currentY / 5}px) rotate(${currentX / 15}deg)`;
        const opacity = Math.min(1, Math.abs(currentX) / 80);
        if (currentX > 0) { 
            if(likeInd) { likeInd.style.opacity = opacity; likeInd.style.transform = `translateY(-50%) scale(${0.5 + (opacity * 0.5)})`; }
            if(nopeInd) nopeInd.style.opacity = 0; 
        } else { 
            if(nopeInd) { nopeInd.style.opacity = opacity; nopeInd.style.transform = `translateY(-50%) scale(${0.5 + (opacity * 0.5)})`; }
            if(likeInd) likeInd.style.opacity = 0; 
        }
    }
  };

  const onEnd = () => {
    if (!isDragging) return;
    isDragging = false;
    removeDocumentListeners();
    if(likeInd) likeInd.style.opacity = 0;
    if(nopeInd) nopeInd.style.opacity = 0;

    if (Math.abs(currentX) < 10 && Math.abs(currentY) < 10) { 
      openModal(product, state.cardStack, state.cardStack.indexOf(product));
      // LOG: Clicked Card
      logUserAction("CardClick", product.name);
      resetCard(); return; 
    }

    if (Math.abs(currentX) > 100) {
     trackInteraction(); // <--- ADD THIS
      const dir = currentX > 0 ? 1 : -1;
      card.style.transition = 'transform 0.4s ease';
      card.style.transform = `translate(${dir * window.innerWidth * 1.5}px, 0px) rotate(${dir * 30}deg)`;
      
      // LOG: Swiped Card
      const action = dir === 1 ? "SwipeRight (Like)" : "SwipeLeft (Nope)";
      logUserAction(action, product.name);

      // Inside initCardSwipe -> onEnd function
      setTimeout(() => {
        card.innerHTML = ''; // Clear content first to free memory immediately
        card.remove();       // Then remove the element
        state.cardStack.shift();
        
        // --- NEW FAVORITES LOGIC ---
     // --- UPDATED SWIPE RIGHT LOGIC ---
        if (dir === 1) {
             // Simply push the product. 
             // We removed the ".some()" check so it doesn't block items with similar names.
             state.likedProducts.push(product);
             localStorage.setItem('brendimo_likes', JSON.stringify(state.likedProducts));
            
             renderCards(); // Show next card
        } else {
             renderCards(); // Swipe Left (Nope)
        }
        // --- END NEW LOGIC ---

      }, 300);
    } else {
      resetCard();
    }
  };

  function resetCard() { card.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)'; card.style.transform = 'translate(0px, 0px) rotate(0deg)'; currentX = 0; currentY = 0; }
  function addDocumentListeners() { document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onEnd); document.addEventListener('touchmove', onMove, {passive: false}); document.addEventListener('touchend', onEnd); }
  function removeDocumentListeners() { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onEnd); document.removeEventListener('touchmove', onMove); document.removeEventListener('touchend', onEnd); }

  card.addEventListener('mousedown', onStart); 
  card.addEventListener('touchstart', onStart, {passive: false}); 
}

// --- GLOBAL BACK SWIPE ---
function initGlobalSwipe() {
    let startX = 0;
    document.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; }, {passive: true});
    document.addEventListener('touchend', (e) => {
        const endX = e.changedTouches[0].clientX;
        if (startX < 30 && (endX - startX > 100)) {
            const modal = document.querySelector('.modal.active');
            if (modal) { if(modal.id === 'product-modal') closeModal(); else closeAboutModal(); } 
            else { goBack(); }
        }
    }, {passive: true});
}

function initNotificationSwipe() {
    const toast = document.getElementById('notif-toast');
    let startY = 0;
    toast.addEventListener('touchstart', (e) => startY = e.touches[0].clientY, {passive: true});
    toast.addEventListener('touchend', (e) => { if (startY - e.changedTouches[0].clientY > 30) { toast.classList.remove('show'); } }, {passive: true});
}

function initModalSwipe() {
    const modal = document.getElementById('product-modal');
    let startX = 0, startY = 0;
    modal.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; startY = e.touches[0].clientY; }, {passive: true});
    modal.addEventListener('touchend', (e) => {
        const endX = e.changedTouches[0].clientX; const endY = e.changedTouches[0].clientY;
        const diffX = startX - endX; const diffY = startY - endY;
        if (Math.abs(diffX) > 60 && Math.abs(diffX) > Math.abs(diffY)) {
            if (diffX > 0) showNextModalProduct(); else showPrevModalProduct(); 
        }
    }, {passive: true});
}

function showNextModalProduct() { if (currentModalIndex < currentModalSource.length - 1) { openModal(currentModalSource[currentModalIndex + 1], currentModalSource, currentModalIndex + 1); } }
function showPrevModalProduct() { if (currentModalIndex > 0) { openModal(currentModalSource[currentModalIndex - 1], currentModalSource, currentModalIndex - 1); } }

// --- MODAL & REVIEWS ---


function openModal(p, sourceList = [], index = -1) {
 trackInteraction(); // <--- ADD THIS AT THE TOP
  state.viewedProductCount++;
  if (state.viewedProductCount >= 3) activateGlobalDiscount();

  currentModalSource = sourceList.length ? sourceList : state.products;
  currentModalIndex = index !== -1 ? index : currentModalSource.indexOf(p);

  document.getElementById('modal-img').src = fixImageLink(p.image);
  document.getElementById('modal-title').textContent = p.name || "Premium Ekskl√ºziv";
  document.getElementById('modal-match-score').textContent = (p.score || "90") + "% UYƒûUNLUQ";

  // --- LIKE BUTTON LOGIC STARTS ---
// --- LIKE BUTTON LOGIC STARTS (FIXED) ---
  const imgWrapper = document.querySelector('.modal-image-wrapper');
  
  // 1. Remove old button to prevent duplicates
  const oldBtn = imgWrapper.querySelector('.modal-like-btn');
  if(oldBtn) oldBtn.remove();

  // 2. Check current state
  const isLiked = state.likedProducts.some(item => item.name === p.name);

  // 3. Create the button
  const btn = document.createElement('div');
  btn.className = `modal-like-btn ${isLiked ? 'liked' : ''}`; 
  // We use a specific heart symbol that responds better to CSS colors than the standard emoji
  btn.innerHTML = '‚ù§'; 
  
  // 4. Robust Click Handler
  btn.onclick = (e) => {
      e.stopPropagation(); // Stop modal from closing or swiping
      e.preventDefault();  // Stop ghost clicks on mobile

      // Check fresh state (in case it changed since modal opened)
      const currentlyLiked = state.likedProducts.some(item => item.name === p.name);

      if (currentlyLiked) {
          // Remove
          removeFromFavoritesGlobal(p.name);
          btn.classList.remove('liked');
      } else {
          // Add
          addToFavorites(p);
          btn.classList.add('liked');
          
          // Tiny vibration for feedback (Android only usually)
          if (navigator.vibrate) navigator.vibrate(50);
      }
  };
  
  imgWrapper.appendChild(btn);
  // --- LIKE BUTTON LOGIC ENDS ---
  // --- LIKE BUTTON LOGIC ENDS ---

  document.getElementById('modal-price').innerHTML = `
    <span style="text-decoration:line-through;color:#999;font-size:18px;margin-right:10px;">${p.oldPrice}‚Çº</span>
    <span style="color:#c21a1a;font-weight:800;font-size:26px;">${p.price} AZN</span>
    <span class="discount-badge-small" style="font-size:14px; padding:4px 8px; vertical-align:middle;">-${p.discountPercent}%</span>
  `;
  document.getElementById('modal-desc').textContent = p.description;
  
  if(state.viewedProductCount >= 3) { document.getElementById('fear-bar-modal').style.display = 'block'; }
  
  fetchReviews(p.name);
  document.getElementById('modal-whatsapp-btn').onclick = () => redirectToWhatsApp(p);
  document.getElementById('product-modal').classList.add('active');
  
  initModalSwipe(); 
}

// HELPER FUNCTION: Handles the click on the heart
// HELPER FUNCTION: Handles the click on the heart
function toggleLikeFromModal(product, btnElement) {
    const isLiked = state.likedProducts.some(item => item.name === product.name);
    
    if (!isLiked) {
        // Not in list -> Add it
        addToFavorites(product);
        btnElement.classList.add('liked'); // Make it Red
    } else {
        // Already in list -> Remove it
        removeFromFavoritesGlobal(product.name);
        btnElement.classList.remove('liked'); // Make it Gray
    }
}

// UPDATE: When closing modal, refresh the Favorites grid if it is open!
function closeModal() { 
    document.getElementById('product-modal').classList.remove('active'); 
    
    // Check if the user is currently on the Favorites Page
    const favView = document.getElementById('favorites-view');
    if (favView.classList.contains('active')) {
        renderFavorites(); // RE-RENDER the grid to remove unliked items immediately
    }
}

async function fetchReviews(productName) {
    const list = document.getElementById('reviews-list');
    list.innerHTML = '<p style="color:#999;font-size:12px;">R…ôyl…ôr y√ºkl…ônir...</p>';
    if (reviewsCache[productName]) { renderReviews(reviewsCache[productName]); return; }
    try {
        const res = await fetch(`${SHEETS_ENDPOINT}?action=getReviews&product=${encodeURIComponent(productName)}`);
        const data = await res.json();
        const filteredReviews = (data.reviews || []).filter(r => r.product === productName);
        reviewsCache[productName] = filteredReviews;
        renderReviews(filteredReviews);
    } catch(e) { list.innerHTML = '<p style="color:#999;font-size:12px;">R…ôy yoxdur.</p>'; }
}

function renderReviews(reviews) {
    const list = document.getElementById('reviews-list');
    list.innerHTML = ''; 
    if(reviews.length === 0) { list.innerHTML = '<p style="color:#999;font-size:12px;">H…ôl…ô ki r…ôy yoxdur. ƒ∞lk r…ôyi s…ôn yaz! üëá</p>'; return; }
    reviews.forEach(r => {
        const el = document.createElement('div');
        el.className = 'comment-box';
        const stars = "‚òÖ".repeat(r.rating) + "‚òÜ".repeat(5 - r.rating);
        el.innerHTML = `
            <div class="comment-user">
                <div class="user-avatar">${r.name.charAt(0)}</div>
                <div class="user-text">
                    <span class="u-name">${r.name} <span style="color:#FFD700;font-size:10px;">${stars}</span></span>
                    <p class="u-comment">${r.comment}</p>
                </div>
            </div>`;
        list.appendChild(el);
    });
}

function toggleReviewForm() {
    const form = document.getElementById('review-form');
    form.classList.toggle('active');
    if (form.classList.contains('active')) { setTimeout(() => { form.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 300); }
    document.querySelectorAll('.star-opt').forEach(s => {
        s.onclick = function() { currentReviewRating = this.getAttribute('data-v'); updateStars(currentReviewRating); }
    });
}

function updateStars(val) { document.querySelectorAll('.star-opt').forEach(s => { s.classList.toggle('selected', s.getAttribute('data-v') <= val); }); }

function submitReview() {
    const name = document.getElementById('rev-name').value;
    const msg = document.getElementById('rev-msg').value;
    const pName = document.getElementById('modal-title').textContent;
    if(!name || !msg || currentReviewRating == 0) { alert("Z…ôhm…ôt olmasa b√ºt√ºn xanalarƒ± doldurun."); return; }
    const newRev = { name: name, comment: msg, rating: currentReviewRating, product: pName };
    if(!reviewsCache[pName]) reviewsCache[pName] = [];
    reviewsCache[pName].unshift(newRev);
    renderReviews(reviewsCache[pName]);
    toggleReviewForm();
    
    // LOG: Written Review
    logUserAction("Review", pName, `${currentReviewRating} Stars`);

    fetch(SHEETS_ENDPOINT, {
        method: 'POST', mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: 'review', product: pName, name: name, comment: msg, rating: currentReviewRating })
    });
}

// --- GLOBAL DISCOUNT LOGIC ---
let globalDiscount = 4.00;      
const discountStep = 0.50;      
let secondsLeftInStep = 30;     
let isTimerActive = false;      
let globalTimerInterval = null;

function activateGlobalDiscount() {
    if (isTimerActive) return; 
    isTimerActive = true;
    document.getElementById('fear-bar-main').classList.remove('hidden');
    globalTimerInterval = setInterval(() => {
        secondsLeftInStep--;
        updateDiscountProgressUI();
        if (secondsLeftInStep <= 0) {
            secondsLeftInStep = 30; 
            if (globalDiscount > 0) {
                globalDiscount = Math.max(0, globalDiscount - discountStep);
                globalDiscount = Math.round(globalDiscount * 100) / 100;
                triggerDropEffect(); 
            } else { clearInterval(globalTimerInterval); }
        }
        updateDiscountTextUI();
    }, 1000);
}

function updateDiscountTextUI() {
    const formattedPrice = `-${globalDiscount.toFixed(2)} ‚Çº`;
    const gsAmount = document.getElementById('gs-amount');
    const msAmount = document.getElementById('modal-fear-amount');
    if(gsAmount) gsAmount.textContent = formattedPrice;
    if(msAmount) msAmount.textContent = formattedPrice;
}

function updateDiscountProgressUI() {
    const percent = (secondsLeftInStep / 30) * 100;
    const gsFill = document.getElementById('gs-timer-fill');
    const msFill = document.getElementById('modal-timer-fill');
    if(gsFill) gsFill.style.width = `${percent}%`;
    if(msFill) msFill.style.width = `${percent}%`;
}

function triggerDropEffect() {
    const els = [document.getElementById('gs-amount'), document.getElementById('modal-fear-amount')];
    els.forEach(el => { if(el) { el.classList.add('shake-it'); setTimeout(() => el.classList.remove('shake-it'), 500); } });
}

// --- ORDER NOTIFICATIONS ---
function startOrderNotifications() {
    if (state.orders.length === 0) return;
    setInterval(() => {
        const order = state.orders[Math.floor(Math.random() * state.orders.length)];
        const phone = order.phone || "555555555";
        const maskedPhone = `*******${phone.slice(-2)}`;
        const toast = document.getElementById('notif-toast');
        document.getElementById('notif-user').textContent = `${maskedPhone} n√∂mr…ôsi indic…ô aldƒ±:`;
        document.getElementById('notif-product').textContent = order.product;
        toast.classList.add('show');
        setTimeout(() => { toast.classList.remove('show'); }, 9000);
    }, 40000); 
}

// --- ALL PRODUCTS GRID ---
async function openAllProducts() {
  document.getElementById('all-products-view').classList.add('active');
  logUserAction('ViewAllProducts', 'Mall Tab'); // LOG

  if (state.products.length > 0) { renderGrid(); return; }
  const container = document.getElementById('all-products-grid');
  container.innerHTML = `<div style="grid-column: span 2; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 50px; color: #888;"><div style="font-size: 40px; margin-bottom: 10px; animation: pulseGlow 1.5s infinite;">ü™Ñ</div><p>M…ôhsullar y√ºkl…ônir...</p></div>`;

  try {
    const [prodRes, orderRes] = await Promise.all([ fetch(`${SHEETS_ENDPOINT}?action=getProducts`), fetch(`${SHEETS_ENDPOINT}?action=getOrders`) ]);
    const prodData = await prodRes.json();
    const orderData = await orderRes.json();

    let rawProducts = shuffleArray(prodData.products || []);
    state.products = rawProducts.map(p => {
        const randomDisc = Math.floor(Math.random() * (35 - 20 + 1)) + 20; 
        const oldPriceVal = (parseFloat(p.price) / (1 - (randomDisc / 100))).toFixed(0);
        const isStockLow = Math.random() < 0.3;
        const stockCount = isStockLow ? Math.floor(Math.random() * 5) + 1 : null;
        return { ...p, discountPercent: randomDisc, oldPrice: oldPriceVal, isLowStock: isStockLow, stockCount: stockCount };
    });
    state.orders = orderData.orders || [];
    applyBadges(state.products);
    startOrderNotifications();
    renderGrid();
  } catch (error) { console.error(error); container.innerHTML = '<div style="grid-column: span 2; text-align:center; padding:20px;">X…ôta: ƒ∞nternet …ôlaq…ôsini yoxlayƒ±n.</div>'; }
}
  
function renderGrid() {
  const container = document.getElementById('all-products-grid');
  container.innerHTML = '';
  state.products.slice(0, gridLimit).forEach(p => {
    const el = document.createElement('div');
    el.className = 'grid-item';
    el.onclick = () => {
        openModal(p, state.products, state.products.indexOf(p));
        logUserAction("GridClick", p.name); // LOG
    };
    
    let badge = "";
    if (p.isBestSeller) badge = `<div class="badge-bestseller" style="top:5px; left:5px; font-size:10px;">üèÜ Best</div>`;
    else if (p.isLowStock) badge = `<div class="badge-lowstock-fixed" style="bottom:5px; left:5px; font-size:10px;">‚ö†Ô∏è ${p.stockCount} qaldƒ±</div>`;

    el.innerHTML = `${badge}<img src="${fixImageLink(p.image)}" loading="lazy"><div class="grid-info"><div class="grid-title">${p.name}</div><div class="grid-price-box"><span class="grid-old-price">${p.oldPrice} AZN</span><span class="grid-new-price">${p.price} AZN <span style="color:#2ecc71; font-size:10px;">(-${p.discountPercent}%)</span></span></div></div>`;
    container.appendChild(el);
  });
  document.getElementById('load-more-btn').style.display = (gridLimit >= state.products.length) ? 'none' : 'block';
}
function loadMoreGrid() { 
    gridLimit += 6; 
    renderGrid(); 
    logUserAction('LoadMoreProducts'); 
}

// --- FAVORITES LOGIC (NEW) ---
function openFavorites() {
    document.getElementById('favorites-view').classList.add('active');
    renderFavorites();
    logUserAction('ViewFavorites');
}

function renderFavorites() {
    const container = document.getElementById('favorites-grid');
    const emptyMsg = document.getElementById('fav-empty-msg');
    const bulkBtn = document.getElementById('bulk-whatsapp-btn');
    
    container.innerHTML = '';

    if (state.likedProducts.length === 0) {
        emptyMsg.style.display = 'block';
        bulkBtn.style.display = 'none';
        return;
    }
    emptyMsg.style.display = 'none';
    bulkBtn.style.display = 'block';

    // Show newest first
    [...state.likedProducts].reverse().forEach((p, index) => {
        const originalIndex = state.likedProducts.length - 1 - index; // Calculate actual index for deletion
        
        const el = document.createElement('div');
        el.className = 'grid-item';
        
        // Remove button (The X icon)
        const removeBtn = document.createElement('div');
        removeBtn.className = 'fav-remove-btn';
        removeBtn.innerHTML = '‚úï';
        removeBtn.onclick = (e) => {
            e.stopPropagation();
            removeFromFavorites(originalIndex);
        };

        el.onclick = () => {
            openModal(p, state.likedProducts, originalIndex);
        };
        
        el.innerHTML = `
            <img src="${fixImageLink(p.image)}" loading="lazy">
            <div class="grid-info">
                <div class="grid-title">${p.name}</div>
                <div class="grid-price-box">
                    <span class="grid-new-price">${p.price} AZN</span>
                </div>
            </div>`;
        
        el.appendChild(removeBtn);
        container.appendChild(el);
    });
}

function removeFromFavorites(index) {
    if(confirm('Silm…ôk ist…ôdiyiniz…ô …ôminsiniz?')) {
        state.likedProducts.splice(index, 1);
        localStorage.setItem('brendimo_likes', JSON.stringify(state.likedProducts));
        renderFavorites();
    }
}

function clearFavorites() {
    if(state.likedProducts.length === 0) return;
    if(confirm('B√ºt√ºn siyahƒ±nƒ± t…ômizl…ôm…ôk ist…ôyirsiniz?')) {
        state.likedProducts = [];
        localStorage.removeItem('brendimo_likes');
        renderFavorites();
    }
}

function sendBulkWhatsApp() {
    if(state.likedProducts.length === 0) return;
    
    let total = 0;
    let message = "Salam Brendimo! üéÅ\n\nM…ôn a≈üaƒüƒ±dakƒ± m…ôhsullarƒ± b…ôy…ôndim v…ô hamƒ±sƒ±nƒ± sifari≈ü etm…ôk ist…ôyir…ôm:\n\n";
    
    state.likedProducts.forEach((p, i) => {
        const price = parseFloat(p.price);
        total += price;
        message += `${i+1}. *${p.name}* - ${p.price} AZN\n`;
    });
    
    message += `\n‚úÖ *C∆èM T∆èXMƒ∞Nƒ∞: ${total.toFixed(2)} AZN*\n`;
    message += `\nZ…ôhm…ôt olmasa sifari≈üi r…ôsmil…ô≈üdirin.`;
    
    logUserAction('Bulk_WhatsApp_Order', `Count: ${state.likedProducts.length}`, `Total: ${total}`);
    
    const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
}

// --- UTILS ---
function fixImageLink(url) {
  if (!url) return 'https://via.placeholder.com/300?text=No+Image';
  if (url.includes('drive.google.com') || url.includes('docs.google.com')) { const idMatch = url.match(/[-\w]{25,}/); if (idMatch) return `https://googleusercontent.com/profile/picture/0${idMatch[0]}`; }
  if (url.includes('github.com') && url.includes('/blob/')) { return url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/'); }
  return url;
}

function redirectToWhatsApp(p) {
  // LOG: Purchase Intent
  logUserAction('Buy_WhatsApp', p.name, `${p.price} AZN`);
  if(typeof fbq !== 'undefined') {
      fbq('track', 'Buy_WhatsApp', {
          content_name: p.name,
          value: p.price,
          currency: 'AZN'
      });
  }
  const finalPrice = Math.max(0, p.price - globalDiscount).toFixed(2);
  const discountVal = globalDiscount.toFixed(2);
  let priceText = `${p.price} AZN`;
  if (globalDiscount > 0) { priceText = `${p.price} AZN (Endiriml…ô: ${p.oldPrice} ‚Çº yox)\nüî• ∆èlav…ô Bonus Endirim: -${discountVal} AZN\n‚úÖ YEKUN: ${finalPrice} AZN`; }
  
  const text = `Salam Brendimo! üéÅ\n\nBu m…ôhsulu b…ôy…ôndim:\n*${p.name}*\n${priceText}\n\nLink:\n${fixImageLink(p.image)}\n\nSifari≈ü etm…ôk ist…ôyir…ôm.`;
  
  // --- THE FIX ---
  // 1. We remove the setTimeout (Instagram hates delays)
  // 2. We use window.location.href (Forces navigation in the same tab)
  const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`;
window.top.location.href = url; // Forces the main window to change
}

function initTracking() { logUserAction('AppOpen'); }

function restartApp() {
  if (globalTimerInterval) clearInterval(globalTimerInterval);
  isTimerActive = false;
  currentStep = 0;
  state.who = null; state.occasion = null; state.mood = null; state.style = null; state.budget = null; state.cardStack = [];
  closeModal(); closeAboutModal();
  document.getElementById('all-products-view').classList.remove('active');
  document.getElementById('favorites-view').classList.remove('active');
  logUserAction("Restart");
  updateUI();
}

function handleNavClick(tab) {
  // 1. Force close the product modal so we can see the pages!
  closeModal(); 

  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  document.getElementById(`nav-${tab}`).classList.add('active');
  
  logUserAction("NavClick", tab); 

  document.getElementById('all-products-view').classList.remove('active');
  document.getElementById('favorites-view').classList.remove('active');

  if (tab === 'wizard') {
    updateUI(); 
  } 
  else if (tab === 'mall') {
    openAllProducts();
    const closeBtn = document.getElementById('all-products-close');
    if(closeBtn) closeBtn.style.display = 'none';
  } 
  else if (tab === 'fav') {
      openFavorites();
  }
  else if (tab === 'chat') {
    window.open(`https://wa.me/${WHATSAPP_NUMBER}`, '_blank');
    setTimeout(() => { 
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); 
        // Reset visual state
        if(document.getElementById('all-products-view').classList.contains('active')) { 
            document.getElementById('nav-mall').classList.add('active'); 
        } else if (document.getElementById('favorites-view').classList.contains('active')) {
             document.getElementById('nav-fav').classList.add('active');
        } else { 
            document.getElementById('nav-wizard').classList.add('active'); 
        } 
    }, 500);
  } 
  else if (tab === 'wheel') {
    window.open('https://sehrbaz.com/vipaccount/', '_blank');
    setTimeout(() => { 
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); 
        document.getElementById('nav-wizard').classList.add('active'); 
    }, 500);
  }
}

const storiesData = [
  { id: 1, title: 'M√º≈üt…ôril…ôr', thumb: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?w=150&h=150&fit=crop', content: 'https://github.com/Brendimo-co/sehrbaz/blob/main/memnun.png?raw=true&fit=crop', type: 'story' },
  { id: 'about', title: 'Biz Kimik?', thumb: 'https://cdn-icons-png.flaticon.com/512/189/189664.png', type: 'action', action: openAboutModal },
  { id: 2, title: 'Qabla≈üdƒ±rma', thumb: 'https://images.unsplash.com/photo-1549465220-1a8b9238cd48?w=150&h=150&fit=crop', content: 'https://github.com/Brendimo-co/sehrbaz/blob/main/paket.png?raw=true&fit=crop', type: 'story' },
  { id: 3, title: 'Endiriml…ôr', thumb: 'https://images.unsplash.com/photo-1607082348824-0a96f2a4b9da?w=150&h=150&fit=crop', content: 'https://images.unsplash.com/photo-1607082348824-0a96f2a4b9da?w=600&h=1000&fit=crop', type: 'story' },
  { id: 4, title: '√áatdƒ±rƒ±lma', thumb: 'https://images.unsplash.com/photo-1616401784845-180882ba9ba8?w=150&h=150&fit=crop', content: 'https://github.com/Brendimo-co/sehrbaz/blob/main/catdirilma.png?raw=true&fit=crop', type: 'story' },
  { id: 5, title: 'Komanda', thumb: 'https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=150&h=150&fit=crop', content: 'https://images.unsplash.com/photo-1522071820081-009f0129c71c?w=600&h=1000&fit=crop', type: 'story' },
  { id: 6, title: 'Brendimo', thumb: 'https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=150&h=150&fit=crop', content: 'https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=600&h=1000&fit=crop', type: 'story' }
];

function initStories() {
  const container = document.getElementById('stories-container');
  container.innerHTML = '';
  storiesData.forEach((item, index) => {
    const el = document.createElement('div');
    el.className = 'story-item';
    el.setAttribute('data-type', item.type);
    el.onclick = () => handleStoryClick(index);
    el.innerHTML = `<div class="story-ring"><img src="${item.thumb}" alt="${item.title}"></div><span class="story-title">${item.title}</span>`;
    container.appendChild(el);
  });
}

function handleStoryClick(index) {
  const story = storiesData[index];
  if (story.type === 'action') story.action();
  else if (story.type === 'link') window.open(story.url, '_blank');
  else openStoryViewer(index);
  logUserAction("StoryView", story.title);
}

let activeStoryIndex = -1; let storyTimer = null; const STORY_DURATION = 5000;

function openStoryViewer(index) {
  activeStoryIndex = index;
  document.getElementById('story-viewer').classList.add('active');
  renderProgressBars();
  loadStoryContent(index);
}

function renderProgressBars() {
  const container = document.getElementById('story-progress-bars');
  container.innerHTML = '';
  const storyItems = storiesData.filter(s => s.type === 'story');
  storyItems.forEach((s) => {
    const bar = document.createElement('div');
    bar.className = 'story-progress-bar';
    bar.innerHTML = `<div class="story-progress-fill" id="prog-${s.id}"></div>`;
    container.appendChild(bar);
  });
}

function loadStoryContent(index) {
  const story = storiesData[index];
  if (!story || story.type !== 'story') { closeStory(); return; }
  document.getElementById('sv-image').src = story.content;
  document.getElementById('sv-name').textContent = story.title;
  document.getElementById('sv-avatar').src = story.thumb;
  resetBars(index);
  startProgressBar(story.id);
}

function startProgressBar(storyId) {
  if (storyTimer) clearInterval(storyTimer);
  const fill = document.getElementById(`prog-${storyId}`);
  if(!fill) return;
  fill.style.transition = 'none';
  fill.style.width = '0%';
  setTimeout(() => { fill.style.transition = `width ${STORY_DURATION}ms linear`; fill.style.width = '100%'; }, 50);
  storyTimer = setTimeout(() => { nextStory(); }, STORY_DURATION);
}

function resetBars(currentIndex) {
  const storyItems = storiesData.filter(s => s.type === 'story');
  const currentStoryObj = storiesData[currentIndex];
  const relativeIndex = storyItems.findIndex(s => s.id === currentStoryObj.id);
  storyItems.forEach((s, i) => {
    const fill = document.getElementById(`prog-${s.id}`);
    if (fill) { fill.style.transition = 'none'; if (i < relativeIndex) fill.style.width = '100%'; else fill.style.width = '0%'; }
  });
}

function nextStory() {
  let nextIndex = activeStoryIndex + 1;
  while (nextIndex < storiesData.length && storiesData[nextIndex].type !== 'story') { nextIndex++; }
  if (nextIndex < storiesData.length) { loadStoryContent(nextIndex); activeStoryIndex = nextIndex; } else { closeStory(); }
}

function prevStory() {
  let prevIndex = activeStoryIndex - 1;
  while (prevIndex >= 0 && storiesData[prevIndex].type !== 'story') { prevIndex--; }
  if (prevIndex >= 0 && storiesData[prevIndex].type === 'story') { loadStoryContent(prevIndex); activeStoryIndex = prevIndex; } 
  else { loadStoryContent(activeStoryIndex); }
}

function closeStory() {
  document.getElementById('story-viewer').classList.remove('active');
  if (storyTimer) clearInterval(storyTimer);
}

function openAboutModal() { document.getElementById('about-modal').classList.add('active'); logUserAction("AboutModal"); }
function closeAboutModal() { document.getElementById('about-modal').classList.remove('active'); }

// --- PAGE VISIBILITY HANDLER (Prevents freezing) ---
document.addEventListener("visibilitychange", () => {
  if (document.hidden) {
    // User switched tabs or went to WhatsApp -> PAUSE TIMERS
    if (globalTimerInterval) {
        clearInterval(globalTimerInterval);
        globalTimerInterval = null;
    }
    // Note: We don't pause order notifications to keep the "feeling" alive, 
    // but the discount timer is heavy, so we pause it.
  } else {
    // User came back -> RESUME TIMERS
    if (document.getElementById('fear-bar-main') && !document.getElementById('fear-bar-main').classList.contains('hidden')) {
        // Only restart if the bar was actually active
        if (!globalTimerInterval && typeof activateGlobalDiscount === "function") {
             // We restart the interval logic manually or just let it resume
             // Simpler approach for your specific code:
             isTimerActive = false; // Reset flag
             activateGlobalDiscount(); // Restart the function
        }
    }
  }
});
  // --- NEW PROMO LOGIC ---
let interactionCount = 0; // Tracks swipes and views

// 1. Draggable Logic for Bubble
function initBubbleDrag() {
    const bubble = document.getElementById('promo-bubble');
    let isDragging = false;
    let startX, startY, initialLeft, initialTop;

    bubble.addEventListener('touchstart', (e) => {
        isDragging = true;
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        const rect = bubble.getBoundingClientRect();
        // We set fixed positions to allow movement
        bubble.style.right = 'auto'; 
        bubble.style.bottom = 'auto';
        bubble.style.left = rect.left + 'px';
        bubble.style.top = rect.top + 'px';
        bubble.style.animation = 'none'; // Stop floating while dragging
    }, {passive: false});

    document.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        e.preventDefault(); // Prevent scrolling while dragging bubble
        const currentX = e.touches[0].clientX;
        const currentY = e.touches[0].clientY;
        const dx = currentX - startX;
        const dy = currentY - startY;
        
        bubble.style.left = (parseFloat(bubble.style.left) + dx) + 'px';
        bubble.style.top = (parseFloat(bubble.style.top) + dy) + 'px';
        
        startX = currentX;
        startY = currentY;
    }, {passive: false});

    document.addEventListener('touchend', () => {
        isDragging = false;
        bubble.style.animation = 'floatBubble 3s ease-in-out infinite';
    });
}

function closeBubble() {
    document.getElementById('promo-bubble').style.display = 'none';
    logUserAction('BubbleClosed');
}

// 2. Popup Helpers
function showCustomPopup(id) {
    document.getElementById(id).classList.add('active');
    logUserAction('PopupShown', id);
}
function closeCustomPopup(id) {
    document.getElementById(id).classList.remove('active');
}

// 3. Interaction Tracker
function trackInteraction() {
    interactionCount++;
    // Trigger "Free Delivery" popup on 5th interaction
    if (interactionCount === 5) {
        showCustomPopup('popup-delivery');
    }
}
init();
  // Add this to the end of your script
document.addEventListener('DOMContentLoaded', function() {
    // Force re-initialization when the DOM is ready
    init(); 
    
    // Fix for Instagram: Manually attach click events to critical buttons
    // instead of relying on HTML onclick
    const logo = document.querySelector('.logo');
    if(logo) logo.addEventListener('click', restartApp);
    
    const backBtn = document.querySelector('.back-btn');
    if(backBtn) backBtn.addEventListener('click', goBack);
});
</script>
</body>
</html>
